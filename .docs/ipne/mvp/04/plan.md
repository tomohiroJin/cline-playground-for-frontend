# IPNE MVP4 実装計画（計画駆動）

## 概要

MVP3（成長・職業差・罠拡張）の次段階として、
**仕上げ・演出・リプレイ価値** を実装する。
MVP4の目的は「ゲームをプレイし続けられる完成形に寄せる」ことである。

TDDを前提に、**先にテスト → 最小実装 → 確認** を繰り返す。

---

## MVP4の本質

> **MVP4は新規システム追加のフェーズではない。**
> **分かりやすさ・気持ちよさ・再挑戦動機・安定運用** を優先するフェーズである。

技術的な実装完了ではなく、以下の体験が生まれているかが成功基準となる：

- 初見でルールが理解できる（迷わない）
- 1プレイ5〜10分で安定（極端な事故が減る）
- リトライ動機が生まれる（タイム/評価/差分）
- 演出が最小コストで"気持ちよさ"に寄与
- クラッシュ/ハマり/理不尽が体感上ほぼ無い

---

## 現状把握（MVP3からの継承）

- ページ構成: `src/pages/IpnePage.tsx`（タイトル→職業選択→プロローグ→ゲーム→クリア/ゲームオーバー）
- ロジック分離: `src/features/ipne/`
- 操作: WASD/矢印キー + モバイルD-pad（連続移動対応）+ スペース/攻撃ボタン
- 描画: Canvas ベース（ビューポート/カメラシステム）
- テスト: Jest + React Testing Library
- 迷路: BSPアルゴリズムによる自動生成（80x80タイル）
- マップ: 自動マッピング機能（小窓/全画面切替）
- 職業: 戦士/盗賊（情報可視性差＋初期能力差）
- 成長: 撃破数によるLv1→10、5択（攻撃力/距離/速度/攻撃速度/回復量）
- 敵: 4種+ボス（パトロール/チャージ/レンジド/スペシメン）
- 罠: 3種（ダメージ/スロー/テレポート）、再使用＋クールダウン
- 特殊壁: 破壊/すり抜け/透明（破壊可能壁は攻撃で破壊可能）
- アイテム: 回復2種＋全回復/レベルアップ/マップ公開

### MVP4での変更方針

- **既存のMVP3コードを拡張・改修**（新規ページ追加ではない）
- タイマーシステム追加: timer.ts
- 記録システム追加: record.ts
- チュートリアル追加: tutorial.ts
- フィードバック追加: feedback.ts
- エンディング分岐追加: ending.ts
- 既存モジュール変更: mazeGenerator.ts, enemy.ts, IpnePage.tsx

---

## MVP4で新たに必要な要素

### 1. タイマーシステム（timer.ts 新規）

- 計測開始：操作可能になった瞬間
- 計測停止：ゴール到達 または HP<=0
- 一時停止：レベルアップUI表示中
- 表示形式：mm:ss.ms

### 2. 記録システム（record.ts 新規）

- クリアタイム計測
- 職業別ベスト記録（localStorage保存）
- リザルト画面拡張（タイム/Lv/撃破数/職業表示）
- 保存失敗時は黙って無効化（ゲーム進行を妨げない）

### 3. チュートリアル（tutorial.ts 新規）

- 1回目のみ表示（任意OFF可）
- ステップ：移動→攻撃→マップ切替→罠再使用
- localStorage で完了フラグ保存

### 4. フィードバック（feedback.ts 新規）

- 被弾：画面赤フラッシュ（100ms）+ SE
- 罠発動：足元エフェクト + 種類別SE
- レベルアップ：通知ポップ + ファンファーレSE
- アイテム取得：小さなポップ + 取得SE

### 5. エンディング分岐（ending.ts 新規）

- クリアタイムによる5段階評価（S/A/B/C/D）
  - S: 0〜2分（迷宮の支配者）
  - A: 2〜3分（熟練の生還者）
  - B: 3〜5分（堅実な踏破者）
  - C: 5〜8分（辛勝の脱出者）
  - D: 8分以上（瀕死の帰還者）
- エピローグ文面の分岐（ダークファンタジー調）
- ゲームオーバー文面追加（新たな標本）
- Sランク特別動画の実装準備（迷宮崩壊シーン）

### 6. SPECIMEN価値付け（enemy.ts 変更）

- 倒すと30%確率で回復小ドロップ

### 7. 生成安定化（mazeGenerator.ts 変更）

- スタート半径3タイル以内にボス・チャージ・ダメージ罠が存在しないことを検証
- 違反時は再生成（最大5回）

### 8. ヘルプUI（IpnePage.tsx 変更）

- Entity Guide の要約版
- 操作説明（PC/モバイル）

---

## フェーズ構成

### フェーズ0: 型定義・テスト準備（TDD起点）

- types.ts に新規型定義を追加（タイマー、記録、チュートリアル、エンディング）
- テストユーティリティの更新
- 既存テストが通ることを確認

### フェーズ1: タイマーシステム

- timer.ts 新規作成（計測・一時停止・リセット）
- 表示形式の整形関数
- IpnePage.tsx でのタイマー表示

### フェーズ2: 記録・リザルト

- record.ts 新規作成（ベスト記録管理）
- localStorage 保存・読み込み
- リザルト画面拡張

### フェーズ3: チュートリアル

- tutorial.ts 新規作成（ステップ管理）
- チュートリアルUI実装
- 完了フラグ管理

### フェーズ4: フィードバック（SE/エフェクト）

- feedback.ts 新規作成
- 各種エフェクト実装（被弾/罠/レベルアップ/取得）
- SE再生処理（プレースホルダー）

### フェーズ5: エンディング分岐

- ending.ts 新規作成（評価計算）
- エピローグテキスト分岐
- リザルト画面での評価表示

### フェーズ6: SPECIMEN価値付け

- enemy.ts 変更（ドロップ処理追加）
- ドロップアイテム生成

### フェーズ7: 生成安定化

- mazeGenerator.ts 変更（生成検証追加）
- 再生成ロジック実装
- 検証テスト追加

### フェーズ8: ヘルプ・操作説明UI

- ヘルプ画面コンポーネント追加
- Entity Guide 要約版作成
- 操作説明（PC/モバイル対応）

### フェーズ9: UI・演出統合

- 全機能のIpnePage.tsx統合
- タイマー/ステータス表示調整
- チュートリアル/ヘルプUI統合

### フェーズ10: バランス調整・検証

- プレイテスト
- パラメータ微調整
- 最終検証

---

## 重要方針

- **既存のMVP3コードを拡張・改修**（新規ページ追加ではない）
- 変更はMVP4範囲に限定（新職業・新敵・新スキル等は入れない）
- 演出は最小コストで最大効果を狙う
- **TDD優先**: 先にテスト → 実装 → リファクタ
- **DRY原則**: 共通ロジックは関数として抽出
- **SOLID原則**: 各モジュールは単一責任を持つ

---

## 完了条件

- [ ] クリアタイムが計測・表示される
- [ ] ベスト記録が保存される
- [ ] チュートリアルが初回のみ表示される
- [ ] 被弾/罠発動時にフィードバックがある
- [ ] エンディングがタイムで5段階分岐する（S/A/B/C/D）
- [ ] SPECIMENを倒すメリットがある
- [ ] 生成の理不尽が軽減される
- [ ] ヘルプ/操作説明が確認できる
- [ ] プレイ時間が5〜10分に収まる
- [ ] テストが追加され `npm test` が通る

---

## MVP4 → MVP5 への判断基準

以下を満たしたら MVP5（アート差し替え・UI最終デザイン・配信準備）に進む。

- 初見でルールが理解できる
- リトライ動機が生まれる
- 極端な事故が減る
- 演出が気持ちよさに寄与している
- クラッシュ/ハマりがほぼ無い
