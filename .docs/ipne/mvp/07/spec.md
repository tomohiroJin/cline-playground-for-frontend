# MVP07 仕様書: IPNE リファクタリング基盤再設計

## 概要

MVP07は機能追加を目的とせず、既存ゲーム体験を維持したまま内部設計を改善する。
適用対象は SOLID / DRY / DbC / 関数型設計 / ディレクトリ構成。

---

## 対象範囲

- 対象:
  - `src/pages/IpnePage.tsx`
  - `src/features/ipne/**`
- 非対象:
  - 新職業・新敵・新ステージなどの機能追加
  - UIデザイン刷新
  - バランスパラメータの大幅変更

---

## 要件定義

## 1. SOLID要件

### SRP
- `IpnePage` から以下を分離すること:
  - 入力制御
  - ゲーム進行更新
  - Canvas描画
  - 副作用実行（SE/BGM/保存）

### OCP
- 敵AIの追加時に既存分岐の編集を最小化できる構造を採用すること。
- 敵タイプごとのロジックを独立モジュール化すること。

### DIP
- 乱数・時刻・永続化を抽象化し、注入可能にすること。
- `window` / `URLSearchParams` / `localStorage` の直接参照をアダプタ層へ隔離すること。

受け入れ条件:
- `IpnePage` 直下の関数群から、ドメイン判断ロジックが大幅に削減される。
- AIロジックにレジストリまたはポリシー層が存在する。
- ブラウザ依存APIを呼ぶモジュールが `infrastructure` に限定される。

---

## 2. DRY要件

- 次の重複ロジックを統合すること:
  - プレイヤーダメージ適用
  - ノックバック適用
  - アイテム取得時の派生効果判定
  - SEトリガー条件判定
- `setState + ref.current` の二重同期パターンを統合すること。
- 複数ファイルにある `shuffle` 実装を共通化すること。

受け入れ条件:
- 同一ルールを実装する条件分岐が単一ユースケースへ集約される。
- 重複ユーティリティが `shared/utils` に集約される。
- 状態更新の責務が単一ストア/リデューサに集約される。

---

## 3. DbC要件

- 重要な境界関数に前提条件を導入すること:
  - 配置設定（比率・個数）
  - 座標範囲
  - 状態遷移
- 事後条件を導入すること:
  - 配置結果の件数・重複なし
  - レベル上限・HP範囲
- 契約違反時は例外または明示エラーを返すこと。

受け入れ条件:
- 契約テストが追加される。
- 契約未満入力で失敗し、妥当入力で成功する。

---

## 4. 関数型要件

- ゲーム更新ロジックを「純粋関数 + 副作用命令」に分離すること。
- `tick` 相当の関数は入力引数のみで次状態を返し、直接副作用を実行しないこと。
- 副作用（音・ストレージ・タイマー操作）は `effects` を経由して実行すること。
- 入力処理・描画処理は `tick` から分離し、`tick` はUI非依存であること。

受け入れ条件:
- 純粋関数単体テストで主要シナリオが検証できる。
- 副作用はUI層/実行層に限定される。

---

## 5. ディレクトリ構成要件

以下の構成へ段階移行する:

```text
src/features/ipne/
  application/
  domain/
  infrastructure/
  presentation/
  shared/
```

受け入れ条件:
- 新規コードは上記配下へ配置される。
- 既存 import を壊さないよう `index.ts` を Facade として維持する。

---

## テスト要件

- 既存テストは全通過。
- 追加テスト:
  - 契約テスト
  - ゲームtick純粋関数テスト
  - AIポリシー単体テスト
  - 既存挙動の回帰テスト
  - ゲームループ回帰テスト（接触/罠/鍵/クリア/死亡）
  - インフラアダプタのモック差し替えテスト（clock/random/storage）

---

## 成果物

- 構造化された `ipne` モジュール群
- 互換性を保つ Facade エクスポート
- 契約チェックライブラリ
- 純粋関数化されたゲーム更新ユースケース
- 回帰を担保するテスト群

---

## 成功指標

- 機能回帰なし（現行仕様を維持）
- 可読性・責務分離の改善
- 変更影響範囲の縮小
- テストの記述容易性向上
