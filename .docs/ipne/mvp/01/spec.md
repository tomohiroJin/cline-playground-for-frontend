# 仕様・要件定義（IPNE MVP1）

## 1. 目的

`.docs/ipne/specs/mvp_1_：自動生成迷路＋調査体験.md` をベースに、
**MVP1（自動生成迷路＋調査体験）** を現行プロダクトへ追加する。

- 「迷路を探索する面白さ」を検証する
- マップを見る行動が自然に発生するか確認する
- 1プレイ1、2分程度の体験を実現する

### MVP1の本質

> MVP1は「迷路生成ができたか」ではない。
> **プレイヤーが自分で把握しようとするか** を検証するフェーズである。

---

## 2. ゲーム概要（MVP1）

### 2.1 コンセプト

自動生成された迷路を探索し、マップを活用しながらゴールを目指す
**調査体験プロトタイプ**。

### 2.2 プレイ時間

- 1プレイ：1、2分程度

### 2.3 MVP0との違い

| 項目 | MVP0 | MVP1 |
|------|------|------|
| 迷路 | 固定 | 自動生成 |
| マップ | なし | 自動マッピング |
| プレイ時間 | 2〜3分 | 1、2分程度 |
| 迷い | 最小 | 意図的に発生 |

---

## 3. 画面構成

1. **タイトル画面**
2. **プロローグ画面**（開始直後1回）
3. **ゲーム画面**（+ マップオーバーレイ）
4. **クリア画面**

※ MVP0と同一構成、マップオーバーレイが追加

---

## 4. ゲームルール（MVP1）

- プレイヤーは自動生成された迷路内を自由に移動できる
- 壁に当たると停止（通過不可）
- ゴールに接触するとクリア
- 通過したエリアは自動的にマップに記録される
- 敵・罠・HP・レベルアップは無し

---

## 5. 操作仕様

### 5.1 移動操作

#### PC

- 移動：WASD または 矢印キー
- **連続移動**：キー押し続けで自動的に移動を繰り返す
  - 初回遅延: 150ms（キーリピート開始までの待機）
  - 移動間隔: 100ms（秒速10マス）
  - 壁に当たると停止

#### モバイル

- 画面下部のD-padタップで移動方向を決定
- **連続移動**：D-pad押し続けで自動的に移動を繰り返す
  - 初回遅延: 150ms（キーリピート開始までの待機）
  - 移動間隔: 100ms（秒速10マス）
  - 壁に当たると停止
  - ボタンから指を離すと停止（`onPointerUp`/`onPointerLeave`/`onPointerCancel`で対応）

#### 微調整許容範囲

- 移動速度の調整は可（DEFAULT_MOVEMENT_CONFIGで設定）
- 当たり判定の微調整は可

### 5.2 マップ操作

- PC：`M` キーでマップ表示切替（小窓 → 全画面 → 非表示）
- モバイル：画面上部のマップアイコンタップで切替

### 5.3 デバッグ操作（開発用）

- URLパラメータ `/ipne?debug=1` でデバッグモード有効化
- `Shift+D` キー：デバッグパネル表示切替
- `Shift+F` キー：迷路全体表示切替
- `Shift+C` キー：座標表示切替
- `Shift+P` キー：最短経路表示切替

> 詳細は `.docs/ipne/debug-mode.md` を参照

---

## 6. ビューポート/カメラ仕様

### 6.1 基本方針

**メイン画面では迷路全体を表示しない。プレイヤー周辺のみを表示する。**

これにより:
- ゴール位置が最初から見えない（探索の意味がある）
- プレイヤーキャラが十分なサイズで表示される
- 迷路を探索している感覚が生まれる

### 6.2 ビューポート設定

| 項目 | 値 |
|------|-----|
| 表示タイル数（横） | 15タイル |
| 表示タイル数（縦） | 11タイル |
| タイルサイズ | 48px（固定） |
| Canvas解像度 | 720x528px |

> Phase 6で調整: 視界を狭くして探索感を増し、プレイヤーを見やすくするためタイルサイズを拡大

### 6.3 カメラ動作

- プレイヤーを画面中央に配置
- マップ端ではビューポートがクランプ（画面外を表示しない）
- プレイヤー移動に追従してスムーズにスクロール

---

## 7. 自動生成迷路仕様

### 7.1 基本構造

- **タイルベース**（正方形グリッド）
- **部屋＋通路構成**
  - 部屋：6x6〜10x10程度の空間（将来の敵・罠配置を考慮）
  - 通路：幅3〜4タイル（戦闘・回避の余地を確保）
- 必ずスタートからゴールまで到達可能

👉 MVP2以降で敵・罠を配置するため、広めの空間を確保する

### 7.2 生成アルゴリズム要件

- BSP（Binary Space Partitioning）または類似手法
- 部屋数：8〜32程度（maxDepth=5）
- ループ：2箇所（探索の幅を確保）
- 適度な分岐を持つ構造

### 7.3 サイズ目安

- グリッドサイズ：70x70タイル
- ビューポート：25x18タイル表示
- 1〜2分程度で探索完了する規模

👉 プレイヤーにはビューポート分のみ見えるため、迷路全体は把握できない

### 7.4 制約

- 袋小路は許容（適度な迷い）
- 完全な一本道は NG（探索感がない）
- 広すぎる空間は NG（ダレる）

---

## 8. スタート／ゴール配置仕様

### 8.1 スタート位置

- 迷路の外周付近に配置
- 部屋の中に配置（通路上ではない）

### 8.2 ゴール位置

- スタートから**最も遠い地点**に配置
- 距離計算：BFSによる経路長
- 視覚的に識別可能（色・形で区別）
- **ビューポート外に配置されるため、最初は見えない**

---

## 9. 自動マッピング仕様

### 9.1 表示ルール

**重要：マップは「線のみ」で構成する。壁は表示しない。**

| エリア | 表示 |
|--------|------|
| 未探索 | 非表示（黒/透明） |
| 通過済み通路 | 線で表示（細線） |
| 通過済み部屋 | 線で輪郭表示（塗りつぶしなし） |
| 壁 | **表示しない** |
| 現在位置 | マーカー表示 |
| ゴール位置 | 発見後のみ表示 |

👉 マップは「調査ログ」であり、完全な地図ではない。
通った場所だけが線として残るイメージ。

### 9.2 探索判定

- プレイヤーが通過したタイルを「探索済み」とする
- 探索済みタイルの隣接タイルは「見える」状態に

### 9.3 描画仕様

- マップは**半透明オーバーレイ**でゲーム画面に重ねる
- 不透明度：50〜70%
- 背景色：暗いグレー or 黒
- 線色：淡い青 or くすんだ緑（ビジュアル仕様準拠）

### 9.4 表示位置

- **常時表示モード**：画面右上に小窓（200x200px）
  - D-padコントローラーと重ならない位置
  - プレイヤーマーカーは最小4px以上で視認可能に
- **全画面モード**：画面中央に大きく表示（80%）

### 9.5 表示切替

- 3段階サイクル：小窓 → 全画面 → 非表示 → 小窓
- PC: `M` キー
- モバイル: マップアイコンタップ

---

## 10. ビジュアル仕様（抽象ファンタジー遺跡準拠）

### 10.1 カラーパレット

| 要素 | 色 |
|------|-----|
| 床 | 鈍いブラウン / 暗いグレー |
| 壁 | 黒に近い青 / 濃いグレー |
| 通路 | 床と同系色 |
| ゴール | 淡い青（アクセント） |
| プレイヤー | くすんだ緑（アクセント） |

### 10.2 描画指針

- 単色・簡易テクスチャで可
- 模様は省略
- 立体感は影だけで表現
- 装飾は行わない

---

## 11. 技術/アーキテクチャ要件

### 11.1 ファイル構成

**既存の `ipne-mvp0` を `ipne` にリネームして拡張する。**

```
src/
├── pages/
│   ├── IpnePage.tsx           # 旧 IpneMvp0Page.tsx
│   ├── IpnePage.styles.ts     # 旧 IpneMvp0Page.styles.ts
│   └── IpnePage.test.tsx      # 旧 IpneMvp0Page.test.tsx
├── features/
│   └── ipne/                  # 旧 ipne-mvp0/
│       ├── index.ts
│       ├── mazeGenerator.ts      # 迷路生成（BSP）
│       ├── mazeGenerator.test.ts
│       ├── pathfinder.ts         # 経路探索・距離計算
│       ├── pathfinder.test.ts
│       ├── autoMapping.ts        # 自動マッピング
│       ├── autoMapping.test.ts
│       ├── viewport.ts           # ビューポート/カメラ計算
│       ├── viewport.test.ts
│       ├── movement.ts           # 連続移動機能
│       ├── movement.test.ts
│       ├── debug.ts              # デバッグモード
│       ├── debug.test.ts
│       ├── player.ts             # プレイヤーロジック
│       ├── player.test.ts
│       └── types.ts              # 型定義
.docs/
└── ipne/
    └── debug-mode.md             # デバッグモードドキュメント
```

### 11.2 コーディング規約

- `any` 不使用
- `null` 不使用
- `as const` と Union 型で定数管理
- 純粋ロジックは `src/features/ipne/` に分離（TDD対象）

### 11.3 MVP0からの変更方針

- **既存のMVP0コードを直接拡張・改修**（新規ページ追加ではない）
- `ipne-mvp0` → `ipne` にリネーム（MVP番号を含まない汎用名）
- ルートも `/ipne-mvp0` → `/ipne` に変更
- GameListのカードはそのまま使用（リンク先のみ更新）
- gitで履歴管理されているため、MVP段階ごとの別ページ保持は不要

---

## 12. デバッグモード仕様

### 12.1 有効化方法

- URLパラメータ: `/ipne?debug=1`
- 通常プレイには影響しない（パラメータなしでは無効）

### 12.2 デバッグ機能

| 機能 | 操作 | 説明 |
|------|------|------|
| デバッグパネル | `Shift+D` キー | パネル表示切替 |
| 迷路全体表示 | `Shift+F` キー | ビューポート無視で全体表示 |
| 座標表示 | `Shift+C` キー | プレイヤー座標をオーバーレイ |
| パス表示 | `Shift+P` キー | スタート→ゴール最短経路を表示 |

> Shiftキーとの組み合わせにより、移動キー（WASD）と競合しない

### 12.3 用途

- 迷路生成の確認
- バグ調査
- パラメータ調整時の確認

### 12.4 ドキュメント

詳細は `.docs/ipne/debug-mode.md` を参照

---

## 13. テスト要件（TDD）

### 13.1 迷路生成テスト

- 指定サイズの迷路が生成される
- 部屋が規定数存在する
- スタートからゴールまで到達可能
- ループ数が制限内

### 13.2 スタート/ゴール配置テスト

- スタートが外周付近に配置される
- ゴールがスタートから最遠地点に配置される

### 13.3 自動マッピングテスト

- 未探索エリアが非表示
- 通過済みエリアが表示される
- 探索状態が正しく更新される
- ミニマップがD-padと重ならない位置に表示

### 13.4 ビューポートテスト

- プレイヤー中心にビューポートが計算される
- マップ端でビューポートがクランプされる
- プレイヤーがビューポート内に収まる

### 13.5 UI統合テスト

- `IpnePage` が描画される
- マップオーバーレイが表示/非表示切替できる
- ルート `/ipne` でアクセスできること
- プレイヤーキャラが視認可能なサイズで表示される

---

## 14. 受け入れ基準

- [x] `/ipne` でゲームが開始できる
- [x] 毎回異なる迷路が生成される
- [x] タイトル → プロローグ → ゲーム → クリア のE2Eが成立
- [x] キーボード/タップでスムーズに移動できる
- [x] 壁は通過できない
- [x] ゴール接触でクリア画面に遷移する
- [x] マップが自動的に更新される
- [x] マップ表示切替が動作する（小窓 → 全画面 → 非表示）
- [ ] 1プレイ1〜2分程度で完結する（要手動検証）
- [x] テストが追加され `npm test` が通る
  > ✅ 11テストスイート（ipne関連）、89テスト全てパス
- [x] **メイン画面でプレイヤー周辺のみ表示される（迷路全体は見えない）**
- [x] **プレイヤーキャラクターが明確に視認できる（48pxタイル）**
- [x] **ミニマップがD-padと重ならない**
- [x] **`/ipne?debug=1` でデバッグモードが有効になる**
- [x] **キー押し続けで連続移動できる**
- [x] **D-pad押し続けで連続移動できる（モバイル）**
- [x] **CanvasとD-padの距離が適切になっている**

---

## 15. 実装しない要素（明確化）

MVP1では以下は **実装しない**。

- 敵
- HP
- ダメージ
- レベルアップ
- 職業差
- 罠
- 特殊壁（破壊可能壁・透明壁等）
- アイテム
- タイム評価

---

## 16. 評価観点（MVP1完了後）

以下を必ず確認する。

- マップを何回開いたか
- ゴールまで直進できたか
- 迷って引き返す行動があったか
- 一本道に感じたか／迷路に感じたか

### NG例

- 迷路が広すぎてダレる → サイズ縮小
- 一本道すぎて迷わない → ループ追加/構造変更
- マップを見なくてもクリアできる → 複雑化
