# IPNE MVP3 実装計画（計画駆動）

## 概要

MVP2（敵・HP・最低限の戦闘）の次段階として、
**成長システム・職業差・罠拡張** を実装する。
MVP3の目的は「判断が重なり合う状態を作る」ことである。

TDDを前提に、**先にテスト → 最小実装 → 確認** を繰り返す。

---

## MVP3の本質

> **MVP3は「強くなって爽快に敵を倒す」フェーズではない。**
> **判断が重なり合う状態を作る** フェーズである。

技術的な実装完了ではなく、以下の体験が生まれているかが成功基準となる：

- レベルアップ時に「どの能力を上げるべきか」と悩む
- 職業によって「見えるもの・見えないもの」が異なり、攻略法が変わる
- 罠を見て「避けるか、利用するか」と判断する
- 成長方針と現状のリソースを考慮した立ち回りが発生する
- 繰り返しプレイする意味（異なる職業・異なる成長方針）がある

---

## 現状把握（MVP2からの継承）

- ページ構成: `src/pages/IpnePage.tsx`（タイトル→プロローグ→ゲーム→クリア/ゲームオーバー）
- ロジック分離: `src/features/ipne/`
- 操作: WASD/矢印キー + モバイルD-pad（連続移動対応）+ スペース/攻撃ボタン
- 描画: Canvas ベース（ビューポート/カメラシステム）
- テスト: Jest + React Testing Library
- 迷路: BSPアルゴリズムによる自動生成（80x80タイル）
- マップ: 自動マッピング機能（小窓/全画面切替）
- 敵: 3種類（巡回型・突進型・逃走型）+ ボス
- 戦闘: ワンボタン攻撃、接触ダメージ、ノックバック
- アイテム: 回復アイテム（小・大）

### MVP3での変更方針

- **既存のMVP2コードを拡張・改修**（新規ページ追加ではない）
- Player型を拡張して職業・レベル・撃破数・能力値を追加（experience は削除し killCount で統合）
- 新規モジュール追加: progression.ts, class.ts, trap.ts, wall.ts
- 既存モジュール変更: enemy.ts, enemyAI.ts, item.ts, collision.ts, autoMapping.ts, mazeGenerator.ts
- IpnePage.tsxに職業選択画面・レベルアップUIを追加

---

## MVP3で新たに必要な要素

### 1. 成長システム（progression.ts 新規）

- 最大レベル: 10
- 敵撃破で撃破数をカウント（経験値表示なし）
- 撃破数蓄積でレベルアップ
- レベルアップ時に5択選択（攻撃力/攻撃距離/移動速度/攻撃速度/回復量）
- 選択した能力が即座に反映

#### 撃破数テーブル

| レベルアップ | 必要撃破数 | 累計撃破数 |
|-------------|-----------|-----------|
| 1 → 2 | 1 | 1 |
| 2 → 3 | 2 | 3 |
| 3 → 4 | 2 | 5 |
| 4 → 5 | 2 | 7 |
| 5 → 6 | 3 | 10 |
| 6 → 7 | 3 | 13 |
| 7 → 8 | 4 | 17 |
| 8 → 9 | 4 | 21 |
| 9 → 10 | 4 | 25 |

※ 敵24体 + ボス1体で合計25体。レベル9(累計21)は通常敵のみで到達可能、レベル10(累計25)はボス込みで達成可能。

#### レベルアップ選択肢（5択）

| 選択 | 効果 | 上限 |
|------|------|------|
| 攻撃力強化 | attackPower +1 | なし |
| 攻撃距離強化 | attackRange +1 | 3 |
| 移動速度強化 | moveSpeed +1 | 8 |
| 攻撃速度強化 | attackSpeed -0.1 | 0.5 |
| 回復量強化 | healBonus +1 | +5 |

### 2. 職業システム（class.ts 新規）

- **戦士（Warrior）**: 罠・特殊壁は触れるか攻撃した時に初めて判明
- **盗賊（Thief）**: 罠・特殊壁が常時うっすら見える（透明度表示）

職業差は「情報取得能力」と「初期能力値」の差として表現。

#### 職業別初期能力値

| 能力 | 戦士 | 盗賊 | 説明 |
|------|------|------|------|
| attackPower | 2 | 1 | 1撃のダメージ量 |
| attackRange | 1 | 1 | 攻撃の届く距離（タイル） |
| moveSpeed | 4 | 6 | 移動速度（タイル/秒） |
| attackSpeed | 1.0 | 1.0 | クールダウン倍率 |
| healBonus | 0 | 0 | 回復アイテムの追加回復量 |

- 戦士: 攻撃力が高く、ぶつかって進むプレイスタイル
- 盗賊: 移動速度が高く、避けて進むプレイスタイル

### 3. 罠システム（trap.ts 新規）

- **ダメージ床**: 踏むとHP減少
- **移動妨害床**: 踏むと一定時間移動速度低下
- **索敵反応罠**: 踏むと周囲の敵を引き寄せる

罠は「避けるべき障害」ではなく「判断・利用の対象」として設計。

### 4. 壁ギミック拡張（wall.ts 新規）

- **通常壁**: 通過不可、攻撃不可
- **破壊可能壁**: 攻撃で破壊可能（ショートカット作成）
- **すり抜け可能壁**: 見た目は壁だが通過可能（隠し通路）
- **透明壁**: 見えないが通過不可（意外性）

### 5. 敵AI拡張（enemyAI.ts 変更）

- **RANGED（遠距離型）**: 一定距離を保ち遠距離から攻撃、接近されると後退
- **FLEE → SPECIMEN（標本型）**: 逃走型を名称変更、攻撃せず逃げる（捕獲対象としての価値）

### 6. アイテム拡張（item.ts 変更）

- **HP全回復**（3個）: HPを最大まで回復
- **即レベルアップ**（5個）: 経験値を無視して即座にレベルアップ（選択UIを表示）
- **地図**（1個）: 全マップを探索済み状態にする

---

## フェーズ構成

### フェーズ0: 型定義・テスト準備（TDD起点）

- types.ts に新規型定義を追加（職業、成長、罠、壁、敵拡張、アイテム拡張）
- テストユーティリティの更新
- 既存テストが通ることを確認

### フェーズ1: 職業システム

- class.ts 新規作成（職業定義・能力）
- プレイヤーの職業フィールド追加
- 職業選択UIの準備

### フェーズ2: 成長システム

- progression.ts 新規作成（レベル・撃破数・能力値上昇）
- 撃破数テーブルの定義
- レベルアップ選択ロジック（5択）
- プレイヤーの撃破数・レベル・能力値フィールド追加

### フェーズ3: プレイヤー拡張

- player.ts に職業・レベル・能力値の機能を統合
- 撃破数取得・レベルアップ処理
- 能力値に基づく攻撃・移動の適用
- 職業別初期能力値の適用

### フェーズ4: 壁ギミック

- wall.ts 新規作成（壁種類・壁状態管理）
- 壁の破壊・すり抜け判定
- collision.ts の壁判定拡張

### フェーズ5: 罠システム

- trap.ts 新規作成（罠種類・効果）
- 罠の発動処理
- collision.ts の罠判定追加

### フェーズ6: 敵AI拡張

- enemy.ts に RANGED 敵タイプ追加
- enemyAI.ts に遠距離攻撃型AIロジック追加
- FLEE を SPECIMEN にリネーム

### フェーズ7: アイテム拡張

- item.ts に新3種アイテム追加
- 各アイテム効果の実装

### フェーズ8: マップ生成拡張

- mazeGenerator.ts に罠・特殊壁の配置処理追加
- 配置バランスの調整

### フェーズ9: UI・演出統合

- IpnePage.tsx に職業選択画面追加
- レベルアップ時の5択選択UI
- 罠・特殊壁の職業別描画（盗賊：半透明表示）
- 能力値表示UI

### フェーズ10: バランス調整・検証

- パラメータ微調整
- プレイ時間が5〜10分に収まるか確認
- 繰り返しプレイの意味があるか確認

---

## 重要方針

- **既存のMVP2コードを拡張・改修**（新規ページ追加ではない）
- 変更はMVP3範囲に限定（ストーリー・ボイス・複雑なスキルツリー等は入れない）
- 職業差は「情報取得能力」と「初期能力値」の差として表現
- 罠は「利用・判断対象」として設計（単なる障害ではない）
- **TDD優先**: 先にテスト → 実装 → リファクタ
- **DRY原則**: 共通ロジックは関数として抽出
- **SOLID原則**: 各モジュールは単一責任を持つ

---

## 完了条件

- [ ] レベルアップが行動選択に影響する（5択の選択肢）
- [ ] 職業によって迷路の見え方・攻略法・初期能力が変わる
- [ ] 罠が「避ける対象」から「判断対象」になる
- [ ] ボスを倒してクリアできる
- [ ] プレイ時間が5〜10分に収まる
- [ ] 繰り返し遊ぶ意味がある（異なる職業・成長方針）

---

## MVP3 → MVP4 への判断基準

以下を満たしたら MVP4（アクセサリ・スキル・マルチプレイ等）に進む。

- 成長選択に意味がある
- 職業選択がプレイスタイルを変える
- 罠の利用戦術が生まれる
- 繰り返しプレイで新しい発見がある
