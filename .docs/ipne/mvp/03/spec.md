# 仕様・要件定義（IPNE MVP3）

## 1. 目的

MVP2（敵・HP・最低限の戦闘）をベースに、
**MVP3（成長・職業差・罠拡張）** を現行プロダクトへ追加する。

- 「判断が重なり合う状態」を検証する
- 成長選択によってプレイスタイルが変わるか確認する
- 職業差が情報取得能力の差として機能するか確認する
- 罠が「利用・判断対象」になるか確認する

### MVP3の本質

> MVP3は「強くなって爽快に敵を倒す」フェーズではない。
> **判断が重なり合う状態を作る** フェーズである。

---

## 2. ゲーム概要（MVP3）

### 2.1 コンセプト

自動生成された迷路を探索し、職業の特性を活かしながら、
成長選択と罠の利用を判断してゴールを目指す
**判断重視の探索プロトタイプ**。

### 2.2 プレイ時間

- 1プレイ：5〜10分程度
- 迷路サイズ：80x80タイル（MVP2と同じ）

### 2.3 MVP2との違い

| 項目 | MVP2 | MVP3 |
|------|------|------|
| 職業 | なし | 戦士/盗賊（2種） |
| 成長 | なし | レベルアップ（最大10） |
| 罠 | なし | 3種類 |
| 壁ギミック | 通常壁のみ | 4種類 |
| 敵種類 | 3種+ボス | 4種+ボス |
| アイテム | 回復2種 | 回復2種+新3種 |
| 繰り返し価値 | 低 | 高（職業差・成長差） |

---

## 3. 画面構成

1. **タイトル画面**
2. **職業選択画面**（新規）
3. **プロローグ画面**（開始直後1回）
4. **ゲーム画面**（+ マップオーバーレイ + HP/能力値表示）
5. **レベルアップ画面**（オーバーレイ、新規）
6. **クリア画面**
7. **ゲームオーバー画面**

---

## 4. 職業仕様

### 4.1 職業型定義

```typescript
const PlayerClass = {
  WARRIOR: 'warrior',
  THIEF: 'thief',
} as const;

type PlayerClassValue = (typeof PlayerClass)[keyof typeof PlayerClass];

interface ClassConfig {
  name: string;
  description: string;
  trapVisibility: 'none' | 'faint'; // 罠の可視性
  wallVisibility: 'none' | 'faint'; // 特殊壁の可視性
}
```

### 4.2 職業一覧

| 職業 | 名前 | 罠可視性 | 特殊壁可視性 | 説明 |
|------|------|----------|--------------|------|
| WARRIOR | 戦士 | none | none | 罠・特殊壁は触れるか攻撃して初めて判明 |
| THIEF | 盗賊 | faint | faint | 罠・特殊壁が常時うっすら見える |

### 4.3 職業の設計思想

- 職業差は **「情報取得能力」と「初期能力値」の差** として表現
- 戦士は「攻撃力が高く、ぶつかって進む」プレイスタイル
- 盗賊は「移動速度が高く、避けて進む」プレイスタイル

### 4.4 職業別初期能力値

| 能力 | 戦士 | 盗賊 | 説明 |
|------|------|------|------|
| attackPower | 2 | 1 | 1撃のダメージ量 |
| attackRange | 1 | 1 | 攻撃の届く距離（タイル） |
| moveSpeed | 4 | 6 | 移動速度（タイル/秒） |
| attackSpeed | 1.0 | 1.0 | クールダウン倍率（1.0=通常、0.5=2倍速） |
| healBonus | 0 | 0 | 回復アイテムの追加回復量 |

---

## 5. 成長仕様

### 5.1 成長関連型定義

```typescript
const StatType = {
  ATTACK_POWER: 'attackPower',
  ATTACK_RANGE: 'attackRange',
  MOVE_SPEED: 'moveSpeed',
  ATTACK_SPEED: 'attackSpeed',  // 新規
  HEAL_BONUS: 'healBonus',      // 新規
} as const;

type StatTypeValue = (typeof StatType)[keyof typeof StatType];

interface PlayerStats {
  attackPower: number;    // 攻撃力（敵へのダメージ量）
  attackRange: number;    // 攻撃距離（タイル数）
  moveSpeed: number;      // 移動速度（タイル/秒）
  attackSpeed: number;    // 攻撃速度（クールダウン倍率: 1.0 = 通常、0.5 = 2倍速）
  healBonus: number;      // 回復ボーナス
}

interface LevelUpChoice {
  stat: StatTypeValue;
  increase: number;
  description: string;
}
```

### 5.2 レベルシステム

| 項目 | 値 |
|------|-----|
| 最大レベル | 10 |
| 初期レベル | 1 |
| レベルアップ条件 | 必要撃破数の累計 |

### 5.3 撃破数テーブル

| レベルアップ | 必要撃破数 | 累計撃破数 |
|-------------|-----------|-----------|
| 1 → 2 | 1 | 1 |
| 2 → 3 | 2 | 3 |
| 3 → 4 | 2 | 5 |
| 4 → 5 | 2 | 7 |
| 5 → 6 | 3 | 10 |
| 6 → 7 | 3 | 13 |
| 7 → 8 | 4 | 17 |
| 8 → 9 | 4 | 21 |
| 9 → 10 | 4 | 25 |

※ 敵24体 + ボス1体で合計25体。レベル9(累計21)は通常敵のみで到達可能、レベル10(累計25)はボス込みで達成可能。

### 5.4 初期能力値（職業別）

職業ごとの初期能力値はセクション 4.4 を参照。

### 5.5 レベルアップ時の選択肢

レベルアップ時に以下の5択から1つを選択：

| 選択 | 効果 | 上限 |
|------|------|------|
| 攻撃力強化 | attackPower +1 | なし |
| 攻撃距離強化 | attackRange +1 | 3 |
| 移動速度強化 | moveSpeed +1 | 8 |
| 攻撃速度強化 | attackSpeed -0.1（クールダウン倍率） | 0.5（2倍速） |
| 回復量強化 | healBonus +1 | +5 |

### 5.6 能力値上限

| 能力 | 上限 |
|------|------|
| attackPower | なし（レベル10で最大+9） |
| attackRange | 3 |
| moveSpeed | 8 |
| attackSpeed | 0.5（クールダウン倍率の最小値） |
| healBonus | +5 |

---

## 6. 罠仕様

### 6.1 罠型定義

```typescript
const TrapType = {
  DAMAGE: 'damage',
  SLOW: 'slow',
  ALERT: 'alert',
} as const;

type TrapTypeValue = (typeof TrapType)[keyof typeof TrapType];

const TrapState = {
  HIDDEN: 'hidden',   // 未発見
  REVEALED: 'revealed', // 発見済み
  TRIGGERED: 'triggered', // 発動済み
} as const;

type TrapStateValue = (typeof TrapState)[keyof typeof TrapState];

interface Trap {
  id: string;
  x: number;
  y: number;
  type: TrapTypeValue;
  state: TrapStateValue;
  isVisibleToThief: boolean; // 盗賊への可視フラグ
}
```

### 6.2 罠種類

#### ダメージ床（Damage）

| 項目 | 値 |
|------|-----|
| ダメージ量 | 2 |
| 発動条件 | プレイヤーが踏む |
| 再発動 | 不可（1回限り） |
| 配置数 | 15個 |

#### 移動妨害床（Slow）

| 項目 | 値 |
|------|-----|
| 効果 | 移動速度50%低下 |
| 効果時間 | 3秒 |
| 発動条件 | プレイヤーが踏む |
| 再発動 | 可能（クールダウン5秒） |
| 配置数 | 10個 |

#### 索敵反応罠（Alert）

| 項目 | 値 |
|------|-----|
| 効果 | 周囲5タイル以内の敵を引き寄せる |
| 発動条件 | プレイヤーが踏む |
| 再発動 | 不可（1回限り） |
| 配置数 | 8個 |

### 6.3 罠の可視性

| 職業 | 未発見罠の表示 |
|------|---------------|
| 戦士 | 非表示（踏むまで見えない） |
| 盗賊 | 半透明表示（アルファ0.3） |

### 6.4 罠の設計思想

- 罠は **「利用・判断対象」** として設計
- 索敵反応罠は「わざと発動させて敵を集める」戦術を想定
- 移動妨害床は「敵を誘い込んで有利に戦う」戦術を想定
- ダメージ床は「HPリソースとの兼ね合い」判断を想定

---

## 7. 壁ギミック仕様

### 7.1 壁型定義

```typescript
const WallType = {
  NORMAL: 'normal',
  BREAKABLE: 'breakable',
  PASSABLE: 'passable',
  INVISIBLE: 'invisible',
} as const;

type WallTypeValue = (typeof WallType)[keyof typeof WallType];

const WallState = {
  INTACT: 'intact',     // 健在
  DAMAGED: 'damaged',   // 損傷（破壊可能壁のみ）
  BROKEN: 'broken',     // 破壊済み
  REVEALED: 'revealed', // 発見済み（すり抜け/透明壁）
} as const;

type WallStateValue = (typeof WallState)[keyof typeof WallState];

interface Wall {
  x: number;
  y: number;
  type: WallTypeValue;
  state: WallStateValue;
  hp?: number; // 破壊可能壁のHP
}
```

### 7.2 壁種類

#### 通常壁（Normal）

| 項目 | 値 |
|------|-----|
| 通過 | 不可 |
| 攻撃 | 無効 |
| 配置 | 既存の壁タイル |

#### 破壊可能壁（Breakable）

| 項目 | 値 |
|------|-----|
| 通過 | 不可（破壊後は可能） |
| HP | 3 |
| 攻撃 | 有効（1ダメージ） |
| 配置数 | 20個（通路間の壁を置換） |
| 見た目 | ひび割れ模様（戦士は攻撃して初めてわかる） |

#### すり抜け可能壁（Passable）

| 項目 | 値 |
|------|-----|
| 通過 | 可能（通過後、発見済みになる） |
| 攻撃 | 無効 |
| 配置数 | 8個（行き止まりに配置） |
| 見た目 | 通常壁と同じ（盗賊には半透明で異なる色） |

#### 透明壁（Invisible）

| 項目 | 値 |
|------|-----|
| 通過 | 不可 |
| 攻撃 | 無効（触れると発見済み） |
| 配置数 | 5個（通路の一部に配置） |
| 見た目 | 非表示（盗賊には半透明表示） |

### 7.3 壁の可視性

| 職業 | 破壊可能壁 | すり抜け可能壁 | 透明壁 |
|------|-----------|---------------|--------|
| 戦士 | 攻撃後に判明 | 通過後に判明 | 接触後に判明 |
| 盗賊 | 常時表示（異色） | 常時表示（半透明） | 常時表示（半透明） |

---

## 8. 敵仕様（拡張）

### 8.1 新規敵タイプ：遠距離型（RANGED）

```typescript
const EnemyType = {
  PATROL: 'patrol',
  CHARGE: 'charge',
  RANGED: 'ranged',    // 新規
  SPECIMEN: 'specimen', // FLEE から名称変更
  BOSS: 'boss',
} as const;
```

#### 遠距離型（Ranged）パラメータ

| パラメータ | 値 |
|-----------|-----|
| HP | 2 |
| ダメージ | 1 |
| 速度 | 3 タイル/秒 |
| 視認範囲 | 7 タイル |
| 攻撃範囲 | 4 タイル |
| 追跡範囲 | 10 タイル |
| 理想距離 | 3〜4 タイル |

#### 遠距離型AIロジック

1. プレイヤーを視認
2. 理想距離（3〜4タイル）を維持
3. プレイヤーが近づいたら後退
4. 攻撃範囲内で遠距離攻撃（弾速：即着弾）
5. 攻撃クールダウン：1500ms

### 8.2 標本型（SPECIMEN、旧FLEE）

名称変更のみ。パラメータ・ロジックはMVP2の逃走型と同一。
「捕獲対象」としての価値を示すために名称変更。

### 8.3 敵配置（MVP3）

| 項目 | 値 |
|------|-----|
| 合計数 | 24体 + ボス1体 |
| 構成 | 巡回型10体、突進型6体、遠距離型5体、標本型3体 |
| 配置 | 部屋ごとに1〜4体（部屋サイズに応じて） |

---

## 9. アイテム仕様（拡張）

### 9.1 新規アイテム型定義

```typescript
const ItemType = {
  HEALTH_SMALL: 'health_small',
  HEALTH_LARGE: 'health_large',
  HEALTH_FULL: 'health_full',   // 新規
  LEVEL_UP: 'level_up',         // 新規
  MAP_REVEAL: 'map_reveal',     // 新規
} as const;
```

### 9.2 新規アイテム一覧

#### HP全回復（health_full）

| 項目 | 値 |
|------|-----|
| 効果 | HPを最大値まで回復 |
| 配置数 | 3個 |
| 配置場所 | 大きめの部屋 |

#### 即レベルアップ（level_up）

| 項目 | 値 |
|------|-----|
| 効果 | 即座に1レベルアップ（選択UI表示） |
| 配置数 | 5個 |
| 配置場所 | 隠し通路、行き止まり |

#### 地図（map_reveal）

| 項目 | 値 |
|------|-----|
| 効果 | 全マップを探索済み状態に |
| 配置数 | 1個 |
| 配置場所 | 中央付近の部屋 |

### 9.3 アイテム配置総数

| アイテム | 配置数 |
|----------|--------|
| 小回復 | 8個 |
| 大回復 | 3個 |
| HP全回復 | 3個 |
| 即レベルアップ | 5個 |
| 地図 | 1個 |
| **合計** | **20個** |

---

## 10. プレイヤー仕様（拡張）

### 10.1 Player型拡張

```typescript
interface Player {
  // MVP2からの継承
  x: number;
  y: number;
  hp: number;
  maxHp: number;
  direction: DirectionValue;
  isInvincible: boolean;
  invincibleUntil: number;
  attackCooldownUntil: number;

  // MVP3追加
  playerClass: PlayerClassValue;  // 職業
  level: number;                  // 現在レベル
  killCount: number;              // 敵撃破数（レベルアップ判定に使用）
  stats: PlayerStats;             // 能力値
  slowedUntil: number;            // 移動速度低下終了時刻
}
```

### 10.2 初期値（職業別）

| 項目 | 戦士 | 盗賊 |
|------|------|------|
| HP | 16 | 16 |
| maxHp | 16 | 16 |
| level | 1 | 1 |
| killCount | 0 | 0 |
| attackPower | 2 | 1 |
| attackRange | 1 | 1 |
| moveSpeed | 4 | 6 |
| attackSpeed | 1.0 | 1.0 |
| healBonus | 0 | 0 |

---

## 11. 操作仕様（MVP2から継承）

### 11.1 移動操作

#### PC
- 移動：WASD または 矢印キー
- 連続移動：キー押し続けで自動移動

#### モバイル
- D-padタップで移動
- 連続移動：D-pad押し続けで自動移動

### 11.2 攻撃操作

#### PC
- 攻撃：スペースキー

#### モバイル
- 攻撃：D-pad中央の攻撃ボタンタップ

### 11.3 マップ操作

- PC：`M` キーでマップ表示切替
- モバイル：マップアイコンタップで切替

---

## 12. UI仕様（拡張）

### 12.1 職業選択画面

| 項目 | 値 |
|------|-----|
| タイミング | タイトル画面後、プロローグ前 |
| 選択肢 | 戦士 / 盗賊 |
| 表示内容 | 職業名、特徴説明、アイコン |

### 12.2 レベルアップUI

| 項目 | 値 |
|------|-----|
| タイミング | レベルアップ時（ゲーム一時停止） |
| 選択肢 | 攻撃力 / 攻撃距離 / 移動速度 / 攻撃速度 / 回復量（5択） |
| 表示内容 | 現在値、上昇量、効果説明 |
| 上限表示 | 上限到達時はグレーアウト |

### 12.3 能力値表示

| 項目 | 値 |
|------|-----|
| 位置 | HP表示の下 |
| 形式 | アイコン + 数値 |
| 表示項目 | Lv、ATK、RNG、SPD、ASPD、HEAL |

### 12.4 撃破数表示

| 項目 | 値 |
|------|-----|
| 位置 | レベル表示の横 |
| 形式 | 撃破数バー（現在撃破数/次レベルまでの必要撃破数） |
| 色 | 紫系 |

### 12.5 罠・壁の描画

#### 戦士の場合

| 状態 | 表示 |
|------|------|
| 未発見罠 | 非表示 |
| 発見済み罠 | 通常表示 |
| 未発見特殊壁 | 通常壁と同じ |
| 発見済み特殊壁 | 種類に応じた表示 |

#### 盗賊の場合

| 状態 | 表示 |
|------|------|
| 未発見罠 | 半透明表示（アルファ0.3） |
| 発見済み罠 | 通常表示 |
| 未発見特殊壁 | 半透明で異なる色 |
| 発見済み特殊壁 | 通常表示 |

---

## 13. ビジュアル仕様（拡張）

### 13.1 罠の色

| 罠種類 | 色 |
|--------|-----|
| ダメージ床 | 暗い赤 (#dc2626) |
| 移動妨害床 | 暗い黄 (#ca8a04) |
| 索敵反応罠 | 暗い紫 (#7c3aed) |

### 13.2 特殊壁の色

| 壁種類 | 通常表示 | 盗賊の半透明表示 |
|--------|---------|-----------------|
| 破壊可能壁 | 茶色ひび割れ (#78350f) | 同色半透明 |
| すり抜け可能壁 | 通常壁色 | 青緑 (#0d9488) |
| 透明壁 | 非表示 | 薄い青 (#60a5fa) |

### 13.3 新規敵の色

| 敵種類 | 色 |
|--------|-----|
| 遠距離型 | 暗いオレンジ (#c2410c) |
| 標本型 | 暗い青 (#1e3a5f)（旧逃走型と同じ） |

### 13.4 新規アイテムの色・形状

| アイテム | 色 | 形状 |
|----------|-----|------|
| HP全回復 | 金色 (#fbbf24) | 大きなハート |
| 即レベルアップ | 虹色/白 (#f0abfc) | 星形 |
| 地図 | 茶色 (#a16207) | 巻物形 |

---

## 14. 技術/アーキテクチャ要件

### 14.1 ファイル構成（新規・変更）

```
src/
├── pages/
│   └── IpnePage.tsx           # 職業選択・レベルアップUI追加
├── features/
│   └── ipne/
│       ├── index.ts           # エクスポート更新
│       ├── types.ts           # 新規型追加
│       ├── player.ts          # 職業・レベル・能力値機能追加
│       ├── progression.ts     # 新規：成長システム
│       ├── class.ts           # 新規：職業システム
│       ├── trap.ts            # 新規：罠システム
│       ├── wall.ts            # 新規：壁ギミック
│       ├── enemy.ts           # RANGED敵追加
│       ├── enemyAI.ts         # 遠距離型AI追加
│       ├── item.ts            # 新アイテム追加
│       ├── collision.ts       # 罠・壁判定追加
│       ├── autoMapping.ts     # 職業別表示追加
│       ├── mazeGenerator.ts   # 罠・壁配置追加
│       └── __tests__/
│           ├── progression.test.ts  # 新規
│           ├── class.test.ts        # 新規
│           ├── trap.test.ts         # 新規
│           └── wall.test.ts         # 新規
```

### 14.2 コーディング規約

- `any` 不使用
- `null` 不使用
- `as const` と Union 型で定数管理
- 純粋ロジックは `src/features/ipne/` に分離（TDD対象）
- コメント・docstringは日本語

---

## 15. ゲームフロー

### 15.1 状態遷移

```
TITLE → CLASS_SELECT → PROLOGUE → GAME → CLEAR
                                    ↓
                              (LEVEL_UP) ← 一時停止オーバーレイ
                                    ↓
                               GAME_OVER → GAME (リトライ)
                                    ↓
                                  TITLE
```

### 15.2 ゲームオーバー条件

- HP <= 0

### 15.3 クリア条件

- ゴールタイル到達（MVP2と同じ）

---

## 16. テスト要件（TDD）

### 16.1 成長システムテスト

- 撃破数取得が正しい
- レベルアップ条件が正しい
- 能力値上昇が正しく適用される
- 能力値上限が正しく機能する

### 16.2 職業システムテスト

- 職業ごとの可視性設定が正しい
- 戦士は罠・特殊壁が見えない
- 盗賊は罠・特殊壁が半透明で見える

### 16.3 罠システムテスト

- ダメージ床のダメージ計算が正しい
- 移動妨害床の速度低下が正しく適用される
- 索敵反応罠の敵引き寄せが正しい
- 罠の発見状態管理が正しい

### 16.4 壁ギミックテスト

- 破壊可能壁のHP管理が正しい
- すり抜け可能壁の通過判定が正しい
- 透明壁の衝突判定が正しい
- 壁の発見状態管理が正しい

### 16.5 敵AI拡張テスト

- 遠距離型の距離維持が正しい
- 遠距離攻撃の発動条件が正しい
- 後退行動が正しく発生する

### 16.6 アイテム拡張テスト

- HP全回復が正しく動作する
- 即レベルアップが正しく動作する
- 地図が全マップを開示する

---

## 17. 受け入れ基準

- [ ] 職業選択画面が表示される
- [ ] 戦士と盗賊で罠・壁の見え方が異なる
- [ ] 敵撃破で撃破数がカウントされる
- [ ] レベルアップ時に能力選択ができる
- [ ] 選択した能力が正しく上昇する
- [ ] 3種類の罠が正しく動作する
- [ ] 4種類の壁が正しく動作する
- [ ] 遠距離型敵が正しく動作する
- [ ] 新アイテム3種が正しく動作する
- [ ] プレイ時間が5〜10分に収まる
- [ ] 繰り返しプレイで異なる体験ができる
- [ ] テストが追加され `npm test` が通る

---

## 18. 実装しない要素（明確化）

MVP3では以下は **実装しない**。

- スキルツリー
- アクセサリ・装備
- マルチプレイ
- ストーリーテキスト
- ボイス
- 複雑なクラフトシステム
- セーブ・ロード
- 実績システム

---

## 19. 評価観点（MVP3完了後）

以下を必ず確認する。

- レベルアップ選択に意味があったか
- 職業選択がプレイスタイルを変えたか
- 罠を「利用しよう」と思ったか
- 繰り返しプレイで新しい発見があったか

### NG例

- 常に同じ能力を上げてしまう → 選択肢のバランス調整
- 職業差を感じない → 可視性の差を強化
- 罠を全て避けるだけ → 利用メリットの追加
- 1回クリアで満足 → 職業・成長による変化の強化
