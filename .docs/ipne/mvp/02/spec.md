# 仕様・要件定義（IPNE MVP2）

## 1. 目的

`.docs/ipne/specs/mvp_2_：敵・hp・最低限の戦闘.md` をベースに、
**MVP2（敵・HP・最低限の戦闘）** を現行プロダクトへ追加する。

- 「危険がある中で探索する体験」を検証する
- 敵の存在によってルート選択が変わるか確認する
- ダメージが心理的プレッシャーになるか確認する

### MVP2の本質

> MVP2は「戦闘を面白くする」フェーズではない。
> **危険がある中で探索する体験が成立するか** を検証するフェーズである。

---

## 2. ゲーム概要（MVP2）

### 2.1 コンセプト

自動生成された迷路を探索し、敵を避けたり戦いながらゴールを目指す
**危険を伴う探索プロトタイプ**。

### 2.2 プレイ時間

- 1プレイ：5〜7分程度

### 2.3 MVP1との違い

| 項目 | MVP1 | MVP2 |
|------|------|------|
| 危険要素 | なし | 敵・ダメージ |
| HP | なし | あり（初期12） |
| 戦闘 | なし | ワンボタン攻撃 |
| アイテム | なし | 回復アイテム |
| ゲームオーバー | なし | HP0で発生 |
| プレイ時間 | 1〜2分 | 5〜7分 |

---

## 3. 画面構成

1. **タイトル画面**
2. **プロローグ画面**（開始直後1回）
3. **ゲーム画面**（+ マップオーバーレイ + HP表示）
4. **クリア画面**
5. **ゲームオーバー画面**（新規）

※ MVP1と同一構成、ゲームオーバー画面が追加

---

## 4. プレイヤー仕様

### 4.1 Player型拡張

```typescript
interface Player {
  x: number;
  y: number;
  hp: number;                    // 現在HP
  maxHp: number;                 // 最大HP
  direction: DirectionValue;     // 現在の向き（攻撃方向に使用）
  isInvincible: boolean;         // 無敵状態フラグ
  invincibleUntil: number;       // 無敵終了時刻 (ms)
  attackCooldownUntil: number;   // 攻撃クールダウン終了時刻 (ms)
}
```

### 4.2 HP仕様

| 項目 | 値 |
|------|-----|
| 初期HP | 12 |
| 最大HP | 12 |
| 自然回復 | なし |
| 回復手段 | アイテムのみ |

👉 **すぐ死なないが、無視もできない量**

### 4.3 無敵時間

| 項目 | 値 |
|------|-----|
| 被ダメージ後無敵時間 | 1000ms |
| 点滅間隔 | 100ms |
| 視覚効果 | 表示/非表示の切替 |

### 4.4 向き（Direction）

- 最後に移動した方向を保持
- 攻撃時にこの方向を使用
- 初期値: DOWN

---

## 5. 敵仕様

### 5.1 Enemy型

```typescript
type EnemyType = 'patrol' | 'charge' | 'flee';

type EnemyState = 'idle' | 'patrol' | 'chase' | 'attack' | 'flee' | 'return' | 'knockback';

interface Enemy {
  id: string;
  x: number;
  y: number;
  type: EnemyType;
  hp: number;
  maxHp: number;
  damage: number;               // 接触ダメージ
  speed: number;                // 移動速度 (タイル/秒)
  detectionRange: number;       // 視認範囲 (タイル)
  chaseRange: number;           // 追跡限界距離 (タイル)
  state: EnemyState;            // 現在の行動状態
  patrolPath?: Position[];      // 巡回パス (巡回型のみ)
  patrolIndex?: number;         // 現在のパスインデックス
  homePosition: Position;       // 初期配置位置（帰還先）
  lastKnownPlayerPos?: Position;// 最後に認識したプレイヤー位置
  knockbackUntil?: number;      // ノックバック終了時刻
  knockbackDirection?: DirectionValue;
}
```

### 5.2 敵種類（3種）

#### 巡回型（Patrol）

- 一定範囲を往復
- プレイヤーを見つけると追跡
- 追跡を諦めると初期位置に帰還

| パラメータ | 値 |
|-----------|-----|
| HP | 3 |
| ダメージ | 1 |
| 速度 | 3 タイル/秒 |
| 視認範囲 | 5 タイル |
| 追跡範囲 | 8 タイル |

#### 突進型（Charge）

- 発見すると一直線に接近
- 攻撃力高め、動き単純

| パラメータ | 値 |
|-----------|-----|
| HP | 2 |
| ダメージ | 2 |
| 速度 | 5 タイル/秒 |
| 視認範囲 | 6 タイル |
| 追跡範囲 | 10 タイル |

#### 逃走型（Flee）

- プレイヤーから距離を取る
- 攻撃しない
- 数は少なめ（ドロップアイテム要員など将来用）

| パラメータ | 値 |
|-----------|-----|
| HP | 1 |
| ダメージ | 0 |
| 速度 | 4 タイル/秒 |
| 視認範囲 | 4 タイル |
| 追跡範囲 | - |

#### ボス

- 突進型の強化版
- 広めの部屋に配置

| パラメータ | 値 |
|-----------|-----|
| HP | 10 |
| ダメージ | 3 |
| 速度 | 4 タイル/秒 |
| 視認範囲 | 8 タイル |
| 追跡範囲 | 15 タイル |

### 5.3 敵AI共通ルール

| ルール | 詳細 |
|--------|------|
| 視認判定 | マンハッタン距離で円形 |
| 追跡開始 | 視認範囲内にプレイヤーがいる |
| 追跡中断 | 追跡距離を超える or 3秒間見失う |
| 壁貫通 | 不可（経路探索を使用） |
| 移動更新間隔 | 200ms |
| 帰還行動 | 追跡中断後、初期位置に戻る |

👉 **常に追われ続けないことが重要**

### 5.4 敵配置

| 項目 | 値 |
|------|-----|
| 合計数 | 25体 + ボス1体 |
| 構成 | 巡回型15体、突進型8体、逃走型2体 |
| 配置 | 部屋ごとに1〜3体（部屋サイズに応じて） |
| ボス配置 | 最大の部屋 |
| スタート部屋 | 敵なし（安全地帯） |
| ゴール部屋 | ボスを配置 |

---

## 6. 戦闘仕様

### 6.1 プレイヤー攻撃

| 項目 | 値 |
|------|-----|
| 入力 | スペースキー / 攻撃ボタンタップ |
| 範囲 | 前方1タイル（現在の向き） |
| ダメージ | 1（固定） |
| クールタイム | 500ms |
| ヒット効果 | 敵を1タイルノックバック |

👉 テクニックより「距離管理」重視

### 6.2 ダメージ仕様

| 項目 | 値 |
|------|-----|
| ダメージ発生 | 敵との接触 |
| ダメージ量 | 敵のdamage値（固定） |
| 無敵時間 | 被ダメージ後1000ms |

### 6.3 ノックバック

| 項目 | 値 |
|------|-----|
| 距離 | 1タイル |
| 時間 | 200ms |
| 壁衝突 | その場で停止 |
| 対象 | 攻撃を受けた敵のみ |

### 6.4 敵の撃破

- HP0で消滅
- 消滅エフェクト（点滅後消える）

---

## 7. アイテム仕様

### 7.1 Item型

```typescript
type ItemType = 'health_small' | 'health_large';

interface Item {
  id: string;
  x: number;
  y: number;
  type: ItemType;
  healAmount: number;
}
```

### 7.2 アイテム種類

| 種類 | 回復量 | 配置数 | 配置場所 |
|------|-------:|-------:|----------|
| 小回復 | 2 | 8 | 通路・小部屋 |
| 大回復 | 5 | 3 | 大きめの部屋 |

### 7.3 取得条件

- プレイヤーが同じタイルに移動
- 取得時にUI演出（ポップアップ「+2」など）
- 取得後アイテム消滅

---

## 8. 操作仕様

### 8.1 移動操作（MVP1から継承）

#### PC

- 移動：WASD または 矢印キー
- 連続移動：キー押し続けで自動移動

#### モバイル

- D-padタップで移動
- 連続移動：D-pad押し続けで自動移動

### 8.2 攻撃操作

#### PC

- 攻撃：スペースキー

#### モバイル

- 攻撃：D-pad中央の攻撃ボタンタップ

### 8.3 マップ操作（MVP1から継承）

- PC：`M` キーでマップ表示切替
- モバイル：マップアイコンタップで切替

---

## 9. UI仕様

### 9.1 HP表示

| 項目 | 値 |
|------|-----|
| 位置 | 画面左上 |
| 形式 | HPバー + 数値表示 |
| 色 | 緑（高HP）→ 黄（中HP）→ 赤（低HP） |
| サイズ | 幅200px、高さ20px |

### 9.2 攻撃ボタン（モバイル）

| 項目 | 値 |
|------|-----|
| 位置 | D-padの中央 |
| サイズ | 50x50px |
| 表示 | 剣アイコン or 「ATK」 |
| クールダウン中 | 半透明表示 |

### 9.3 ダメージエフェクト

| 効果 | 詳細 |
|------|------|
| 画面点滅 | 赤いオーバーレイが一瞬表示 |
| プレイヤー点滅 | 無敵時間中、100ms間隔で表示/非表示 |

### 9.4 ゲームオーバー画面

| 要素 | 詳細 |
|------|------|
| タイトル | 「GAME OVER」 |
| ボタン1 | 「リトライ」→ ゲーム画面へ（同じ迷路で再挑戦） |
| ボタン2 | 「タイトルへ」→ タイトル画面へ |

---

## 10. ビジュアル仕様

### 10.1 敵の色（抽象ファンタジー遺跡準拠）

| 敵種類 | 色 |
|--------|-----|
| 巡回型 | 暗い紫 (#6b21a8) |
| 突進型 | 暗い赤 (#991b1b) |
| 逃走型 | 暗い青 (#1e3a5f) |
| ボス | 濃い赤紫 (#7c2d12) |

### 10.2 敵の形状

- 基本形状：円形（プレイヤーと同様）
- サイズ：プレイヤーより少し大きい（半径 = タイルサイズ * 0.4）
- ボス：さらに大きい（半径 = タイルサイズ * 0.6）

### 10.3 アイテムの色・形状

| アイテム | 色 | 形状 |
|----------|-----|------|
| 小回復 | 明るい緑 (#22c55e) | 小さな十字 |
| 大回復 | 明るい赤 (#ef4444) | 大きなハート or 十字 |

---

## 11. 技術/アーキテクチャ要件

### 11.1 ファイル構成

```
src/
├── pages/
│   └── IpnePage.tsx           # ゲームオーバー画面追加、敵描画追加
├── features/
│   └── ipne/
│       ├── index.ts           # エクスポート更新
│       ├── types.ts           # Player拡張、Enemy、Item、Combat型追加
│       ├── player.ts          # HP・向き・無敵時間機能追加
│       ├── enemy.ts           # 新規：敵生成・管理
│       ├── enemySpawner.ts    # 新規：敵配置ロジック
│       ├── enemyAI.ts         # 新規：敵AIロジック
│       ├── combat.ts          # 新規：戦闘・ダメージ処理
│       ├── item.ts            # 新規：アイテム生成・効果
│       ├── collision.ts       # 敵衝突判定追加
│       └── __tests__/
│           ├── enemy.test.ts      # 新規
│           ├── enemyAI.test.ts    # 新規
│           ├── combat.test.ts     # 新規
│           └── item.test.ts       # 新規
```

### 11.2 コーディング規約

- `any` 不使用
- `null` 不使用
- `as const` と Union 型で定数管理
- 純粋ロジックは `src/features/ipne/` に分離（TDD対象）

---

## 12. ゲームフロー

### 12.1 状態遷移

```
TITLE → PROLOGUE → GAME → CLEAR
                     ↓
                 GAME_OVER → GAME (リトライ)
                     ↓
                   TITLE
```

### 12.2 ゲームオーバー条件

- HP <= 0

### 12.3 クリア条件

- ゴールタイル到達（MVP1と同じ）

---

## 13. テスト要件（TDD）

### 13.1 プレイヤー拡張テスト

- HP初期化が正しい
- ダメージ計算が正しい
- 回復計算が正しい（最大HPを超えない）
- 無敵時間が正しく判定される
- 攻撃クールダウンが正しく判定される

### 13.2 敵生成テスト

- 種類別パラメータが正しい
- 敵IDが一意
- 敵HPが正しく管理される

### 13.3 敵AIテスト

- 視認判定が正しい
- 追跡開始条件が正しい
- 追跡中断条件が正しい
- 巡回パスが正しく生成される
- 逃走方向が正しい

### 13.4 戦闘テスト

- 攻撃範囲が前方1タイル
- 攻撃クールダウンが機能する
- ノックバックが正しく適用される
- 接触ダメージが正しく計算される

### 13.5 アイテムテスト

- アイテム生成が正しい
- 取得判定が正しい
- 回復効果が正しく適用される

---

## 14. 受け入れ基準

- [ ] 敵がマップ上に表示される
- [ ] 敵がAIで動作する（巡回・追跡・逃走）
- [ ] プレイヤーのHP表示がある
- [ ] 攻撃ボタンで敵を攻撃できる
- [ ] 敵との接触でダメージを受ける
- [ ] ダメージ時に無敵時間が発生する
- [ ] 回復アイテムでHPを回復できる
- [ ] HP0でゲームオーバー画面に遷移する
- [ ] ゲームオーバーからリトライできる
- [ ] ゴール到達でクリア
- [ ] 戦っても避けてもクリア可能
- [ ] 1プレイ5〜7分程度で完結する（要手動検証）
- [ ] テストが追加され `npm test` が通る

---

## 15. 実装しない要素（明確化）

MVP2では以下は **実装しない**。

- レベルアップ
- 職業差
- 特殊攻撃
- 複雑なギミック
- 罠の種類増加
- タイム評価
- 敵ドロップアイテム
- 複数の武器

👉 **判断ノイズを増やさない**

---

## 16. 評価観点（MVP2完了後）

以下を必ず確認する。

- 敵を避ける選択が生まれたか
- 戦闘が「必須」になっていないか
- HPを見て行動を変えたか
- 理不尽に感じる瞬間がないか

### NG例

- 敵が多すぎて探索できない → 敵数減少
- 戦わないと進めない → 配置調整
- 被弾が頻発してストレス → 敵速度・視認範囲調整
