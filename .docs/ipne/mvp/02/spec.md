# 仕様・要件定義（IPNE MVP1）

## 1. 目的

`.docs/ipne/specs/mvp_1_：自動生成迷路＋調査体験.md` をベースに、
**MVP1（自動生成迷路＋調査体験）** を現行プロダクトへ追加する。

- 「迷路を探索する面白さ」を検証する
- マップを見る行動が自然に発生するか確認する
- 1プレイ1、2分程度の体験を実現する

### MVP1の本質

> MVP1は「迷路生成ができたか」ではない。
> **プレイヤーが自分で把握しようとするか** を検証するフェーズである。

---

## 2. ゲーム概要（MVP1）

### 2.1 コンセプト

自動生成された迷路を探索し、マップを活用しながらゴールを目指す
**調査体験プロトタイプ**。

### 2.2 プレイ時間

- 1プレイ：1、2分程度

### 2.3 MVP0との違い

| 項目 | MVP0 | MVP1 |
|------|------|------|
| 迷路 | 固定 | 自動生成 |
| マップ | なし | 自動マッピング |
| プレイ時間 | 2〜3分 | 1、2分程度 |
| 迷い | 最小 | 意図的に発生 |

---

## 3. 画面構成

1. **タイトル画面**
2. **プロローグ画面**（開始直後1回）
3. **ゲーム画面**（+ マップオーバーレイ）
4. **クリア画面**

※ MVP0と同一構成、マップオーバーレイが追加

---

## 4. ゲームルール（MVP1）

- プレイヤーは自動生成された迷路内を自由に移動できる
- 壁に当たると停止（通過不可）
- ゴールに接触するとクリア
- 通過したエリアは自動的にマップに記録される
- 敵・罠・HP・レベルアップは無し

---

## 5. 操作仕様

### 5.1 移動操作（MVP0と同一）

#### PC

- 移動：WASD または 矢印キー

#### モバイル

- 画面4分割タップで移動方向を決定

#### 微調整許容範囲

- 移動速度の調整は可
- 当たり判定の微調整は可

### 5.2 マップ操作

- PC：`M` キーでマップ表示切替（または常時表示）
- モバイル：画面上部のマップアイコンタップで切替

---

## 6. 自動生成迷路仕様

### 6.1 基本構造

- **タイルベース**（正方形グリッド）
- **部屋＋通路構成**
  - 部屋：6x6〜10x10程度の空間（将来の敵・罠配置を考慮）
  - 通路：幅3〜4タイル（戦闘・回避の余地を確保）
- 必ずスタートからゴールまで到達可能

👉 MVP2以降で敵・罠を配置するため、広めの空間を確保する

### 6.2 生成アルゴリズム要件

- BSP（Binary Space Partitioning）または類似手法
- 部屋数：5〜10程度
- ループ：0〜2箇所（少量）
- 一本道率：高め

### 6.3 サイズ目安

- グリッドサイズ：60x60〜80x80タイル
- 1、2分程度で探索完了する規模

👉 部屋・通路が広くなった分、グリッドサイズも拡大

### 6.4 制約

- 袋小路は許容（適度な迷い）
- 完全な一本道は NG（探索感がない）
- 広すぎる空間は NG（ダレる）

---

## 7. スタート／ゴール配置仕様

### 7.1 スタート位置

- 迷路の外周付近に配置
- 部屋の中に配置（通路上ではない）

### 7.2 ゴール位置

- スタートから**最も遠い地点**に配置
- 距離計算：BFSによる経路長
- 視覚的に識別可能（色・形で区別）

---

## 8. 自動マッピング仕様

### 8.1 表示ルール

**重要：マップは「線のみ」で構成する。壁は表示しない。**

| エリア | 表示 |
|--------|------|
| 未探索 | 非表示（黒/透明） |
| 通過済み通路 | 線で表示（細線） |
| 通過済み部屋 | 線で輪郭表示（塗りつぶしなし） |
| 壁 | **表示しない** |
| 現在位置 | マーカー表示 |
| ゴール位置 | 発見後のみ表示 |

👉 マップは「調査ログ」であり、完全な地図ではない。
通った場所だけが線として残るイメージ。

### 8.2 探索判定

- プレイヤーが通過したタイルを「探索済み」とする
- 探索済みタイルの隣接タイルは「見える」状態に

### 8.3 描画仕様

- マップは**半透明オーバーレイ**でゲーム画面に重ねる
- 不透明度：50〜70%
- 背景色：暗いグレー or 黒
- 線色：淡い青 or くすんだ緑（ビジュアル仕様準拠）

### 8.4 表示切替

- **常時表示モード**：画面右上に小さく表示
- **全画面モード**：キー/タップで切替、画面中央に大きく表示

---

## 9. ビジュアル仕様（抽象ファンタジー遺跡準拠）

### 9.1 カラーパレット

| 要素 | 色 |
|------|-----|
| 床 | 鈍いブラウン / 暗いグレー |
| 壁 | 黒に近い青 / 濃いグレー |
| 通路 | 床と同系色 |
| ゴール | 淡い青（アクセント） |
| プレイヤー | くすんだ緑（アクセント） |

### 9.2 描画指針

- 単色・簡易テクスチャで可
- 模様は省略
- 立体感は影だけで表現
- 装飾は行わない

---

## 10. 技術/アーキテクチャ要件

### 10.1 ファイル構成

**既存の `ipne-mvp0` を `ipne` にリネームして拡張する。**

```
src/
├── pages/
│   ├── IpnePage.tsx           # 旧 IpneMvp0Page.tsx
│   ├── IpnePage.styles.ts     # 旧 IpneMvp0Page.styles.ts
│   └── IpnePage.test.tsx      # 旧 IpneMvp0Page.test.tsx
├── features/
│   └── ipne/                  # 旧 ipne-mvp0/
│       ├── index.ts
│       ├── mazeGenerator.ts      # 新規: 迷路生成
│       ├── mazeGenerator.test.ts
│       ├── pathfinder.ts         # 新規: 経路探索・距離計算
│       ├── pathfinder.test.ts
│       ├── autoMapping.ts        # 新規: 自動マッピング
│       ├── autoMapping.test.ts
│       ├── player.ts             # 既存: プレイヤーロジック
│       ├── player.test.ts
│       └── types.ts              # 既存+拡張: 型定義
```

### 10.2 コーディング規約

- `any` 不使用
- `null` 不使用
- `as const` と Union 型で定数管理
- 純粋ロジックは `src/features/ipne-mvp1/` に分離（TDD対象）

### 10.3 MVP0からの変更方針

- **既存のMVP0コードを直接拡張・改修**（新規ページ追加ではない）
- `ipne-mvp0` → `ipne` にリネーム（MVP番号を含まない汎用名）
- ルートも `/ipne-mvp0` → `/ipne` に変更
- GameListのカードはそのまま使用（リンク先のみ更新）
- gitで履歴管理されているため、MVP段階ごとの別ページ保持は不要

---

## 11. テスト要件（TDD）

### 11.1 迷路生成テスト

- 指定サイズの迷路が生成される
- 部屋が規定数存在する
- スタートからゴールまで到達可能
- ループ数が制限内

### 11.2 スタート/ゴール配置テスト

- スタートが外周付近に配置される
- ゴールがスタートから最遠地点に配置される

### 11.3 自動マッピングテスト

- 未探索エリアが非表示
- 通過済みエリアが表示される
- 探索状態が正しく更新される

### 11.4 UI統合テスト

- `IpnePage` が描画される
- マップオーバーレイが表示/非表示切替できる
- ルート `/ipne` でアクセスできること

---

## 12. 受け入れ基準

- [ ] `/ipne` でゲームが開始できる
- [ ] 毎回異なる迷路が生成される
- [ ] タイトル → プロローグ → ゲーム → クリア のE2Eが成立
- [ ] キーボード/タップでスムーズに移動できる
- [ ] 壁は通過できない
- [ ] ゴール接触でクリア画面に遷移する
- [ ] マップが自動的に更新される
- [ ] マップ表示切替が動作する
- [ ] 1プレイ1、2分程度で完結する
- [ ] テストが追加され `npm test` が通る

---

## 13. 実装しない要素（明確化）

MVP1では以下は **実装しない**。

- 敵
- HP
- ダメージ
- レベルアップ
- 職業差
- 罠
- 特殊壁（破壊可能壁・透明壁等）
- アイテム
- タイム評価

---

## 14. 評価観点（MVP1完了後）

以下を必ず確認する。

- マップを何回開いたか
- ゴールまで直進できたか
- 迷って引き返す行動があったか
- 一本道に感じたか／迷路に感じたか

### NG例

- 迷路が広すぎてダレる → サイズ縮小
- 一本道すぎて迷わない → ループ追加/構造変更
- マップを見なくてもクリアできる → 複雑化
