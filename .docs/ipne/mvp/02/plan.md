# IPNE MVP2 実装計画（計画駆動）

## 概要

MVP1（自動生成迷路＋調査体験）の次段階として、
**敵・HP・最低限の戦闘** を実装する。
MVP2の目的は「危険がある中で探索する体験が成立するか」を判断することである。

TDDを前提に、**先にテスト → 最小実装 → 確認** を繰り返す。

---

## MVP2の本質

> **MVP2は「戦闘を面白くする」フェーズではない。**
> **危険がある中で探索する体験が成立するか** を検証するフェーズである。

技術的な実装完了ではなく、以下の体験が生まれているかが成功基準となる：

- 敵を見て「避けようか、戦おうか」と判断する
- HPを見て「引き返そうか」と考える
- ダメージを受けたときに緊張感がある
- 戦っても避けてもクリアできる

---

## 現状把握（MVP1からの継承）

- ページ構成: `src/pages/IpnePage.tsx`（タイトル→プロローグ→ゲーム→クリア）
- ロジック分離: `src/features/ipne/`
- 操作: WASD/矢印キー + モバイルD-pad（連続移動対応）
- 描画: Canvas ベース（ビューポート/カメラシステム）
- テスト: Jest + React Testing Library
- 迷路: BSPアルゴリズムによる自動生成（70x70タイル）
- マップ: 自動マッピング機能（小窓/全画面切替）

### MVP2での変更方針

- **既存のMVP1コードを拡張・改修**（新規ページ追加ではない）
- Player型を拡張してHP・向き・無敵時間を追加
- 新規モジュール追加: enemy.ts, combat.ts, item.ts
- ゲームループを拡張して敵AI・衝突判定を追加

---

## MVP2で新たに必要な要素

1. **プレイヤーHP システム**
   - 初期HP: 12
   - 自然回復なし
   - 回復アイテムで回復

2. **敵システム（3種類）**
   - 巡回型: 一定範囲を往復、発見で追跡
   - 突進型: 発見で一直線に接近、高火力
   - 逃走型: プレイヤーから距離を取る

3. **戦闘システム**
   - ワンボタン攻撃
   - 接触ダメージ
   - 無敵時間・ノックバック

4. **アイテムシステム**
   - 回復アイテム（小・大）

---

## フェーズ構成

### フェーズ0: 型定義・テスト準備（TDD起点）

- types.ts に新規型定義を追加（Player拡張、Enemy、Item、Combat）
- テストユーティリティの作成
- 既存テストが通ることを確認

### フェーズ1: プレイヤー拡張

- player.ts にHP・向き・無敵時間の機能を追加
- createPlayer関数の拡張
- ダメージ・回復関数の実装
- プレイヤー拡張のテスト追加

### フェーズ2: 敵基本システム

- enemy.ts 新規作成（敵生成・パラメータ管理）
- enemySpawner.ts 新規作成（Room配列から敵配置）
- 敵生成のテスト追加

### フェーズ3: 敵AI

- enemyAI.ts 新規作成
- 視認・追跡・追跡中断ロジック
- 巡回型AI（往復移動、発見で追跡）
- 突進型AI（直線接近）
- 逃走型AI（距離を取る）
- 敵AIのテスト追加

### フェーズ4: 戦闘システム

- combat.ts 新規作成
- プレイヤー攻撃（前方1タイル、クールタイム）
- 接触ダメージ処理
- ノックバック処理
- collision.ts に敵衝突判定を追加
- 戦闘システムのテスト追加

### フェーズ5: アイテムシステム

- item.ts 新規作成
- 回復アイテム生成・配置
- アイテム取得・効果適用
- アイテムのテスト追加

### フェーズ6: UI・演出

- IpnePage.tsx に敵・アイテム描画を追加
- HP表示UI
- 攻撃ボタン（D-pad中央）
- ダメージエフェクト（画面点滅、無敵時点滅）
- ゲームオーバー画面

### フェーズ7: 統合・バランス調整

- 敵配置数の調整（25体＋ボス1体）
- パラメータ微調整
- プレイ時間が5〜7分に収まるか確認
- `npm test` 実行で全体パスを確認

---

## 重要方針

- **既存のMVP1コードを拡張・改修**（新規ページ追加ではない）
- 変更はMVP2範囲に限定（レベルアップ・職業差・複雑なギミック等は入れない）
- 敵は「判断を迫る存在」として配置（理不尽な難易度は避ける）
- 戦っても避けてもクリアできるバランスを目指す
- **TDD優先**: 先にテスト → 実装 → リファクタ

---

## 完了条件

- [ ] 敵がマップ上に表示され、AIで動作する
- [ ] プレイヤーのHP表示がある
- [ ] 攻撃ボタンで敵を攻撃できる
- [ ] 敵との接触でダメージを受ける
- [ ] 回復アイテムでHPを回復できる
- [ ] HP0でゲームオーバー画面に遷移する
- [ ] ゴール到達でクリア（MVP1と同じ）
- [ ] 戦っても避けてもクリア可能
- [ ] 1プレイ5〜7分程度で完結する（要手動検証）
- [ ] テストが追加され `npm test` が通る

---

## MVP2 → MVP3 への判断基準

以下を満たしたら MVP3（レベルアップ・職業差・罠拡張）に進む。

- 戦闘が単調でない
- 敵配置に意味がある
- 次に「成長要素が欲しい」と感じる
