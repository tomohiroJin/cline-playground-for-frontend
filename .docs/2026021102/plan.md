# KEYS & ARMS src移植 計画（再発防止版）

## 1. 方針

- 方針は「再実装」ではなく「分割移植」。
- フェーズごとに元HTMLとの差分を可視化し、差分が残る場合は次フェーズへ進まない。
- 進捗判定は「作った量」ではなく「同等性」で行う。
- `iframe` 方式・元HTML直接実行方式には戻さない。

## 2. 成果物一覧

- `spec.md`: 制約・受け入れ基準
- `plan.md`: 実施順序・レビューゲート
- `tasks.md`: 実作業チェックリスト
- `source-map.md`: 元HTMLと移植先ファイルの対応表
- `parity-report.md`: 実装後の同等性評価

## 3. フェーズ計画

### Phase 0: 凍結ルールと分析

#### 成果物
- 移植対象ロジックの分解表（状態/入力/描画/音/保存）。
- 禁止事項の確認（新規設計禁止、簡略化禁止）。

#### 検証
- 元HTMLの主要状態・関数・定数が列挙されている。

#### 次フェーズ条件
- `source-map.md` の初版が作成済み。
- 主要状態/関数の TODO が 0 になっている。

### Phase 1: 骨組み作成（空実装禁止）

#### 成果物
- `src/features/keys-and-arms/` 構成を作成。
- `KeysAndArmsPage` は iframe を撤廃し `KeysAndArmsGame` を描画。
- ループ初期化/破棄、入力リスナー初期化/破棄を実装。

#### 検証
- ページ遷移時にエラー/リークがない。

#### 次フェーズ条件
- `KeysAndArmsPage.test.tsx` を更新済み。

### Phase 2: 状態遷移移植

#### 成果物
- `scene/stage/loop/score/hp` を元仕様で定義。
- `title -> cave -> grass -> boss -> ending` と `over` 分岐を移植。

#### 検証
- 状態遷移ユニットテストが通る。

#### 次フェーズ条件
- `update.ts` の遷移ロジックに TODO なし。

### Phase 3: 入力移植

#### 成果物
- キーボード + 仮想パッド + justPressed の移植。
- `touchcancel` / `blur` 解放を実装。

#### 検証
- 入力固着が再現しない。

#### 次フェーズ条件
- 手動確認ログを `parity-report.md` に記録。

### Phase 4: 描画・演出移植

#### 成果物
- 主要スプライト、背景、HUD、演出を段階移植。
- 描画順を元実装準拠に統一。

#### 検証
- 主要3シーン（cave/grass/boss）の見た目差分を比較。

#### 次フェーズ条件
- 許容外差分なし（または既知差分を明記）。

### Phase 5: 音・保存・導線

#### 成果物
- AudioContext のユーザー操作開始。
- BGM/SFX 実装。
- ハイスコア保存/復元・旧キー移行。
- `App` ルート・`GameListPage` 導線・テスト更新。

#### 検証
- ルート遷移と再訪時復元が確認できる。

#### 次フェーズ条件
- 関連テストすべて通過。

### Phase 6: 最終検証

#### 成果物
- `npm test` 実行結果。
- `npm run build` 実行結果。
- `parity-report.md` 最終版。

#### 完了条件
- `spec.md` の受け入れ基準を全充足。
- `rg -n \"iframe|games/keys-and-arms/index.html\" src/pages/KeysAndArmsPage.tsx src/features/keys-and-arms` の結果が 0 件。

## 4. レビューゲート（強制）

各Phase終了時に以下を必ず残す。

1. 実装したファイル一覧
2. 元HTMLとの対応箇所
3. 既知差分（あれば）
4. 次フェーズへ進んでよい理由
5. 禁止事項違反がない証拠（該当チェック結果）

上記が欠ける場合、Phase未完了。

## 5. リスクと回避

- リスク: 元ロジック理解不足による挙動劣化
  - 回避: 先に `source-map.md` を完成させる

- リスク: 進捗優先で簡略化が混入
  - 回避: 禁止事項違反のセルフチェックを毎Phase実施

- リスク: テストが同等性を担保しない
  - 回避: 状態遷移・進行条件・保存の期待値テストを追加

## 6. 実装者向け明示ルール（コンテキスト消失対策）

- この計画で最優先は「同等性」。
- わからない挙動は推測実装せず、元HTMLを読み直す。
- 仕様変更が必要なら、実装を止めて `spec.md` 変更提案を先に行う。
