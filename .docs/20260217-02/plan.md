# IPNE ゲームブラッシュアップ — 実装計画書

## 概要

プレイテストから得られた6つの改善要求を実装する。
各要件は独立性が高いが、バランス調整（要件3/4/5）はまとめてテスト・調整する必要がある。

---

## 改善要件一覧

| # | 要件 | カテゴリ | 変更規模 |
|---|------|---------|---------|
| 1 | STAGE表示の重なり修正 | UI/CSS | 小 |
| 2 | 主人公スプライト改善 | ビジュアル | 大 |
| 3 | 1ステージ3レベルアップ | バランス | 中 |
| 4 | 時間ベースHP回復（リジェネ） | 新機能/バランス | 中 |
| 5 | 最終ボス攻撃力低減 | バランス | 小 |
| 6 | ステージ別壁/床カラー | ビジュアル | 中 |

---

## 実装順序

**方針**: 単純→バランス→ビジュアル の順で安定性を確保

```
要件1（CSS修正）
  → 要件5（ボス調整）
    → 要件3（レベルアップ頻度）
      → 要件4（リジェネ）
        → 要件6（ステージカラー）
          → 要件2（スプライト改善）
```

### 順序の根拠

1. **要件1（STAGE表示修正）**: CSS1箇所のみ。最小リスクで開発環境の動作確認ができる
2. **要件5（ボス攻撃力低減）**: 数値2箇所の変更。バランス調整の起点
3. **要件3（レベルアップ頻度）**: テーブル書き換え＋maxLevel変更。要件5と合わせてバランスの基盤を作る
4. **要件4（リジェネ）**: 新機能追加。要件3/5のバランスが決まった上で回復量を調整
5. **要件6（ステージカラー）**: パレット追加＋描画パイプライン変更。ビジュアル系の先行実装
6. **要件2（スプライト改善）**: 最も工数が大きくリスクが高い。他の変更完了後に集中して取り組む

---

## 各要件の変更概要

### 要件1: STAGE表示の重なり修正

**問題**: `StageIndicator` が右上に配置されており、マップ切替ボタンと重なる
**解決**: タイマー（中央上部）の直下に移動

| ファイル | 変更内容 |
|---------|---------|
| `src/pages/IpnePage.styles.ts` | `StageIndicator` の CSS を変更（`top: 3rem`, `left: 50%`, `transform: translateX(-50%)`, `right` 削除） |

### 要件2: 主人公スプライト改善

**問題**: 歩行アニメーションが硬く、生き物らしさが不足
**解決**: 足の移動幅拡大、腕振り追加、ボビング効果、フレーム速度調整

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/presentation/sprites/playerSprites.ts` | 戦士・盗賊の歩行フレーム（walk1/walk2）を修正（4方向×2フレーム×2クラス = 16スプライト）、`frameDuration` 200→150ms |

### 要件3: 1ステージ3レベルアップ

**問題**: ステージ1のmaxLevelが11、レベル差8は成長感が薄い
**解決**: 各ステージでちょうど3レベルアップするようにKILL_COUNT_TABLEとmaxLevelを再設計

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/progression.ts` | `KILL_COUNT_TABLE` を全面改訂 |
| `src/features/ipne/stageConfig.ts` | 各ステージの `maxLevel` を変更（3/6/9/12/15） |
| `src/features/ipne/__tests__/progression.test.ts` | テーブル変更に合わせてテスト更新 |

### 要件4: 時間ベースHP回復（リジェネ）

**問題**: 回復手段がアイテム拾得のみで、HP管理がシビアすぎる
**解決**: 一定間隔で1HP自動回復する仕組みを追加

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/types.ts` | `Player` に `lastRegenAt` フィールド追加 |
| `src/features/ipne/application/engine/tickGameState.ts` | リジェネ処理を追加（8秒間隔、healBonusで短縮） |
| `src/features/ipne/presentation/hooks/useGameState.ts` | プレイヤー初期化に `lastRegenAt` 追加 |
| `src/features/ipne/presentation/hooks/useGameLoop.ts` | tickGameState に currentTime を渡していることを確認（既に渡している場合は変更不要） |

### 要件5: 最終ボス攻撃力低減

**問題**: Stage5のメガボスが実質12ダメージ（6×2.0）で即死レベル
**解決**: ベースダメージを6→4、Stage5のdamage scalingを2.0→1.8に変更（実効7ダメージ）

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/enemy.ts` | `MEGA_BOSS` の `damage` を 6 → 4 に変更 |
| `src/features/ipne/stageConfig.ts` | `STAGE_5` の `scaling.damage` を 2.0 → 1.8 に変更 |

### 要件6: ステージ別壁/床カラー

**問題**: 全ステージ同じ壁/床色で視覚的な進行感がない
**解決**: 5ステージ分の壁/床パレットを定義し、ステージに応じてパレットを切り替え

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/presentation/sprites/tileSprites.ts` | ステージ別パレット定義を追加、`getFloorSprite(stage)` / `getWallSprite(stage)` 関数を追加 |
| `src/features/ipne/presentation/screens/Game.tsx` | タイル描画時にステージ番号を参照してパレットを切り替え（`FLOOR_SPRITE` → `getFloorSprite(stage)` 等） |

---

## バランス調整のテスト指針

要件3/4/5はゲームバランスに直接影響するため、以下の観点でまとめてテストする。

### 数値検証

| 項目 | 期待値 |
|------|-------|
| 各ステージのレベルアップ回数 | ちょうど3回 |
| Stage5メガボスの実効ダメージ | 4 × 1.8 = 7.2 → 7（切り捨て） |
| リジェネ間隔（healBonus=0） | 8秒 |
| リジェネ間隔（healBonus=5） | 8 - 5×0.8 = 4秒（最短3秒なので4秒） |
| リジェネ回復量 | 常に1HP |

### プレイテスト観点

- [ ] Stage1〜5を通しプレイし、レベルアップが各ステージ3回発生することを確認
- [ ] Stage5のメガボスに殴られた時のダメージが7であることを確認
- [ ] リジェネが8秒間隔で1HP回復することを確認
- [ ] healBonusを上げるとリジェネ間隔が短くなることを確認
- [ ] 全体的な難易度が「やりごたえがあるが理不尽ではない」レベルであることを確認

---

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| スプライト改善（要件2）で表示崩れ | 中 | 全4方向×2クラスのビジュアル確認チェックリストを作成 |
| レベルアップ頻度変更でバランス崩壊 | 高 | 旧テーブルをコメントで残し、ロールバック可能にする |
| リジェネが強すぎてゲームが簡単になる | 中 | 回復量1HP固定、間隔を調整可能なパラメータとして定義 |
| ステージカラー変更で視認性低下 | 低 | 壁/床のコントラスト比を維持（明度差2段階以上） |
| MEGA_BOSS弱体化でStage5が簡単すぎる | 中 | HP据え置き（80）で耐久力は維持、必要なら速度で調整 |

---

## 作業見積り

| 要件 | ファイル数 | 新規テスト |
|------|----------|-----------|
| 1 | 1 | 0 |
| 2 | 1 | 0（目視確認） |
| 3 | 3 | テスト更新 |
| 4 | 3〜4 | 新規テスト |
| 5 | 2 | テスト更新 |
| 6 | 2 | 0（目視確認） |
