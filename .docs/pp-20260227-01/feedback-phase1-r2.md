# Phase 1 フィードバック Round 2 — 未修正項目の再報告

## 概要

Phase 1 フィードバック対応（FB-1, FB-2, FB-4, FB-6）コミット後、再度プレイテストを行った結果、
3項目が未修正または不十分であることが判明した。

前回の対応内容と今回の調査結果を併記し、正しい修正方針を示す。

---

## フィードバック項目

### FB-R2-1: 血の契約（HP半減）がまだ動作していない

- **優先度**: 🔴 すぐに対応
- **前回対応**: FB-4 として結合テスト8件を追加。テスト上は正しく動作していることを確認し「バグなし」と判断
- **再報告内容**: 実際のゲームプレイでHPが増減していない。テストでは正常だが、実行時に効果が反映されていない可能性がある
- **調査結果**:
  - `applyStatFx` の `half` 処理（`mhp = floor(mhp/2); hp = min(hp, mhp)`）は正しい
  - `applyEvo` → `writeSnapToRun` のデータフローにロジック上の問題はない
  - `deepCloneRun` のクローン処理も正常
  - `simEvo` のプレビュー表示も正しく計算される
  - **残る可能性**:
    1. `startBattle()` で `mhp` / `hp` が上書きされている可能性
    2. 骨ツリーの永続バフが `applyEvo` 後に再適用されて `mhp` を戻している可能性
    3. 画面遷移時に state が正しく伝播されていない可能性
    4. 進化選択後に `startBattle()` でステータスがリセットされる可能性
- **対応方針**:
  - `hooks.ts` の `SELECT_EVO` → `startBattle()` の実行パスを詳細に確認
  - `startBattle()` 内で `mhp` / `hp` を再設定していないかチェック
  - ブラウザの開発者ツールでランタイムの state 変化を追跡
  - バグ特定後、修正 + 回帰テスト追加

---

### FB-R2-2: 速度切り替えが進化選択画面で利用できない

- **優先度**: 🔴 すぐに対応
- **前回対応**: FB-1 として `START_RUN` での `battleSpd` リセットを除去。「セッション中のラン間で速度保持」を実現
- **再報告内容**: 進化選択画面（`phase === 'evo'`）で速度変更ができない。ユーザーが求めていたのは「進化選択中にも速度を変更できること」
- **調査結果**:
  - `SpeedBar` コンポーネントは `BattleScreen.tsx` にのみ存在
  - `EvolutionScreen.tsx` には速度切り替え UI がない
  - `PrimalPathGame.tsx` から `EvolutionScreen` に `battleSpd` props が渡されていない
  - `CHANGE_SPEED` reducer アクション自体は phase 非依存で動作する
- **対応方針**:
  - `EvolutionScreen` の props に `battleSpd: number` を追加
  - `PrimalPathGame.tsx` から `battleSpd` を渡す
  - `EvolutionScreen` に SpeedBar を追加（BattleScreen と同じ内容）
  - 可能であれば SpeedBar を共有コンポーネントに抽出してコード重複を削減

---

### FB-R2-3: スキルボタンの位置が戦闘中に移動して押しにくい

- **優先度**: 🔴 すぐに対応
- **前回対応**: FB-2 としてスキルボタンを拡大（font 10→13px, min-width 70→90px）、画面下部に移動、パルスアニメーション追加
- **再報告内容**: バトル中にスキルボタンの位置が上下にずれて押しづらい。戦闘中に押す場所が移動しない安定した位置で大きく目立たせてほしい
- **調査結果**:
  - `SkillBar` はドキュメントフロー内（flexbox の子要素）に配置されている
  - 以下の要素の高さが戦闘中に変動し、SkillBar の位置がずれる:
    1. `LogContainer`（ログ行追加に伴い max-height: 100px まで成長）
    2. `AllyList`（仲間の追加・死亡で行数変化）
    3. バフアイコン表示（`activeBuffs.length > 0` で条件表示）
    4. `Screen` コンテナの `overflow-y: auto` によるスクロール
  - `SkillBar` に固定位置指定（`position: fixed/sticky`）がなく、相対位置に依存
- **対応方針**:
  - `SkillBar` を `position: sticky; bottom: 0` または画面下部に固定配置
  - `Screen` のレイアウトを再設計し、上部（スクロール領域）と下部（固定領域：SkillBar）に分離
  - SkillBar の高さが常に確保されるようにする（条件表示をやめ、スキル未解放時は非活性表示）
  - ボタンサイズをさらに大きくし、タッチターゲット44px以上を確保

---

## 優先度まとめ

| 優先度 | 項目 | 作業規模 | 理由 |
|--------|------|---------|------|
| 🔴 すぐに | FB-R2-1: 血の契約HP半減 | 中〜大 | ゲームバランスに直結するバグの可能性。ランタイム調査が必要 |
| 🔴 すぐに | FB-R2-2: 速度切り替えUI追加 | 小〜中 | 前回の対応が不十分。UIの追加が必要 |
| 🔴 すぐに | FB-R2-3: スキルボタン固定配置 | 中 | 操作性に直結。レイアウト再設計が必要 |

---

## 対応方針

3項目すべて 🔴（すぐに対応）。前回の対応が根本解決に至っていなかったため、今回は以下の方針で進める:

1. **FB-R2-1** を最優先（バグの可能性が最も高い）
   - `startBattle()` のステータス初期化フローを重点調査
   - ランタイムデバッグで実際の state 変化を追跡
2. **FB-R2-2** は UI 追加のため比較的単純
   - SpeedBar の共有コンポーネント化を同時に実施
3. **FB-R2-3** はレイアウト再設計を伴うが、影響範囲は BattleScreen に限定
   - sticky/fixed レイアウトへの切り替え
