# 原始進化録 (PRIMAL PATH) ブラッシュアップ — 実装計画

## 1. コンテキスト

### 現状分析

原始進化録は自動戦闘ローグライトとして、以下の基盤が完成している:

- **アーキテクチャ**: 純粋関数（game-logic.ts）+ useReducer + styled-components の堅牢な設計
- **ゲームシステム**: 3文明 × 3バイオーム × 4難易度 × 文明ツリー × 覚醒
- **テスト**: 49テスト（ロジック層44 + ストレージ5）全パス
- **ファイル構成**: 25+ ファイル、関心の分離が徹底されている

### なぜブラッシュアップが必要か

| 課題 | 詳細 |
|------|------|
| **プレイヤーの能動性が低い** | 自動戦闘のため、進化カード選択以外にプレイヤーの介入機会がない |
| **ランの同質化** | 24種の進化カードはあるが、シナジー不在のため「強い進化を取る」一辺倒になりやすい |
| **フィードバック不足** | 戦闘はテキストログ中心で、視覚・聴覚的な手応えが薄い |
| **リプレイ動機の欠如** | 文明ツリー完成後に目標がなくなる。ラン毎の統計や実績がない |
| **コンテンツの限界** | 敵12体 + ボス6体のみ。ランダムイベントや特殊遭遇がない |
| **初見の壁** | 文明システムや覚醒条件が複雑だが、ゲーム内の導線が弱い |

### コンセプト

**「自分だけの進化の道を、何度でも、手応えある戦闘と共に」**

キーワード: シナジービルド × アクティブスキル × ランダムイベント × 実績 × ビジュアル強化

---

## 2. 実装フェーズ

### Phase 1: 戦闘体験の向上（Battle Experience）

バトルの「見た目」と「手応え」を強化し、自動戦闘でも観戦の楽しさを生む。

| # | 項目 | 概要 |
|---|------|------|
| 1-1 | ダメージ数値ポップアップ | 攻撃時にダメージ数値を Canvas 上にアニメーション表示。会心は大きく、回復は緑色で表示 |
| 1-2 | バトルエフェクト強化 | 攻撃ヒット時のフラッシュ、火傷のパーティクル、覚醒時の全画面エフェクト。CSS keyframes + Canvas 描画の組み合わせ |
| 1-3 | アクティブスキルシステム | プレイヤーが任意タイミングで発動できるスキルを追加。文明レベルに応じてスキルが解放される。1バトルにつき各スキル1回使用可能 |
| 1-4 | 戦闘速度UI改善 | 速度切替ボタンのビジュアル化（×1/×2/×4/×8）+ 一時停止機能の追加 |
| 1-5 | 敵HP/状態表示の改善 | 敵のHPバーをスプライト下部に表示。状態異常（火傷等）のアイコン表示 |

### Phase 2: 進化シナジーシステム（Evolution Synergy）

ビルドの多様性を高め、「どの進化を組み合わせるか」という戦略的楽しさを追加。

| # | 項目 | 概要 |
|---|------|------|
| 2-1 | シナジータグシステム | 各進化に1〜2個のタグ（火, 氷, 再生, 盾, 狩り, 霊 等）を付与。同一タグの進化を複数取得するとシナジーボーナスが発動 |
| 2-2 | シナジーボーナス定義 | タグ2個: 小ボーナス（ATK+5%等）、タグ3個: 大ボーナス（火傷ダメージ2倍等）。各タグに固有のボーナスを定義 |
| 2-3 | シナジー表示UI | 進化選択画面で現在のシナジー状況を表示。発動中のシナジーはバトル画面にもアイコンで表示 |
| 2-4 | 進化カード追加（6種） | シナジーを活かすための新進化カード。既存24種 + 新規6種 = 30種 |

### Phase 3: ランダムイベントシステム（Random Events）

ラン毎の体験にバリエーションを加え、「次に何が起こるか」の期待感を創出。

| # | 項目 | 概要 |
|---|------|------|
| 3-1 | イベントエンジン | バトル後に一定確率（20%）でランダムイベントが発生。イベントは2〜3択の選択肢で構成 |
| 3-2 | 基本イベント（8種） | 骨の商人、古代の祠、迷い仲間、毒沼、謎の化石、獣の巣穴、星降る夜、古代の壁画 |
| 3-3 | イベントUI | イベント画面コンポーネント + イベント説明テキスト + 選択肢ボタン + 結果表示 |
| 3-4 | バイオーム固有イベント | 各バイオームで出現するイベントに偏りを持たせる（氷河→氷系イベント等） |

### Phase 4: メタ進行と実績（Meta Progression & Achievements）

長期プレイのモチベーションを維持する仕組み。

| # | 項目 | 概要 |
|---|------|------|
| 4-1 | ラン統計システム | 各ランの結果（クリア/死亡、バイオーム到達数、撃破敵数、最大ダメージ等）を記録・閲覧可能に |
| 4-2 | 実績システム（15個） | 初クリア、全難易度クリア、全覚醒達成、最短クリア等のマイルストーン実績 |
| 4-3 | 称号システム | 実績解除に応じてタイトル画面で称号を表示。プレイヤーの成長の可視化 |
| 4-4 | チャレンジモード | 特殊ルール付きのラン（初期HP半分、進化制限、タイムアタック等）。3種のチャレンジを追加 |

### Phase 5: ビジュアル・サウンド強化（Visual & Audio Polish）

没入感と完成度を高める。

| # | 項目 | 概要 |
|---|------|------|
| 5-1 | BGM システム | バイオームごとに異なるBGM（Web Audio API による合成音楽）。タイトル画面用BGMも追加 |
| 5-2 | SFX の拡充 | 現行8種 → 15種に拡充。シナジー発動音、イベント発生音、実績解除音等を追加 |
| 5-3 | スプライトのバリエーション | 覚醒段階に応じたプレイヤースプライトの変化。進化取得によるビジュアルエフェクトの追加 |
| 5-4 | 背景演出 | バイオームごとの背景グラデーション変化。天候エフェクト（雪、火の粉等）を CSS パーティクルで実装 |

### Phase 6: テスト・品質保証（Testing & QA）

ブラッシュアップに伴うテストの拡充と品質担保。

| # | 項目 | 概要 |
|---|------|------|
| 6-1 | 新規ロジックのユニットテスト | シナジー計算、イベント判定、実績判定、アクティブスキル効果のテスト |
| 6-2 | コンポーネントテスト | 主要画面（BattleScreen, EvolutionScreen, EventScreen）の描画テスト |
| 6-3 | バランステスト | 全難易度×全文明×全バイオームでのクリア可能性検証。シナジーの極端な組み合わせチェック |
| 6-4 | モバイル動作確認 | iOS Safari / Android Chrome での動作検証。タッチ操作の確認 |

### Phase 7: ドキュメント更新（Documentation）

実装内容と各ドキュメントの整合性を保証する。各 Phase 実装時に段階的に更新し、最終 Phase で総点検する。

| # | 項目 | 概要 |
|---|------|------|
| 7-1 | Feature README 更新 | `src/features/primal-path/README.md` — ファイル構成（新規4コンポーネント追加）、ゲームシステム（シナジー、イベント、実績、チャレンジ、スキル）、操作方法（スキルボタン操作）を反映 |
| 7-2 | ルート README 更新 | `README.md` — ゲーム一覧テーブルの説明文更新、テスト数の更新（49 → 80+） |
| 7-3 | GameListPage 説明文更新 | `src/pages/GameListPage.tsx` — カード上のゲーム説明文を新機能（シナジー、イベント、実績、チャレンジ）を反映した内容に更新 |
| 7-4 | コード内 JSDoc / コメント整備 | 新規関数・新規ファイルに日本語 JSDoc を付与。既存関数で振る舞いが変わったものはコメントを更新 |
| 7-5 | 計画ドキュメント最終更新 | `.docs/pp-20260227-01/` — 実装中の変更・差分を plan.md / spec.md / tasks.md に反映。除外した機能・追加した機能を正確に記録 |
| 7-6 | 遊び方テキスト更新 | `components/HowToPlayScreen.tsx` — ゲーム内「遊び方」画面にシナジー、イベント、スキルの説明を追加 |

---

## 3. 実装順序と依存関係

```
Phase 1（戦闘体験）:
  1-1 ダメージポップ ──→ 1-2 エフェクト強化 ──→ 1-5 敵HP表示
  1-3 アクティブスキル（独立）
  1-4 速度UI改善（独立）

Phase 2（シナジー）── Phase 1-2 完了後に着手:
  2-1 タグシステム ──→ 2-2 ボーナス定義 ──→ 2-3 表示UI
  2-4 進化追加 ←── 2-2 完了後

Phase 3（イベント）── Phase 1 完了後に着手:
  3-1 エンジン ──→ 3-2 イベント定義 ──→ 3-3 UI ──→ 3-4 バイオーム固有

Phase 4（メタ進行）── Phase 2, 3 完了後に着手:
  4-1 ラン統計 ──→ 4-2 実績 ──→ 4-3 称号
  4-4 チャレンジ ←── 4-1 完了後

Phase 5（ビジュアル）── 各Phase と並行可能:
  5-1 BGM（独立）
  5-2 SFX（独立）
  5-3 スプライト ←── Phase 2 完了後（覚醒段階の把握が必要）
  5-4 背景演出 ←── Phase 3 完了後（バイオーム演出との連携）

Phase 6（テスト）── 各Phase 完了時に随時実行:
  6-1, 6-2 は各Phase 実装と並行
  6-3, 6-4 は全Phase 完了後

Phase 7（ドキュメント）── 各Phase 完了時 + 全体完了後:
  7-4 JSDoc は各Phase 実装と同時に記述
  7-6 遊び方テキストは Phase 3 完了後に着手
  7-1, 7-2, 7-3 は全Phase 完了後にまとめて更新
  7-5 計画ドキュメントは全Phase 完了後の最終更新
```

### 依存関係サマリー

| タスク | 依存先 | 理由 |
|--------|--------|------|
| Phase 2 全般 | 1-2 完了 | エフェクトシステムをシナジー発動演出に共用 |
| Phase 3 全般 | Phase 1 完了 | バトルフロー変更後にイベント挿入ポイントを確定 |
| Phase 4 全般 | Phase 2, 3 完了 | 実績条件にシナジーやイベントの要素を含む |
| 5-3 スプライト | Phase 2 | 覚醒段階のビジュアル反映 |
| 5-4 背景演出 | Phase 3 | バイオームイベント演出との連携 |
| 6-3 バランス | 全Phase | 全機能を含めた総合バランス調整 |
| 7-6 遊び方テキスト | Phase 3 | イベント・シナジー・スキルの説明が必要 |
| 7-1, 7-2, 7-3 | 全Phase | 実装内容が確定してから記述 |
| 7-5 計画ドキュメント | 全Phase | 最終的な差分を反映 |

---

## 4. 主要ファイル変更計画

### 4.1 既存ファイルの変更

| ファイル | 変更内容 |
|----------|----------|
| `types.ts` | `ActiveSkill`, `SynergyTag`, `SynergyBonus`, `RandomEvent`, `EventChoice`, `RunStats`, `Achievement`, `Challenge` 型を追加 |
| `constants.ts` | シナジータグ定義、シナジーボーナス定義、ランダムイベント定義、実績定義、チャレンジ定義、新規進化6種、新規SFX定義を追加 |
| `game-logic.ts` | `calcSynergyBonuses()`, `applyActiveSkill()`, `rollEvent()`, `applyEventChoice()`, `calcRunStats()`, `checkAchievements()` 関数を追加 |
| `hooks.ts` | `gameReducer` にイベント/スキル/チャレンジ関連のアクションを追加。`useBattle` にスキル発動ロジック追加 |
| `styles.ts` | ダメージポップアップ、パーティクル、背景グラデーション、天候エフェクトのキーフレーム追加 |
| `sprites.ts` | ダメージ数値描画関数、敵HPバー描画関数、覚醒段階スプライト変化、天候パーティクル描画関数を追加 |
| `audio.ts` | 新規SFX定義7種（シナジー発動、イベント発生、スキル発動、実績解除、チャレンジ開始、天候SE、BGMベース）を追加 |
| `storage.ts` | `RunStats[]`, `Achievement[]` の保存/読込を追加 |
| `PrimalPathGame.tsx` | `event` フェーズの分岐追加、チャレンジモード起動フロー追加 |
| `components/BattleScreen.tsx` | ダメージポップアップ表示、アクティブスキルボタン、敵HPバー、シナジーアイコン、背景演出を追加 |
| `components/EvolutionScreen.tsx` | シナジー表示UI（現在のタグ数、次のシナジーまでの進捗）を追加 |
| `components/TitleScreen.tsx` | 実績・統計・チャレンジメニューボタンを追加 |
| `components/GameOverScreen.tsx` | ラン統計サマリー表示、実績解除通知を追加 |
| `components/HowToPlayScreen.tsx` | シナジー、イベント、アクティブスキルの説明を追加 |
| `src/features/primal-path/README.md` | ファイル構成、ゲームシステム、操作方法を新機能に合わせて更新 |
| `README.md`（ルート） | ゲーム一覧テーブルの説明文更新、テスト数の更新 |
| `src/pages/GameListPage.tsx` | ゲーム説明文を新機能を反映した内容に更新 |

### 4.2 新規作成ファイル

| ファイル | 内容 |
|----------|------|
| `components/EventScreen.tsx` | ランダムイベント画面コンポーネント |
| `components/StatsScreen.tsx` | ラン統計閲覧画面コンポーネント |
| `components/AchievementScreen.tsx` | 実績一覧画面コンポーネント |
| `components/ChallengeScreen.tsx` | チャレンジモード選択画面コンポーネント |
| `__tests__/synergy.test.ts` | シナジー計算のユニットテスト |
| `__tests__/events.test.ts` | イベント判定のユニットテスト |
| `__tests__/achievements.test.ts` | 実績判定のユニットテスト |
| `__tests__/active-skills.test.ts` | アクティブスキル効果のユニットテスト |

---

## 5. 技術的リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| **シナジーシステムによるバランス崩壊** | 高 | シナジーボーナスは控えめに設定（ATK+5〜10%程度）。3タグ揃った場合も上限を設ける。バランステスト必須 |
| **Canvas ダメージポップアップの描画負荷** | 中 | ポップアップ数を同時最大5個に制限。表示後1秒でフェードアウト。requestAnimationFrame は使用せず tick 同期で描画 |
| **アクティブスキルによるゲームテンポの乱れ** | 中 | スキル発動は自動戦闘を一時停止せず、即時効果で適用。ボタンは小さく邪魔にならない配置 |
| **イベント数の不足による単調さ** | 中 | 初期リリースで8種は最低限。バイオーム固有で体感的なバリエーションを確保。将来の追加を容易にするデータ駆動設計 |
| **localStorage の容量制限** | 低 | ラン統計は最新50件のみ保持。古いデータは自動削除。5MB制限内に収まるよう監視 |
| **BGM の自動再生制限** | 高 | ユーザー操作（ゲーム開始ボタン）で AudioContext を初期化。初期化前は BGM UI を無効化。再開ロジックも実装 |
| **既存テストのリグレッション** | 中 | 各Phase の実装前に既存49テストが全パスすることを確認。RNG注入パターンを維持し新機能もテスタブルに |

---

## 6. 検証手順

### Phase 1 完了時
- [ ] ダメージ数値が攻撃時に Canvas 上にポップアップ表示されること
- [ ] 会心ダメージが通常より大きく・赤色で表示されること
- [ ] 回復が緑色で表示されること
- [ ] 火傷のパーティクルが表示されること
- [ ] アクティブスキルが文明レベルに応じて解放されること
- [ ] スキルボタンが戦闘中に表示され、タップで発動すること
- [ ] 速度切替がビジュアル的にわかりやすいこと
- [ ] 一時停止機能が動作すること
- [ ] 敵HPバーがスプライト下部に表示されること
- [ ] 既存49テスト + 新規テストが全パスすること

### Phase 2 完了時
- [ ] 進化カードにシナジータグが表示されること
- [ ] 同タグ2個取得でシナジーボーナスが発動すること
- [ ] 同タグ3個取得で大ボーナスが発動すること
- [ ] シナジー表示UIで現在の状況が確認できること
- [ ] バトル画面にシナジーアイコンが表示されること
- [ ] 新規進化カード6種が正常に選出・適用されること
- [ ] シナジーボーナスがダメージ計算に正しく反映されること

### Phase 3 完了時
- [ ] バトル後に一定確率でイベントが発生すること
- [ ] イベント画面が表示され、選択肢が機能すること
- [ ] 選択結果がステータスに反映されること
- [ ] バイオームごとに出現イベントに偏りがあること
- [ ] 全8種のイベントが正しく動作すること

### Phase 4 完了時
- [ ] ラン終了時に統計が記録されること
- [ ] 統計閲覧画面で過去のランを確認できること
- [ ] 実績条件を満たした時に解除通知が表示されること
- [ ] 実績一覧画面で解除状況を確認できること
- [ ] チャレンジモードが選択・開始できること
- [ ] チャレンジルールがランに正しく適用されること

### Phase 5 完了時
- [ ] バイオームごとに異なるBGMが再生されること
- [ ] BGM/SFX の音量調整が機能すること
- [ ] 覚醒段階に応じてスプライトが変化すること
- [ ] バイオーム背景が適切に表示されること
- [ ] 天候エフェクトが表示されること

### Phase 6 完了時
- [ ] 全テストがパスすること（目標: 80テスト以上）
- [ ] 全難易度×全文明でクリア可能であること
- [ ] iOS Safari / Android Chrome で正常動作すること
- [ ] `npm run build` がエラーなしで成功すること

### Phase 7 完了時（ドキュメント）
- [ ] `src/features/primal-path/README.md` のファイル構成に新規4コンポーネントが記載されていること
- [ ] `src/features/primal-path/README.md` のゲームシステムにシナジー・イベント・実績・チャレンジ・スキルが記載されていること
- [ ] `README.md`（ルート）のテスト数が実際の数と一致すること
- [ ] `README.md`（ルート）のゲーム説明が新機能を反映していること
- [ ] `GameListPage.tsx` のゲーム説明文が新機能を反映していること
- [ ] `HowToPlayScreen.tsx` にシナジー・イベント・スキルの説明が含まれていること
- [ ] 新規関数・新規ファイルに日本語 JSDoc が付与されていること
- [ ] `.docs/pp-20260227-01/` の plan.md / spec.md / tasks.md が最終実装と整合していること
- [ ] コード内コメントが変更内容を正しく反映していること

---

## 7. 変更しないもの

以下は本ブラッシュアップの対象外とし、現行のまま維持する:

- `useReducer` による中央ステート管理パターン
- 純粋関数（game-logic.ts）による戦闘ロジック設計
- Canvas によるピクセルアートスプライト描画
- styled-components によるスタイリング
- localStorage による永続化（キー: `primal-path-v7`）
- 480×720px のゲーム表示領域サイズ
- 基本的な文明システム（技術/生活/儀式の3分類）
- 文明ツリーの構造（8ティア × 3文明）
- 既存の覚醒システムの仕組み
- Design by Contract パターン（contracts.tsx）
- Labyrinth Echo パターン準拠のファイル構成

---

## 8. 成功指標

| 指標 | 目標 |
|------|------|
| テスト数 | 80テスト以上（現行49 → +31以上） |
| テストカバレッジ（ロジック層） | 90%以上 |
| 進化カード数 | 30種（現行24 + 新規6） |
| ランダムイベント数 | 8種 |
| 実績数 | 15個 |
| チャレンジ数 | 3種 |
| SFX数 | 15種（現行8 + 新規7） |
| ビルドエラー | 0 |
| リグレッション | 0（既存テスト全パス維持） |
| ドキュメント整合性 | 全ドキュメントが実装と一致（差分0） |
| JSDoc カバレッジ（新規関数） | 100%（全新規 export 関数に JSDoc） |

---

## 9. 実装ノート（計画からの変更点）

実装中に計画から変更・追加・除外した事項を記録する。

### 9.1 変更した設計判断

| 項目 | 計画時 | 実装結果 | 理由 |
|------|--------|----------|------|
| 型名の省略 | `ActiveSkillId`, `SkillEffect`, `SkillState`, `ActiveBuff`, `DamagePopup` | `ASkillId`, `SkillFx`, `SkillSt`, `ABuff`, `DmgPopup` | 既存コードの省略記法（`CivType` → `CivType` は例外だが、`n`, `d`, `t` 等）との一貫性を保つため |
| 関数名 | `applyActiveSkill()`, `calcSynergyBonuses()` | `applySkill()`, `applySynergyBonuses()` | 簡潔さを優先 |
| イベント発生確率 | `EVENT_CHANCE = 0.2`（20%） | `EVENT_CHANCE = 0.3`（30%） | プレイテストでイベント遭遇頻度が低すぎたため調整 |
| イベント最小バトル数 | `EVENT_MIN_BATTLES = 2` | `EVENT_MIN_BATTLES = 1` | より早期にイベントを体験できるよう調整 |
| テスト数目標 | 80テスト以上 | 329テスト（12スイート） | TDD アプローチにより大幅超過達成 |

### 9.2 追加した機能

| 追加機能 | 説明 |
|---------|------|
| `situationText` フィールド | `RandomEventDef` に状況説明テキストを追加。プレイヤーがイベントの文脈を理解しやすくした |
| `hp_damage` コスト型 | `EventCost` に HP ダメージコストを追加。骨以外のコストでリスク・リターンを表現 |
| `dominantCiv()` | 最もレベルの高い文明タイプを返すユーティリティ関数 |
| `getEffectHintColor()` / `getEffectHintIcon()` | イベント効果のヒント色・アイコンを返す UI ヘルパー関数 |
| `formatEventResult()` / `computeEventResult()` | イベント結果の事前計算・メッセージ生成（FB-P3 フィードバック対応） |
| `getAwakeningVisual()` | 覚醒段階のビジュアル情報を返す関数（Phase 5） |
| 音量 localStorage 永続化 | SFX/BGM の音量設定をセッション間で保持 |
| バイオーム固有イベント重み付け | バイオームアフィニティ一致時に出現確率2倍（重複追加方式） |

### 9.3 除外した機能

| 除外機能 | 計画での記載 | 除外理由 |
|---------|-------------|---------|
| 称号システム（4-3） | 実績解除に応じたタイトル画面での称号表示 | Phase 4 のスコープを限定するため。実績システムで十分なプレイヤー報酬を実現 |
| 天候エフェクト（5-4） | 雪・火の粉等の CSS パーティクル | Phase 5 のスコープを限定。バイオーム背景で十分な雰囲気を表現 |
| `drawBiomeBg()` / `drawTimerBar()` | spec.md で言及 | CSS/styled-components で実装したため Canvas 描画関数としては不要 |
