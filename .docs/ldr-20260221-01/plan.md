# LAP DRAFT RACING ブラッシュアップ 開発計画書

> 文書ID: LDR-20260221-01
> 作成日: 2026-02-21
> ステータス: ドラフト

---

## 1. プロジェクト概要

### 1.1 現状分析

現行の Racing Game は、Canvas 2D ベースのトップダウン型レーシングゲームとして以下の基本機能を備えている。

| 機能 | 状態 | 関連ファイル |
|------|------|------------|
| 6コース（Forest / City / Mountain / Beach / Night / Snow） | 実装済み | `constants.ts` |
| 2P ローカル対戦 | 実装済み | `RacingGame.tsx` |
| CPU 対戦（3難易度: skill 0.25/0.5/1.0） | 実装済み | `game-logic.ts` |
| 速度設定（3段階: 2.2/3.2/4.5） | 実装済み | `constants.ts` |
| 周回設定（1 / 3 / 5 周） | 実装済み | `constants.ts` |
| ラップタイム記録・ベストタイム保存 | 実装済み | `RacingGame.tsx` |
| エフェクト（パーティクル / スパーク / コンフェッティ / 花火） | 実装済み | `renderer.ts`, `entities.ts` |
| Web Audio API サウンドエンジン（8種 SFX + エンジン音） | 実装済み | `audio.ts` |
| デモモード（8秒アイドルで自動開始） | 実装済み | `hooks.ts` |
| タッチ操作対応 | 実装済み | `hooks.ts` |
| 音量コントロール UI | 実装済み | `components/VolumeControl.tsx` |

### 1.2 課題

1. **リプレイ性の不足** — 毎回同じ体験になり「次も遊ぶ理由」が弱い
2. **SNS 映えの欠如** — シェアしたくなるハイライトやリプレイ機能がない
3. **コミュニティ化の弱さ** — ランキングや対戦要素が限定的
4. **操作感の改善余地** — ドリフトがない、壁に引っかかるストレス（`wallStuck` → 完全停止）、コースごとの個性が薄い

### 1.3 目的

「LAP DRAFT RACING」として、以下を導入し人気タイトルへ押し上げる:

- **ドラフトカード** — ラップごとのカード選択によるローグライト的展開
- **ゴースト & ハイライト** — 過去の走りとの比較、名場面の自動検出
- **操作感改善** — ドリフト / HEAT（ニアミスボーナス） / 壁改善 / コース個性化

---

## 2. フェーズ全体像

```
フェーズ0        フェーズ1          フェーズ2            フェーズ3
操作感改善  →   コア体験     →   継続とコミュニティ  →   拡張
(2-3週間)       (3-4週間)         (2-3週間)             (2-3週間)
```

### フェーズ0: 操作感改善

ゲームの基盤となる操作感を強化し、プレイ体験を向上させる。

| 項目 | 概要 |
|------|------|
| ドリフト | ハンドブレーキ操作による角度変化・速度維持・ブースト |
| HEAT（ニアミスボーナス） | 壁/対戦車への接近でゲージ蓄積、ブースト発動 |
| 壁ヒットペナルティ改善 | 完全停止 → スライドベクトル + 段階的減速 |
| コース個性化 | 6コースに固有の環境効果（砂利、雨、氷など） |

### フェーズ1: コア体験

リプレイ性とゲーム深度を飛躍的に高めるコアメカニクスを導入する。

| 項目 | 概要 |
|------|------|
| ドラフトカード | 15種カード × ラップごと3択 → ローグライト的ビルド |
| ゴースト | 自己ベスト走行軌跡を半透明再生 |
| ハイライト | 6種イベント自動検出（ドリフト、HEAT、逆転など） |

### フェーズ2: 継続とコミュニティ

デイリーチャレンジやランキングでプレイヤーの定着を促す。

| 項目 | 概要 |
|------|------|
| デイリーチャレンジ | 日替わりコース + 固定カードセットで全員同条件 |
| ランキング | タイム/スコアのリーダーボード |
| 共有強化 | ハイライトクリップの SNS シェア |

### フェーズ3: 拡張

ゲームの多様性と長期的な遊びの幅を広げる。

| 項目 | 概要 |
|------|------|
| ウィークリーイベント | 特殊ルール戦（カード制限、逆走、ハンデなど） |
| コスメティック | 車体カラー/エフェクトのアンロック |
| オンライン対戦 | WebSocket ベースのリアルタイム対戦 |

---

## 3. ファイル影響分析

### 3.1 既存ファイルの変更

| ファイル | 現行行数 | 変更内容 | 影響度 |
|---------|---------|---------|--------|
| `RacingGame.tsx` | ~648行 | 状態遷移に `'draft'` 追加、ゲームループにドリフト/HEAT/ゴースト統合、カード UI 組込み | 大 |
| `game-logic.ts` | ~109行 | `movePlayer()` にドリフト・HEAT・壁改善ロジック統合、カード効果適用 | 大 |
| `types.ts` | ~70行 | 新規型定義追加（DriftState, HeatState, Card, GhostFrame 等） | 中 |
| `constants.ts` | ~239行 | ドリフト/HEAT/壁/カードパラメータ追加、コース環境効果定義 | 中 |
| `renderer.ts` | ~306行 | ドリフトエフェクト、HEAT ゲージ、ゴースト描画、ハイライト通知描画 | 大 |
| `entities.ts` | ~66行 | ドリフトスモーク、HEAT パーティクル等の新エンティティ | 小 |
| `audio.ts` | ~175行 | ドリフト音、HEAT ブースト音、カード選択音、ハイライト通知音 | 中 |
| `hooks.ts` | ~75行 | ハンドブレーキ入力（Space/Shift）の追加 | 小 |
| `track.ts` | ~67行 | 壁法線ベクトル計算の追加（`getNormal()` メソッド） | 小 |

### 3.2 新規作成ファイル

| ファイル | 概要 | 推定行数 |
|---------|------|---------|
| `drift.ts` | ドリフト物理計算（角速度、スリップ、ブースト） | ~120行 |
| `heat.ts` | ニアミスボーナス HEAT 計算（距離判定、ゲージ蓄積） | ~80行 |
| `course-effects.ts` | コース環境効果（摩擦係数、視界、天候エフェクト） | ~100行 |
| `draft-cards.ts` | カードデータ定義・デッキ管理・効果適用 | ~250行 |
| `ghost.ts` | ゴースト記録・再生・localStorage 保存 | ~150行 |
| `highlight.ts` | ハイライトイベント検出・集計 | ~120行 |
| `components/DraftCardUI.tsx` | ドラフトカード選択 UI コンポーネント | ~200行 |
| `components/GhostToggle.tsx` | ゴースト ON/OFF トグル UI | ~50行 |

### 3.3 変更なしのファイル

| ファイル | 理由 |
|---------|------|
| `utils.ts` (37行) | `clamp`, `normalizeAngle`, `dist` 等はそのまま活用 |
| `index.ts` (13行) | 新規モジュールの re-export 追加のみ（軽微） |

---

## 4. フェーズ0+1 詳細実装ステップ

### ステップ1: 型定義とパラメータ追加

- `types.ts` に `DriftState`, `HeatState`, `CourseEffect`, `Card`, `GhostFrame`, `HighlightEvent` を追加
- `constants.ts` にドリフト/HEAT/壁/カードの定数パラメータを追加
- `Player` インターフェースを拡張（`drift`, `heat`, `activeCards` フィールド追加）
- `hooks.ts` にハンドブレーキ入力（Space / Shift）のキー追跡を追加

### ステップ2: ドリフトシステム実装

- `drift.ts` を新規作成
  - ドリフト発動条件（ハンドブレーキ + `speed >= 0.4`）
  - 角速度オーバーステア計算（`Config.game.turnRate` の倍率適用）
  - スリップ率による速度維持
  - ドリフト終了時ブースト
- `game-logic.ts` の `movePlayer()` にドリフト処理を統合

### ステップ3: HEAT システム実装

- `heat.ts` を新規作成
  - `Track.getInfo()` を活用した壁距離計算
  - `Utils.dist()` を活用した対戦車距離計算
  - ゲージ蓄積ロジック（距離反比例、自然減衰）
  - ブースト発動処理（ゲージ MAX 時）
- `renderer.ts` に HEAT ゲージ UI を追加

### ステップ4: 壁ヒットペナルティ改善

- `track.ts` に壁法線ベクトル計算 `getNormal()` を追加
- `game-logic.ts` の `movePlayer()` 内の壁判定ロジックを改修
  - 完全停止（`speed = 0`） → スライドベクトル方式に変更
  - 段階的減速（`wallStuck` 値に応じた3段階）
  - `Config.game.wallWarpThreshold` の調整

### ステップ5: コース個性化

- `course-effects.ts` を新規作成
  - `Courses` の `deco` プロパティに対応する環境効果定義
  - `applyEffect()` 関数で毎フレームの物理影響を適用
- `constants.ts` の各 `Course` に `effect` プロパティを追加

### ステップ6: ドラフトカードシステム実装

- `draft-cards.ts` を新規作成
  - 15枚のカードデータ定義
  - デッキシャッフル・3枚ドロー・選択・効果適用
- `components/DraftCardUI.tsx` を新規作成
  - 3択カード表示・選択アニメーション
- `RacingGame.tsx` の状態遷移に `'draft'` を追加
  - `race` → `draft` → `race` の繰り返し（最終ラップ以外）

### ステップ7: ゴーストシステム実装

- `ghost.ts` を新規作成
  - 毎フレームの位置・角度記録（3フレームに1回）
  - 再生（フレーム補間、`Utils.normalizeAngle()` 活用）
  - localStorage への保存/読込（既存の `bests` 保存パターンを踏襲）
- `components/GhostToggle.tsx` を新規作成
- `renderer.ts` に `Render.kart()` を活用したゴースト描画を追加

### ステップ8: ハイライトシステム実装

- `highlight.ts` を新規作成
  - 6種イベント検出: ドリフトボーナス、HEAT ブースト、ニアミス回避、逆転、ファステストラップ、フォトフィニッシュ
  - イベント発生時の通知データ生成
- `renderer.ts` にハイライト通知バナー描画を追加
- `RacingGame.tsx` の結果画面（`state === 'result'`）にハイライトサマリーを表示

### ステップ9: エフェクト・サウンド統合

- `entities.ts` にドリフトスモーク、HEAT パーティクル等を追加
- `renderer.ts` に全エフェクトの描画処理を統合
- `audio.ts` にドリフト音、HEAT ブースト音、カード選択音等を追加
- 全体のバランス調整・パフォーマンスチューニング

---

## 5. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| パフォーマンス低下 | ドリフトエフェクト + ゴースト + HEAT で描画負荷増大 | `Config.game.maxParticles` (200) / `maxSparks` (100) を維持、オブジェクトプール使用 |
| 状態遷移の複雑化 | `draft` 状態追加で既存の `menu→countdown→race→result` フローが崩れる | 状態遷移図を明確化、ユニットテストで各遷移をカバー |
| カードバランス崩壊 | 特定カードの組み合わせが圧倒的に強い | カード効果に上限値設定、相互打消しルール、テストプレイ重視 |
| localStorage 容量 | ゴーストデータが肥大化（既存の `bests` データとの共存） | フレーム間引き（3フレームに1回記録）、古いデータの自動削除 |
| 壁改善による意図しない挙動 | スライドベクトル方式でコースショートカットが可能に | スライド方向をトラック法線に制限、`Logic.updateCheckpoints()` 必須通過を維持 |
| 2P 対戦時のカード UI | 2人同時にカード選択する UI の設計が複雑 | 順番選択（P1 → P2）方式を採用、タイマー付き |

---

## 付録: 技術スタック（変更なし）

- **フレームワーク**: React 19 + TypeScript
- **状態管理**: React hooks（useState / useRef / useCallback）
- **描画**: Canvas 2D + requestAnimationFrame
- **音声**: Web Audio API（`SoundEngine` シングルトン）
- **ストレージ**: localStorage
- **ビルド**: webpack
- **テスト**: Jest + Testing Library
