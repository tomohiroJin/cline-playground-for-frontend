# Air Hockey ブラッシュアップ 仕様書

## 現状の仕様

### 基本構成
- **キャンバスサイズ**: 300x600px（固定）
- **エンティティ**: プレイヤーマレット、CPUマレット、パック（複数対応）、アイテム
- **物理演算**: 衝突検出、壁反射、摩擦
- **AI**: 3段階の難易度（Easy/Normal/Hard）、速度定数（1.2/3/5）
- **アイテム**: Split（パック3分裂）、Speed（速度変化）、Invisible（パック透明化）
- **ステージ**: 3種（Classic, Wide, Pillars）
- **勝利条件**: 設定可能（3/7/15点）
- **サウンド**: Web Audio API によるシンセ音

### 現状の問題点
1. キャンバスサイズが300x600固定で小さい
2. ステージが3種のみで変化に乏しい
3. ゴール後のパックサーブがCPU得点時にプレイヤー方向（vy=1.5）に固定され、常にプレイヤー側が防御から始まる
4. CPU AI の動きが単調（特にeasyが弱すぎ、hardが強さの割に賢くない）
5. 膠着状態への対策がない
6. 見た目が地味

---

## 変更仕様

### 1. 画面サイズ選択機能

**概要**: ゲーム開始前に画面サイズを選択可能にする

**サイズオプション**:
| サイズ名 | キャンバス幅x高 | 説明 |
|---------|----------------|------|
| Standard | 300x600 | 現在のサイズ |
| Large | 450x900 | 1.5倍サイズ |

**実装方針**:
- `CONSTANTS.CANVAS` をサイズ設定に基づいて動的に決定する仕組みに変更
- マレット、パック、アイテムのサイズもスケーリング
- TitleScreen にサイズ選択UIを追加
- 全ての座標計算を相対値（W, H 基準）で統一

### 2. 新ステージ追加（2ステージ）

**追加ステージ**:

#### ステージ4: Zigzag
- **ゴールサイズ**: 90
- **テーマカラー**: `#ffaa00`（オレンジ）
- **障害物**: ジグザグ状に配置された長方形的な障害物群（円で近似）
  - 左右交互に3つの障害物を配置し、パックの直線的な動きを制限

#### ステージ5: Fortress
- **ゴールサイズ**: 70（やや狭い）
- **テーマカラー**: `#ff4488`（ピンク）
- **障害物**: ゴール前に壁のように配置された障害物
  - CPUゴール前に2つ、プレイヤーゴール前に2つ配置

### 3. サーブ方向修正

**現状**: ゴール後のパックが常に `vy=1.5`（プレイヤー方向）で生成される場面があり、CPUに点を入れられた場合も防御から始まる

**修正後**:
- **得点された側がサーブ権を持つ**（得点された側からパックが出発）
  - プレイヤーが得点された場合（scored='player'）: パックが `vy=-1.5` でCPU方向へ（プレイヤーがサーブ）
  - CPUが得点された場合（scored='cpu'）: パックが `vy=1.5` でプレイヤー方向へ（CPUがサーブ）
- **初期サーブ**: ランダムに上下どちらかに `vy=±1.5`

### 4. CPU AI 調整

**改善内容**:

#### Easy
- 速度定数: 1.2 → 1.5（やや上げる）
- 反応遅延: ランダムスキップ率 3% → 5%
- 予測なし → 1フレーム先の予測
- ターゲット精度のブレを増加

#### Normal
- 速度定数: 3 → 3.5
- パックのY位置に応じた積極性（パックが近い時に速く動く）
- 予測: 4フレーム → 6フレーム先

#### Hard
- 速度定数: 5 → 6
- 予測: 8フレーム → 12フレーム先
- パックの壁反射を1回分予測してインターセプトする
- ゴール付近でのポジショニング改善（ゴール中央に戻る動き）

### 5. フィーバータイム

**概要**: 膠着状態が続いた場合に追加パックが投入される

**条件**:
- 最後のゴールから15秒経過でフィーバータイム突入
- 画面にフィーバー演出（画面フラッシュ + テキスト表示）
- 追加パック1つを画面中央にランダム方向で投入
- さらに10秒経過で追加パック1つ（最大3つまで）
- ゴールが決まったらフィーバーリセット

**演出**:
- "FEVER TIME!" テキスト表示（虹色アニメーション）
- 画面枠の色が虹色に変化
- パック投入時にフラッシュエフェクト

### 6. 見た目の強化

**改善項目**:
- **パックの軌跡エフェクト**: パックの移動に残像（トレイル）を追加
- **マレットのグロー**: 常時軽いグロー効果、衝突時に強いグロー
- **ゴールエフェクト強化**: パーティクルエフェクト追加
- **背景**: 微妙なグラデーションアニメーション
- **フィールド線**: より明るいネオン風グロー
- **スコア変動時のアニメーション**: 数字が大きくなってから元に戻る
