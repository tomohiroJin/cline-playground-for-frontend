# IPNE ビジュアル・ストーリー強化 — 実装計画

## 概要

IPNE ローグライクダンジョン RPG の演出を 4 つの軸で強化する。

| # | 強化軸 | 概要 |
|---|--------|------|
| 1 | ストーリー演出 | プロローグのマルチシーン化、ステージ間テキスト拡充、エンディング段階演出、ゲームオーバー演出 |
| 2 | 画像演出 | ストーリー画面への画像表示（プレースホルダー → 本番差し替え）、画像レジストリ新設 |
| 3 | アニメーション強化 | プレイヤー攻撃・被弾フレーム、アイドルブリーズ、敵状態別フレーム |
| 4 | エフェクト強化 | 敵攻撃エフェクト、画面シェイク、低HP警告、ステージクリア演出 |

**方針**: 画像は全てプレースホルダー（単色+テキスト）で配置し、本番アセットは後日差し替え。

---

## フェーズ構成

```
フェーズ1 ── 基盤整備（型拡張・レジストリ・新エフェクト型）
  │
フェーズ2 ── ストーリーコンテンツ強化
  │
フェーズ3 ── アニメーション強化
  │
フェーズ4 ── エフェクト強化
  │
フェーズ5 ── 統合とポリッシュ
```

---

## フェーズ 1: 基盤整備

### 目的

後続フェーズで必要となる型定義・ユーティリティ・レジストリを事前に整備する。

### 変更対象

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/types.ts` | `StoryScene` 拡張（`scenes` 配列対応）、`EpilogueText` 複数行対応 |
| `src/features/ipne/storyImages.ts` (新規) | 画像レジストリモジュール |
| `src/features/ipne/presentation/effects/effectTypes.ts` | 新エフェクト型追加 |

### 作業内容

#### 1-1. `StoryScene` 型の拡張

現在の `StoryScene` は単一シーン構造（`title` + `lines[]`）だが、プロローグのマルチシーン化に対応するため `scenes` 配列を追加する。後方互換のため既存フィールドも維持する。

```typescript
// 変更前
interface StoryScene {
  id: string;
  title: string;
  lines: string[];
  imageKey?: string;
}

// 変更後
interface StorySceneSlide {
  title?: string;
  lines: string[];
  imageKey?: string;
}

interface StoryScene {
  id: string;
  title: string;           // メインタイトル（後方互換）
  lines: string[];          // 後方互換
  imageKey?: string;        // 後方互換
  slides?: StorySceneSlide[]; // マルチシーン用
}
```

#### 1-2. `EpilogueText` 型の拡張

エンディングテキストを複数段落で表示できるよう拡張する。

```typescript
// 変更前
interface EpilogueText {
  title: string;
  text: string;
}

// 変更後
interface EpilogueText {
  title: string;
  text: string;          // 後方互換（短文表示用）
  paragraphs?: string[]; // 複数段落表示用
}
```

#### 1-3. 画像レジストリモジュール新設

ストーリー画像をキーで管理するレジストリを新規作成する。プレースホルダー画像は Canvas で動的生成する。

**ファイル**: `src/features/ipne/storyImages.ts`

```
imageKey → { src: string, alt: string, width: number, height: number }
```

対象キー:
- `prologue_scene_1` / `prologue_scene_2` / `prologue_scene_3`
- `story_stage_1` 〜 `story_stage_5`
- `ending_s` 〜 `ending_d`（既存の ending.ts の画像と連携）
- `game_over`

#### 1-4. 新エフェクト型の追加

`effectTypes.ts` に以下を追加:

```typescript
// 追加する EffectType
ENEMY_ATTACK: 'enemy_attack'
SCREEN_SHAKE: 'screen_shake'
LOW_HP_WARNING: 'low_hp_warning'
STAGE_CLEAR: 'stage_clear'
```

`GameEffect` インターフェースへの追加フィールド:

```typescript
// 画面シェイク用
shakeIntensity?: number;
shakeDecay?: number;

// 低HP警告用
pulsePhase?: number;
```

### 完了条件

- 新しい型定義が TypeScript コンパイルを通過する
- 画像レジストリのプレースホルダーが正しく返却される
- 新エフェクト型が定義されている
- 既存テストが全てパスする（後方互換性）

---

## フェーズ 2: ストーリーコンテンツ強化

### 目的

プロローグ・ステージ間・エンディング・ゲームオーバーのテキストを拡充し、画像表示に対応する。

### 変更対象

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/story.ts` | プロローグ3シーン化、ステージストーリー拡充 |
| `src/features/ipne/ending.ts` | エンディングテキスト拡充、ゲームオーバーテキスト拡充 |
| `src/features/ipne/presentation/screens/Prologue.tsx` | マルチシーンUI対応 |
| `src/features/ipne/presentation/screens/StageStory.tsx` | 画像表示対応 |
| `src/features/ipne/presentation/screens/FinalClear.tsx` | 段階的演出 |

### 作業内容

#### 2-1. プロローグの3シーン化

現在の5行テキストを3つのシーンに分割し、各シーンにプレースホルダー画像を配置する。

**シーン構成**:

| シーン | タイトル | テーマ | 画像キー |
|--------|---------|--------|----------|
| 1 | 任務前夜 | 任務ブリーフィング、ダンジョンの異常性の説明 | `prologue_scene_1` |
| 2 | ダンジョン入口 | ダンジョンに足を踏み入れる描写 | `prologue_scene_2` |
| 3 | 閉じた入口 | 入口が閉じ、後戻りできない決意 | `prologue_scene_3` |

#### 2-2. ステージ間ストーリー拡充

各ステージクリア後のストーリーを 4 行 → 6-8 行に拡充し、画像表示に対応する。

**拡充方針**:
- 核の停止による環境変化の描写を追加
- 次のステージへの伏線を強化
- プレイヤーの心理描写を追加

#### 2-3. エンディング段階的演出

5ランク分のエンディングテキストを `paragraphs[]` で複数段落化する。

**演出フロー**:
1. レーティング表示（ズームイン）
2. クリアタイム表示
3. エピローグタイトル（フェードイン）
4. エピローグ本文（段落ごとにフェードイン）
5. 画像表示（ぼかし → クリア）
6. 操作ボタン表示

#### 2-4. ゲームオーバー演出強化

ゲームオーバーテキストの拡充と、死亡ステージに応じたバリエーション。

#### 2-5. Prologue.tsx のマルチシーン対応

- `slides[]` が存在する場合、シーン送り UI を表示
- 各シーンにタイトル・テキスト・画像を配置
- 自動進行 + 手動送り + スキップの3系統操作

#### 2-6. StageStory.tsx の画像表示対応

- `imageKey` から画像レジストリを参照して画像を表示
- テキストエリアとの上下レイアウト
- 画像のフェードイン演出

#### 2-7. FinalClear.tsx の段階的演出

- `paragraphs[]` 対応の逐次テキスト表示
- 各要素のフェードイン遅延
- S ランク時の特別パーティクル演出

### 完了条件

- プロローグが3シーンで進行可能
- 各ステージストーリーに画像プレースホルダーが表示される
- エンディングが段階的にフェードインする
- ゲームオーバー画面のテキストが拡充されている
- スキップ機能が全画面で動作する

---

## フェーズ 3: アニメーション強化

### 目的

プレイヤーと敵のスプライトアニメーションを拡張し、ゲーム内の視覚的フィードバックを強化する。

### 変更対象

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/presentation/sprites/playerSprites.ts` | 攻撃・被弾フレーム追加 |
| `src/features/ipne/presentation/sprites/enemySprites.ts` | 状態別フレーム追加 |
| `src/features/ipne/presentation/sprites/effectSprites.ts` | 敵攻撃エフェクトスプライト追加 |
| `src/features/ipne/presentation/screens/Game.tsx` | アニメーション切り替えロジック |

### 作業内容

#### 3-1. プレイヤー攻撃フレーム

各クラス（戦士・盗賊）× 4方向に攻撃フレーム（2フレーム）を追加。

**戦士**: 剣を振り下ろすモーション
- Frame 1: 剣を振りかぶった構え
- Frame 2: 剣を振り切った姿勢

**盗賊**: ダガーで突く/斬るモーション
- Frame 1: ダガーを引いた構え
- Frame 2: 突き出した姿勢

合計: 2クラス × 4方向 × 2フレーム = 16 新規スプライト

#### 3-2. プレイヤー被弾フレーム

各クラス × 4方向に被弾フレーム（1フレーム）を追加。
キャラクターが後ろにのけぞるポーズ。

合計: 2クラス × 4方向 × 1フレーム = 8 新規スプライト

#### 3-3. アイドルブリーズアニメーション

待機時に微かな呼吸動作を追加。既存の idle フレームに1フレーム追加し、2フレームの微動アニメーションにする。

合計: 2クラス × 4方向 × 1追加フレーム = 8 新規スプライト

#### 3-4. 敵状態別フレーム

各敵タイプに状態別フレームを追加:

| 敵タイプ | 現在 | 追加 | 追加内容 |
|---------|------|------|---------|
| Patrol (スライム) | 2F | +1F | 攻撃フレーム（膨張） |
| Charge (ビースト) | 2F | +1F | 突進フレーム（前傾） |
| Ranged (メイジ) | 2F | +1F | 詠唱フレーム（光る） |
| Specimen | 2F | +1F | 変異フレーム |
| Boss | 2F | +2F | 攻撃＋ダメージフレーム |

#### 3-5. 敵攻撃エフェクトスプライト

敵の攻撃用視覚エフェクトスプライトを追加。

- 近接攻撃エフェクト: 赤系の衝撃波（3フレーム）
- 遠距離攻撃エフェクト: オレンジの弾丸飛翔（3フレーム）

#### 3-6. Game.tsx アニメーション統合

- プレイヤーの攻撃 cooldown 中は攻撃フレームを表示
- 被弾時は被弾フレームを一定時間（200ms）表示
- 待機中はブリーズアニメーションを再生
- 敵の状態（`EnemyState`）に応じたフレーム切り替え

### 完了条件

- プレイヤーの攻撃時に攻撃アニメーションが再生される
- プレイヤーの被弾時にのけぞりフレームが表示される
- 待機中のプレイヤーに微動アニメーションがある
- 各敵タイプが状態に応じたアニメーションを表示する
- 敵の攻撃にエフェクトスプライトが表示される

---

## フェーズ 4: エフェクト強化

### 目的

戦闘と画面演出のエフェクトを強化し、視覚的フィードバックを向上させる。

### 変更対象

| ファイル | 変更内容 |
|---------|---------|
| `src/features/ipne/presentation/effects/effectTypes.ts` | (フェーズ1で追加済み) |
| `src/features/ipne/presentation/effects/effectManager.ts` | 新エフェクト実装 |
| `src/features/ipne/presentation/effects/particleSystem.ts` | 新パーティクルパターン |
| `src/features/ipne/presentation/screens/Game.tsx` | エフェクト統合 |

### 作業内容

#### 4-1. 敵攻撃エフェクト

敵が攻撃した時の視覚エフェクトを追加。

- **近接攻撃**: 赤い衝撃波パーティクル（放射状8個、400ms）
- **遠距離攻撃**: オレンジの軌跡パーティクル（直線6個、300ms）
- **ボス攻撃**: 大規模な赤紫の爆発パーティクル（放射状16個、600ms）

#### 4-2. 画面シェイク

プレイヤー被弾時にキャンバス全体を短時間揺らす演出。

- **強度**: ダメージ量に比例（最大 4px、最小 1px）
- **持続時間**: 200ms
- **減衰**: リニア（振幅が線形に 0 へ減衰）
- **実装**: Canvas の `translate()` でオフセット適用

#### 4-3. 低HP警告エフェクト

プレイヤーの HP が閾値以下（25%以下）の時に、画面縁に赤いパルスを表示する。

- **色**: `rgba(220, 38, 38, alpha)` (赤)
- **パルス速度**: 1.5秒周期
- **最大 alpha**: 0.25
- **描画**: 画面四辺に内側へのグラデーション（ビネット風）

#### 4-4. ステージクリア演出

ボス撃破後のステージクリア時にパーティクル花火を表示。

- **パーティクル数**: 32
- **色**: ステージカラーに準拠
- **パターン**: 中央から放射 → 重力落下（花火風）
- **持続時間**: 1500ms
- **追加**: クリアテキスト「STAGE CLEAR」のフラッシュ表示

#### 4-5. particleSystem.ts 拡張

新しいパーティクルパターンを追加:

- `createSpiralParticles()`: 螺旋状に広がるパーティクル（ステージクリア用）
- `createPulseParticles()`: 中心から波紋状に広がるパーティクル（ボス攻撃用）
- `createTrailParticles()`: 直線軌跡のパーティクル（遠距離攻撃用）

#### 4-6. Game.tsx エフェクト統合

- 敵攻撃時に `ENEMY_ATTACK` エフェクトをトリガー
- プレイヤー被弾時に `SCREEN_SHAKE` エフェクトをトリガー
- HP 低下時に `LOW_HP_WARNING` を常時描画
- ステージクリア時に `STAGE_CLEAR` エフェクトをトリガー

### 完了条件

- 敵攻撃時に攻撃種別に応じたエフェクトが表示される
- プレイヤー被弾時に画面がシェイクする
- HP が 25% 以下で画面縁に赤いパルスが表示される
- ステージクリア時にパーティクル花火が表示される
- パフォーマンス: 同時パーティクル数が 200 以下に制限されている

---

## フェーズ 5: 統合とポリッシュ

### 目的

全フェーズの成果物を統合テストし、パフォーマンスと品質を最終調整する。

### 作業内容

#### 5-1. 統合テスト

- 全画面遷移の通しテスト（タイトル → クラス選択 → プロローグ → ゲーム × 5ステージ → エンディング）
- ゲームオーバーフロー（全ステージでの死亡 → ゲームオーバー画面）
- スキップ操作の検証
- モバイル / デスクトップ両レイアウト確認

#### 5-2. パフォーマンス最適化

- Canvas 描画負荷計測（60fps 維持確認）
- パーティクル上限 200 の動作確認
- 画像プレースホルダーのキャッシング確認
- メモリリーク検証（長時間プレイ想定）

#### 5-3. ポリッシュ

- アニメーションタイミングの微調整
- テキスト表示速度の調整
- エフェクト色・サイズの微調整
- 画面遷移のフェード統一

#### 5-4. 既存テストの修正

- 型変更に伴うテストの更新
- 新機能のユニットテスト追加
- スナップショットテスト更新

### 完了条件

- 全画面遷移がエラーなく完了する
- 60fps を維持できる
- 既存テストが全てパスする
- 新機能のテストカバレッジが十分

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| スプライト追加による描画負荷増大 | 中 | パーティクル上限維持、不要フレーム描画のスキップ |
| マルチシーンによるプロローグの冗長化 | 低 | スキップ機能の確実な動作保証 |
| 型変更による既存コード破損 | 高 | 後方互換フィールド維持、段階的移行 |
| プレースホルダー画像の見栄え | 低 | Canvas 動的生成で最低限の表示品質を確保 |

---

## スケジュール概算

| フェーズ | 依存 | 備考 |
|---------|------|------|
| フェーズ 1 | なし | 他の全フェーズの前提 |
| フェーズ 2 | フェーズ 1 | ストーリー系は独立性が高い |
| フェーズ 3 | フェーズ 1 | アニメーション系は独立性が高い |
| フェーズ 4 | フェーズ 1 | エフェクト系は独立性が高い |
| フェーズ 5 | フェーズ 2, 3, 4 | 全統合後 |

フェーズ 2, 3, 4 は並列実施可能。
