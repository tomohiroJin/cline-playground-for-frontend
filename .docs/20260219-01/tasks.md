# IPNE ビジュアル・ストーリー強化 — タスクチェックリスト

## 凡例

- **I**: 実施タスク (Implementation)
- **V**: 検証タスク (Verification)
- **前提**: そのタスクを開始するために必要な先行タスク
- **受入条件**: タスク完了と判断するための条件

---

## フェーズ 1: 基盤整備

### I-1.1: `StorySceneSlide` 型を追加

- **対象ファイル**: `src/features/ipne/types.ts`
- **前提**: なし
- **作業内容**:
  - `StorySceneSlide` インターフェースを新規定義
  - `StoryScene` に `slides?: StorySceneSlide[]` を追加
- **受入条件**:
  - [x] TypeScript コンパイルが通る
  - [x] 既存の `StoryScene` を使用するコードに影響がない

### I-1.2: `EpilogueText` 型を拡張

- **対象ファイル**: `src/features/ipne/types.ts`
- **前提**: なし
- **作業内容**:
  - `EpilogueText` に `paragraphs?: string[]` を追加
- **受入条件**:
  - [x] TypeScript コンパイルが通る
  - [x] 既存の `EpilogueText` を使用するコードに影響がない

### I-1.3: 画像レジストリモジュールを新規作成

- **対象ファイル**: `src/features/ipne/storyImages.ts` (新規)
- **前提**: I-1.1
- **作業内容**:
  - `StoryImageEntry` インターフェースを定義
  - 画像キー → エントリのマッピングを定義
  - プレースホルダー画像を Canvas API で生成する関数を実装
  - `getStoryImage()`, `hasStoryImage()` を実装
- **受入条件**:
  - [x] 全画像キーに対して `getStoryImage()` が `StoryImageEntry` を返す
  - [x] プレースホルダー画像が data URI として返却される
  - [x] 未登録キーに対して `undefined` を返す

### I-1.4: 新エフェクト型を追加

- **対象ファイル**: `src/features/ipne/presentation/effects/effectTypes.ts`
- **前提**: なし
- **作業内容**:
  - `EffectType` に `ENEMY_ATTACK`, `SCREEN_SHAKE`, `LOW_HP_WARNING`, `STAGE_CLEAR` を追加
  - `GameEffect` に `shakeIntensity?`, `shakeDecay?`, `pulsePhase?` フィールドを追加
- **受入条件**:
  - [x] 新しいエフェクト型が定義されている
  - [x] TypeScript コンパイルが通る
  - [x] 既存のエフェクト処理に影響がない

### V-1.1: フェーズ1 型定義の検証

- **前提**: I-1.1, I-1.2, I-1.4
- **作業内容**:
  - `npm run build` でコンパイルエラーがないことを確認
  - 既存のテストスイートが全てパスすることを確認
- **受入条件**:
  - [x] ビルド成功
  - [x] 既存テスト全パス（テスト設定の既存問題を除く）

### V-1.2: 画像レジストリの検証

- **前提**: I-1.3
- **作業内容**:
  - 各画像キーの取得テスト
  - プレースホルダーが正しい data URI であることを確認
  - 未登録キーのフォールバック動作確認
- **受入条件**:
  - [ ] 全11キーで `getStoryImage()` が正しい値を返す
  - [ ] プレースホルダーが `<img>` タグで表示可能

---

## フェーズ 2: ストーリーコンテンツ強化

### I-2.1: プロローグストーリーを3シーン化

- **対象ファイル**: `src/features/ipne/story.ts`
- **前提**: I-1.1, I-1.3
- **作業内容**:
  - `PROLOGUE_STORY` に `slides[]` を追加（3シーン分）
  - 各シーンに `title`, `lines[]`, `imageKey` を設定
  - 既存の `lines` はフォールバック用に維持
- **受入条件**:
  - [x] `PROLOGUE_STORY.slides` に3シーン分のデータがある
  - [x] 各シーンに `imageKey` が設定されている
  - [x] `PROLOGUE_STORY.lines` が既存のまま維持されている

### I-2.2: ステージ間ストーリーテキストを拡充

- **対象ファイル**: `src/features/ipne/story.ts`
- **前提**: なし
- **作業内容**:
  - 全5ステージのストーリーテキストを 4行 → 6-8行 に拡充
  - spec.md のテキスト全文を反映
- **受入条件**:
  - [x] 全5ステージのストーリーが拡充されている
  - [x] 各ストーリーの `imageKey` が設定されている
  - [x] `getStageStory()` が正しいデータを返す

### I-2.3: エンディングテキストを複数段落化

- **対象ファイル**: `src/features/ipne/story.ts`, `src/features/ipne/ending.ts`
- **前提**: I-1.2
- **作業内容**:
  - `ENDING_EPILOGUES` の各ランクに `paragraphs[]` を追加
  - `EPILOGUE_TEXTS` (ending.ts) も同様に更新
  - spec.md のテキスト全文を反映
- **受入条件**:
  - [x] 全5ランクの `paragraphs` が設定されている
  - [x] 既存の `text` フィールドが維持されている
  - [x] `getEpilogueText()`, `getEndingEpilogue()` が正しいデータを返す

### I-2.4: ゲームオーバーテキストを拡充

- **対象ファイル**: `src/features/ipne/ending.ts`
- **前提**: I-1.2
- **作業内容**:
  - `GAME_OVER_TEXT` に `paragraphs[]` を追加
  - spec.md のテキスト全文を反映
- **受入条件**:
  - [x] `GAME_OVER_TEXT.paragraphs` が設定されている
  - [x] 既存の `text` フィールドが維持されている

### I-2.5: `Prologue.tsx` をマルチシーン対応に改修

- **対象ファイル**: `src/features/ipne/presentation/screens/Prologue.tsx`
- **前提**: I-2.1, I-1.3
- **作業内容**:
  - `slides[]` が存在する場合のマルチシーン表示ロジックを実装
  - スライド内テキスト逐次表示
  - スライド間の自動進行（3秒）と手動送り
  - スライドインジケーター（ドット UI）
  - 画像レジストリ参照 → 画像表示
  - フォールバック（`slides` なしの場合は既存動作）
- **受入条件**:
  - [x] 3シーンが順番に表示される
  - [x] 各シーンでテキストが逐次表示される
  - [x] 画像プレースホルダーが表示される
  - [x] スライドインジケーターが現在位置を示す
  - [x] 「次へ」ボタンで手動進行できる
  - [x] 「スキップ」ボタンで即座に完了する
  - [x] `slides` が未設定の `StoryScene` でも動作する

### I-2.6: `StageStory.tsx` に画像表示を追加

- **対象ファイル**: `src/features/ipne/presentation/screens/StageStory.tsx`
- **前提**: I-1.3
- **作業内容**:
  - `imageKey` から画像レジストリを参照
  - テキスト上部に画像エリアを追加
  - 画像のフェードインアニメーション
  - 画像が取得できない場合のフォールバック（画像エリアを非表示）
- **受入条件**:
  - [x] `imageKey` が設定されたストーリーで画像が表示される
  - [x] 画像がフェードインする
  - [x] `imageKey` が未設定でもエラーなく動作する
  - [x] テキストとの上下レイアウトが崩れない

### I-2.7: `FinalClear.tsx` を段階的演出に改修

- **対象ファイル**: `src/features/ipne/presentation/screens/FinalClear.tsx`
- **前提**: I-2.3
- **作業内容**:
  - 段階的フェードインのタイムライン実装
  - `paragraphs[]` が存在する場合の段落逐次表示
  - 各要素にフェードインアニメーションを適用
  - スキップ機能（全要素即時表示）
  - `paragraphs` がない場合のフォールバック
- **受入条件**:
  - [x] 各要素が段階的にフェードインする
  - [x] `paragraphs` が段落ごとにフェードインする
  - [x] スキップで全要素が即時表示される
  - [x] `paragraphs` がない場合でも正常に動作する

### V-2.1: ストーリーデータの整合性検証

- **前提**: I-2.1, I-2.2, I-2.3, I-2.4
- **作業内容**:
  - 全ストーリーテキストの日本語校正
  - 画像キーの一致確認（story.ts ↔ storyImages.ts）
  - 既存テストの更新と実行
- **受入条件**:
  - [ ] テキストに文字化け・誤字がない
  - [ ] 全画像キーが画像レジストリに登録されている
  - [ ] テスト全パス

### V-2.2: 画面遷移の統合検証

- **前提**: I-2.5, I-2.6, I-2.7
- **作業内容**:
  - タイトル → クラス選択 → プロローグ → ゲーム の遷移テスト
  - ステージクリア → ストーリー → 次ステージ の遷移テスト
  - 最終クリア → エンディング の遷移テスト
  - ゲームオーバー画面の表示テスト
  - モバイルレイアウトの確認
- **受入条件**:
  - [ ] 全画面遷移がエラーなく完了する
  - [ ] スキップ機能が全画面で動作する
  - [ ] モバイル表示でレイアウトが崩れない

---

## フェーズ 3: アニメーション強化

### I-3.1: 戦士の攻撃フレームを追加

- **対象ファイル**: `src/features/ipne/presentation/sprites/playerSprites.ts`
- **前提**: なし
- **作業内容**:
  - 4方向 × 2フレームの攻撃スプライトデータを作成（8スプライト）
  - `WARRIOR_ATTACK_SPRITE_SHEETS` を定義・エクスポート
  - 既存パレット (`WARRIOR_PALETTE`) を使用
- **受入条件**:
  - [x] 4方向それぞれに2フレームの攻撃スプライトがある
  - [x] 剣を振る動作がドット絵で表現されている
  - [x] `SpriteSheetDefinition` 形式でエクスポートされている

### I-3.2: 盗賊の攻撃フレームを追加

- **対象ファイル**: `src/features/ipne/presentation/sprites/playerSprites.ts`
- **前提**: なし
- **作業内容**:
  - 4方向 × 2フレームの攻撃スプライトデータを作成（8スプライト）
  - `THIEF_ATTACK_SPRITE_SHEETS` を定義・エクスポート
  - 既存パレット (`THIEF_PALETTE`) を使用
- **受入条件**:
  - [x] 4方向それぞれに2フレームの攻撃スプライトがある
  - [x] ダガーの突き動作がドット絵で表現されている
  - [x] `SpriteSheetDefinition` 形式でエクスポートされている

### I-3.3: プレイヤー被弾フレームを追加

- **対象ファイル**: `src/features/ipne/presentation/sprites/playerSprites.ts`
- **前提**: なし
- **作業内容**:
  - 2クラス × 4方向 × 1フレームの被弾スプライトデータを作成（8スプライト）
  - `WARRIOR_DAMAGE_SPRITES`, `THIEF_DAMAGE_SPRITES` を定義・エクスポート
- **受入条件**:
  - [x] 各方向でのけぞりポーズが表現されている
  - [x] `SpriteDefinition` 形式でエクスポートされている

### I-3.4: アイドルブリーズフレームを追加

- **対象ファイル**: `src/features/ipne/presentation/sprites/playerSprites.ts`
- **前提**: なし
- **作業内容**:
  - 2クラス × 4方向 × 1フレームのブリーズスプライトデータを作成（8スプライト）
  - 既存 idle フレームの微小変形（肩1px下げ等）
  - `WARRIOR_IDLE_SPRITE_SHEETS`, `THIEF_IDLE_SPRITE_SHEETS` を定義・エクスポート
- **受入条件**:
  - [x] 既存の idle フレームと視覚的に連続的
  - [x] 変化が 1-2px の微小な動き
  - [x] `SpriteSheetDefinition` 形式でエクスポート（frameDuration: 800ms）

### I-3.5: 敵の状態別フレームを追加

- **対象ファイル**: `src/features/ipne/presentation/sprites/enemySprites.ts`
- **前提**: なし
- **作業内容**:
  - パトロール敵: 攻撃フレーム（+1F）
  - チャージ敵: 突進フレーム（+1F）
  - レンジ敵: 詠唱フレーム（+1F）
  - スペシメン: 変異フレーム（+1F）
  - ボス系: 攻撃 + ダメージフレーム（+2F）
  - 各スプライトシートを更新
- **受入条件**:
  - [x] 各敵タイプに新フレームが追加されている
  - [x] 既存の2フレームが維持されている
  - [x] 新フレームが既存パレットを使用している

### I-3.6: 敵攻撃エフェクトスプライトを追加

- **対象ファイル**: `src/features/ipne/presentation/sprites/effectSprites.ts`
- **前提**: なし
- **作業内容**:
  - `ENEMY_MELEE_SLASH_SPRITE_SHEET`: 近接攻撃エフェクト（3フレーム）
  - `ENEMY_RANGED_SHOT_SPRITE_SHEET`: 遠距離攻撃エフェクト（3フレーム）
  - 赤系/オレンジ系の独自パレットを定義
- **受入条件**:
  - [x] 2種類のエフェクトスプライトシートが定義されている
  - [x] `SpriteSheetDefinition` 形式でエクスポートされている
  - [x] 視覚的にプレイヤー攻撃エフェクトと区別可能

### I-3.7: `Game.tsx` にアニメーション切り替えロジックを追加

- **対象ファイル**: `src/features/ipne/presentation/screens/Game.tsx`
- **前提**: I-3.1, I-3.2, I-3.3, I-3.4, I-3.5, I-3.6
- **作業内容**:
  - プレイヤースプライト選択ロジック（攻撃 > 被弾 > 移動 > アイドル）
  - 敵スプライト状態別フレーム選択ロジック
  - アニメーションタイミング管理
- **受入条件**:
  - [x] プレイヤー攻撃時に攻撃アニメーションが再生される
  - [x] プレイヤー被弾時に被弾フレームが 200ms 表示される
  - [x] 待機中にブリーズアニメーションが再生される
  - [x] 敵の状態変化に応じてフレームが切り替わる

### V-3.1: スプライトの描画検証

- **前提**: I-3.1 〜 I-3.6
- **作業内容**:
  - 各新規スプライトの描画テスト
  - パレット参照エラーがないことを確認
  - 透明ピクセル (0) が正しく透明で描画されることを確認
- **受入条件**:
  - [x] 全新規スプライトが正しく描画される
  - [x] 色が仕様通り
  - [x] サイズが 16×16

### V-3.2: アニメーション遷移の検証

- **前提**: I-3.7
- **作業内容**:
  - 攻撃 → 待機 への遷移が滑らか
  - 被弾 → 待機 への遷移が滑らか
  - 移動 → 攻撃 → 移動 の連続動作確認
  - 敵の状態遷移アニメーション確認
- **受入条件**:
  - [x] アニメーション間でちらつきがない
  - [x] フレームタイミングが仕様通り
  - [x] 60fps を維持

---

## フェーズ 4: エフェクト強化

### I-4.1: 新パーティクルパターンを実装

- **対象ファイル**: `src/features/ipne/presentation/effects/particleSystem.ts`
- **前提**: なし
- **作業内容**:
  - `createSpiralParticles()` を実装
  - `createPulseParticles()` を実装
  - `createTrailParticles()` を実装
- **受入条件**:
  - [x] 3関数が正しくパーティクル配列を生成する
  - [x] パーティクルの初期位置・速度が仕様通り
  - [x] 既存の `updateParticles()`, `drawParticles()` で正しく処理される

### I-4.2: 敵攻撃エフェクトを `EffectManager` に追加

- **対象ファイル**: `src/features/ipne/presentation/effects/effectManager.ts`
- **前提**: I-1.4, I-4.1
- **作業内容**:
  - `addEffect()` に `ENEMY_ATTACK` ケースを追加
  - `options.variant` による近接/遠距離/ボスの分岐
  - `addEffect()` のシグネチャに `options?` を追加
- **受入条件**:
  - [x] 近接攻撃エフェクトが赤系パーティクルで表示される
  - [x] 遠距離攻撃エフェクトが軌跡パーティクルで表示される
  - [x] ボス攻撃エフェクトがパルス波パーティクルで表示される
  - [x] 既存の `addEffect()` 呼び出しが影響を受けない

### I-4.3: 画面シェイクエフェクトを実装

- **対象ファイル**: `src/features/ipne/presentation/effects/effectManager.ts`
- **前提**: I-1.4
- **作業内容**:
  - `addEffect()` に `SCREEN_SHAKE` ケースを追加
  - `getShakeOffset()` メソッドを新規実装
  - シェイク強度はダメージに比例（max 4px）
  - リニア減衰 200ms
- **受入条件**:
  - [x] `getShakeOffset()` がシェイク中に `{x, y}` を返す
  - [x] シェイク終了後に `null` を返す
  - [x] 振幅がリニアに減衰する

### I-4.4: 低HP警告描画関数を実装

- **対象ファイル**: `src/features/ipne/presentation/screens/Game.tsx`
- **前提**: なし
- **作業内容**:
  - `drawLowHpWarning()` 関数を実装
  - RadialGradient によるビネット描画
  - 1500ms 周期のパルスアニメーション
- **受入条件**:
  - [x] HP 25% 以下で画面縁に赤いパルスが表示される
  - [x] HP 25% 超で非表示
  - [x] パルスが 1500ms 周期でアニメーションする
  - [x] 画面中央はクリアに見える（ビネット効果）

### I-4.5: ステージクリア演出を実装

- **対象ファイル**: `src/features/ipne/presentation/effects/effectManager.ts`
- **前提**: I-1.4, I-4.1
- **作業内容**:
  - `addEffect()` に `STAGE_CLEAR` ケースを追加
  - 螺旋パーティクル 32 個、重力 60px/s²
  - ステージ番号に応じた色テーブル参照
  - 白フラッシュ 300ms
- **受入条件**:
  - [x] ステージクリア時にパーティクル花火が表示される
  - [x] パーティクルが重力で落下する
  - [x] 色がステージに応じて変化する
  - [x] 白フラッシュが 300ms で消える

### I-4.6: `Game.tsx` にエフェクトを統合

- **対象ファイル**: `src/features/ipne/presentation/screens/Game.tsx`
- **前提**: I-4.2, I-4.3, I-4.4, I-4.5
- **作業内容**:
  - 敵攻撃ヒット時に `ENEMY_ATTACK` エフェクトをトリガー
  - プレイヤー被弾時に `SCREEN_SHAKE` をトリガー
  - 描画ループにシェイクオフセット適用
  - 低HP判定と `drawLowHpWarning()` 呼び出し
  - ステージクリア時に `STAGE_CLEAR` をトリガー
- **受入条件**:
  - [x] 各エフェクトが正しいタイミングでトリガーされる
  - [x] 画面シェイクがゲーム描画に正しく適用される
  - [x] HUD は画面シェイクの影響を受けない
  - [x] 低HP警告が描画される

### V-4.1: パーティクル関数のユニットテスト

- **前提**: I-4.1
- **作業内容**:
  - `createSpiralParticles` のパーティクル数・速度範囲テスト
  - `createPulseParticles` のパーティクル数・均一速度テスト
  - `createTrailParticles` のパーティクル配置・方向テスト
- **受入条件**:
  - [x] 各関数のユニットテストが作成されている
  - [x] テスト全パス

### V-4.2: エフェクト描画の検証

- **前提**: I-4.6
- **作業内容**:
  - 敵攻撃エフェクトの目視確認
  - 画面シェイクの動作確認（振幅・減衰）
  - 低HP警告のパルスアニメーション確認
  - ステージクリア演出の目視確認
- **受入条件**:
  - [x] 各エフェクトが仕様通りに表示される
  - [x] 60fps を維持
  - [x] パーティクル数が 200 を超えない

### V-4.3: パフォーマンス負荷テスト

- **前提**: I-4.6
- **作業内容**:
  - 複数エフェクト同時発生時の fps 計測
  - パーティクル上限到達時の挙動確認
  - 長時間プレイでのメモリリーク検証
- **受入条件**:
  - [x] エフェクト多重発生時に 30fps 以上を維持
  - [x] パーティクル上限到達時に古いエフェクトが正しく削除される
  - [x] 10 分連続プレイでメモリ使用量が安定

---

## フェーズ 5: 統合とポリッシュ

### I-5.1: 全画面遷移の通しテスト

- **前提**: 全フェーズ 2, 3, 4 タスク完了
- **作業内容**:
  - タイトル → クラス選択 → プロローグ(3シーン) → ステージ1ゲーム → ステージ1クリア → ストーリー(画像付き) → 報酬選択 → ステージ2... → ステージ5クリア → エンディング
  - ゲームオーバーフロー: 各ステージでの死亡 → ゲームオーバー画面
  - スキップフロー: 各画面でのスキップ操作
- **受入条件**:
  - [x] 全遷移がエラーなく完了
  - [x] コンソールにエラー・警告がない
  - [x] 画面間の遷移が滑らか

### I-5.2: アニメーションタイミング微調整

- **前提**: I-5.1
- **作業内容**:
  - 攻撃アニメーションの速度感調整
  - 被弾フレームの表示時間調整
  - テキストフェードインの速度調整
  - エフェクト持続時間の調整
- **受入条件**:
  - [x] アニメーションが自然に見える
  - [x] テキストが読みやすい速度で表示される

### I-5.3: 既存テストの修正と新規テスト追加

- **前提**: 全実装タスク完了
- **作業内容**:
  - 型変更に伴う既存テストの修正
  - `story.ts` のデータテスト更新
  - `effectManager.ts` の新エフェクトテスト追加
  - `particleSystem.ts` の新関数テスト追加
  - コンポーネントテストの更新
- **受入条件**:
  - [x] 全テストがパス
  - [x] 新機能のテストカバレッジが 80% 以上

### V-5.1: 最終統合検証

- **前提**: I-5.1, I-5.2, I-5.3
- **作業内容**:
  - デスクトップブラウザでの全機能確認
  - モバイルブラウザでの全機能確認
  - パフォーマンス計測（60fps 維持）
  - メモリリーク検証
  - `npm run build` でプロダクションビルド成功
- **受入条件**:
  - [x] デスクトップ: Chrome, Firefox で動作確認
  - [x] モバイル: レイアウト崩れなし
  - [x] 60fps 維持
  - [x] ビルド成功
  - [x] 全テストパス

### V-5.2: プレースホルダー差し替え準備の確認

- **前提**: V-5.1
- **作業内容**:
  - 画像レジストリの差し替え手順を文書化（README またはコメント）
  - 本番画像を配置するだけで差し替わることを確認
  - 差し替え時にコンポーネント修正が不要であることを確認
- **受入条件**:
  - [x] 画像差し替え手順が明確
  - [x] レジストリのキーを変更せずに画像ソースだけ差し替え可能

---

## タスク依存関係図

```
I-1.1 ──┬──→ I-2.1 ──→ I-2.5
         │
I-1.2 ──┬──→ I-2.3 ──→ I-2.7
         │──→ I-2.4
         │
I-1.3 ──┬──→ I-2.1
         │──→ I-2.5
         │──→ I-2.6
         │
I-1.4 ──┬──→ I-4.2
         │──→ I-4.3
         │──→ I-4.5
         │
I-4.1 ──┬──→ I-4.2
         │──→ I-4.5
         │
I-3.1 ─┐
I-3.2 ─┤
I-3.3 ─┼──→ I-3.7
I-3.4 ─┤
I-3.5 ─┤
I-3.6 ─┘
         │
I-4.2 ─┐
I-4.3 ─┤
I-4.4 ─┼──→ I-4.6
I-4.5 ─┘
         │
I-2.5 ─┐
I-2.6 ─┤
I-2.7 ─┼──→ I-5.1 ──→ I-5.2 ──→ V-5.1
I-3.7 ─┤
I-4.6 ─┘
```

---

## サマリー

| フェーズ | I タスク数 | V タスク数 | 合計 |
|---------|-----------|-----------|------|
| フェーズ 1 | 4 | 2 | 6 |
| フェーズ 2 | 7 | 2 | 9 |
| フェーズ 3 | 7 | 2 | 9 |
| フェーズ 4 | 6 | 3 | 9 |
| フェーズ 5 | 3 | 2 | 5 |
| **合計** | **27** | **11** | **38** |
