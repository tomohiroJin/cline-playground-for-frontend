# 全ゲームリファクタリング計画

## 概要

React 19 + TypeScript で構築された11ゲームのリファクタリングを計画駆動で実施する。
多くのゲームでロジック・UI・型定義が巨大な単一ファイルに集約されており、保守性・テスト性の向上を目的とする。

> **除外**: Picture Puzzle（既にテスト120件、良好な構造のため対象外）

## 対象ゲーム一覧

| カテゴリ | ゲーム | 最大ファイル | 行数 | テスト | 優先度 |
|---------|--------|------------|------|-------|-------|
| A（ページ集約型） | Racing Game | RacingGamePage.tsx | 1,820 | 5件 | P1 |
| A | Labyrinth of Shadows | MazeHorrorPage.tsx | 1,613 | 3件 | P1 |
| A | Falldown Shooter | FallingShooterPage.tsx | 1,602 | 4件 | P1 |
| A | Deep Sea Interceptor | DeepSeaShooterPage.tsx | 1,320 | 3件 | P1 |
| B（部分分離型） | Labyrinth Echo | LabyrinthEchoGame.tsx | 4,133 | 2件 | P2 |
| B | Keys & Arms | engine.ts | 2,467 | 1件 | P2 |
| B | Air Hockey | AirHockeyPage.tsx | 751 | 6件 | P3 |
| C（完全分離型） | IPNE | IpnePage.tsx | 2,028 | 542件 | P4 |
| C | Risk LCD | useGameEngine.ts | 1,033 | 53件 | P4 |
| C | Non-Brake Descent | renderers.tsx | 880 | 11件 | P4 |
| C | Agile Quiz Sugoroku | styles.ts | 1,070 | 3件 | P4 |

### カテゴリ説明

- **A（ページ集約型）**: すべてが1つのページコンポーネントに集約。最も分割の恩恵が大きい
- **B（部分分離型）**: 一部は分離済みだが、中心ファイルが巨大。段階的に分割
- **C（完全分離型）**: 構造はある程度整っているが、個別ファイルが大きい。ファイル内分割が主

## フェーズ構成

### フェーズ0: 準備

- 全テスト実行・緑確認
- 共通 `math-utils.ts` 拡張（lerp, normalize, shuffle 等、各ゲームで重複している関数を共通化）
- テスト環境の整備

### フェーズ1: P1 ゲーム（並列実施可能）

各ゲームは独立してリファクタリング可能。

| ゲーム | 推定分割ファイル数 | 主な作業 |
|--------|------------------|---------|
| Racing Game | 10+ | ページ → features/ 配下に全面移動 |
| Labyrinth of Shadows | 10+ | ページ → features/ 配下に全面移動 |
| Falldown Shooter | 12+ | ページ → features/ 配下に全面移動 |
| Deep Sea Interceptor | 10+ | ページ → features/ 配下に全面移動 |

### フェーズ2: P2 ゲーム（並列実施可能）

| ゲーム | 推定分割ファイル数 | 主な作業 |
|--------|------------------|---------|
| Labyrinth Echo | 10+ | 4,133行のメインファイルを300行に縮小 |
| Keys & Arms | 15+ | engine.ts を機能モジュールに分割 |

### フェーズ3: P3-P4 ゲーム（並列実施可能）

| ゲーム | 推定分割ファイル数 | 主な作業 |
|--------|------------------|---------|
| Air Hockey | 5+ | hooks・components 分離 |
| IPNE | 8+ | presentation 層の分割、542テスト維持 |
| Risk LCD | 5+ | フェーズ別フック分割 |
| Non-Brake Descent | 8+ | renderers サブディレクトリ化 |
| Agile Quiz Sugoroku | 6+ | styles サブディレクトリ化 + テスト追加 |

### フェーズ4: 統合・仕上げ

- ローカル math 関数の共通 `math-utils.ts` への移動
- 全テスト一括実行・緑確認
- ビルド確認（`npm run build` 成功）
- リンター/フォーマッター確認
- コミット・PR作成

## 作業ルール

> **重要**: 各フェーズ・タスク完了時に `tasks.md` のチェックボックスを必ず更新すること。
> 作業漏れ防止のため、コード変更とセットで `tasks.md` の該当項目を `[x]` に変更する。

## リファクタリング原則

### 必須ルール

1. **TDD（テスト駆動）**: 各ステップでテスト通過を確認。テストが壊れたら即修正
2. **7関心事以下**: 1ファイルの責務は7つ以下に保つ
3. **300行以下**: データ定義を除き、1ファイル300行以下を目標
4. **DRY**: 重複コードは共通関数に抽出
5. **SOLID**: 単一責任、依存性逆転を意識
6. **DbC（契約による設計）**: 入力の型と戻り値の型を明確に

### 推奨アプローチ

- **関数型・宣言的**: 純粋関数を優先。副作用はフック内に閉じ込める
- **段階的移行**: 一度に全てを変えず、ファイル単位で移動 → テスト確認を繰り返す
- **インポート経路の管理**: 各 feature の `index.ts` で re-export し、外部からのインポートを安定化

## 共通AudioEngine基盤について

> **スコープ外**: 各ゲームの Audio 実装はファイル分離のみ行い、共通 AudioEngine 基盤の構築は別タスクとする。
> 現段階では各ゲームの `audio.ts` に Web Audio API 関連コードを集約するにとどめる。

## リスクと対策

| リスク | 対策 |
|-------|------|
| テスト壊れ | 各ステップでテスト実行。壊れたら即修正 |
| インポートパス変更漏れ | `index.ts` による re-export で外部依存を最小化 |
| 並列作業のコンフリクト | 各ゲームは独立ディレクトリなのでコンフリクトリスクは低い |
| 542件テスト（IPNE）のパス修正 | 慎重にインポートパスを更新。バッチ置換 + 確認 |
