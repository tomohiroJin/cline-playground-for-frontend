# 迷宮の残響 ブラッシュアップ計画

## 概要

テキスト探索型ローグライトRPG「迷宮の残響（Labyrinth Echo）」を、ビジュアル・サウンド・ゲームプレイ・エンゲージメントの4軸で総合的にブラッシュアップし、人気コンテンツとなるレベルの体験品質を実現する。

**特に画像生成AIを活用したビジュアル演出の革新を中核に据え、テキストアドベンチャーの枠を超えた没入体験を創出する。**

---

## 現状分析

### 強み（活かすべき資産）

| 項目 | 詳細 |
|------|------|
| 豊富なイベント | 163件（チェイン15件・クロスラン対応含む） |
| マルチエンディング | 11種のエンディング＋エンディングコレクション |
| 周回システム | 知見ポイント(KP)、40種アンロック、21種称号 |
| 状態異常 | 5種（負傷・混乱・出血・恐怖・呪い） |
| 危機演出 | HP低下ビネット、MN低下ブラー、テキスト歪み、画面シェイク |
| 統一された世界観 | ダークファンタジー、serifフォント、暗色基調のデザイン |
| 画像アセット | 26枚の高品質WebP画像（タイトル・難易度・フロア・イベント・エンディング） |
| 手続き型音響 | Web Audio APIによる14種の効果音 |
| コード品質 | 純粋関数ベースのロジック、DbCアサーション、テスト有 |

### 弱み（改善すべき課題）

| 課題 | 影響度 | 説明 |
|------|--------|------|
| BGMの不在 | **高** | テキストADVの没入感において音楽は必須。現状は効果音のみで雰囲気が不十分 |
| イベント画像の単調さ | **高** | 163件のイベントに対し画像は4種類（探索・遭遇・罠・安息）のみ。世界が単調に感じる |
| キーボード操作未対応 | **中** | マウスクリック専用。PCユーザーの操作快適性が低い |
| ソーシャル要素の欠如 | **中** | シェア機能なし。プレイ体験の拡散手段がない |
| 新規プレイヤーへの導線不足 | **中** | チュートリアルなし。ゲームシステムの理解に時間がかかる |
| TypeScript型安全性 | **低** | `@ts-nocheck` が複数ファイルに存在 |
| UIコンポーネントテスト | **低** | ゲームロジックのテストはあるがUIテストがない |

---

## ブラッシュアップ戦略

### 設計方針

1. **画像が語るストーリー**: テキストだけに頼らず、画像演出でプレイヤーの想像力を刺激する
2. **音で紡ぐ雰囲気**: フロアごとのBGMと環境音で迷宮の深度を体感させる
3. **一手の重み**: 選択の結果をビジュアル・サウンドの両面でフィードバックし戦略性を高める
4. **もう一周の衝動**: エンディングカードのシェアや実績演出でリプレイ動機を強化する
5. **品質の底上げ**: 型安全性とテストカバレッジで安定した開発基盤を維持する

---

## フェーズ構成

```
フェーズ1 ── ビジュアル演出の革新（画像生成AI活用）
  │
フェーズ2 ── サウンドスケープ強化（BGM・環境音）
  │
フェーズ3 ── ゲームプレイ深化（操作性・戦略性）
  │
フェーズ4 ── エンゲージメント強化（シェア・実績演出）
  │
フェーズ5 ── 品質改善（型安全性・テスト・パフォーマンス）
  │
フェーズ6 ── 統合テスト・ポリッシュ
```

フェーズ1〜3は独立性が高く、並列実施可能。フェーズ4はフェーズ1のビジュアル資産に依存。フェーズ5は他フェーズと並行可能。フェーズ6は全フェーズ完了後。

---

## フェーズ1: ビジュアル演出の革新

### 目的

画像生成AIを活用して、テキストアドベンチャーに視覚的な驚きと深い没入感を与える。「テキストゲームなのにこんな絵が出るのか」という驚嘆を生み出す。

### 1-1. フロア背景のダイナミック化

**現状**: フロア紹介画面で160px高の画像を1枚表示するのみ。
**改善**: フルスクリーン背景画像＋パララックス効果で迷宮の奥行きを演出。

| フロア | 背景テーマ | レイヤー構成 |
|--------|-----------|-------------|
| 第1層 表層回廊 | 薄暗い石造りの回廊、苔むした壁 | 前景（柱の影）・中景（回廊）・遠景（奥の闇） |
| 第2層 灰色の迷路 | 灰色の石壁が延々と続く迷路、微かな光 | 前景（壁の欠片）・中景（分岐路）・遠景（霧） |
| 第3層 深淵の間 | 巨大な地下空間、天井の見えない闇 | 前景（岩の破片）・中景（柱列）・遠景（深淵） |
| 第4層 忘却の底 | 崩れかけた構造物、歪んだ空間 | 前景（瓦礫）・中景（歪んだ柱）・遠景（虚無） |
| 第5層 迷宮の心臓 | 脈打つ壁面、赤い光脈、有機的構造 | 前景（光脈）・中景（心臓壁）・遠景（赤い深淵） |

**実装方式**:
- 各フロア3レイヤーの背景画像を生成（前景・中景・遠景）
- CSSパララックス（`transform: translateY()` をスクロールに連動）
- フロアのテーマカラーに応じた色味フィルター
- 新規画像: 5フロア × 3レイヤー = **15枚**

### 1-2. イベントシーンイラストの追加

**現状**: 4種類の共通画像（探索・遭遇・罠・安息）のみ。
**改善**: 主要イベントに固有のシーンイラストを追加。

**画像追加戦略**:
- 全163イベントに個別画像は非現実的 → 重要イベント・印象的イベントに限定
- フロアの雰囲気を伝えるキービジュアルとして機能させる

| カテゴリ | 枚数 | 対象 |
|---------|------|------|
| ボスイベント | 1 | e030（最終ボス） |
| フロアキーイベント | 5 | 各フロアの代表的イベント |
| チェインイベントクライマックス | 3 | 印象的な連鎖イベントの結末 |
| 特別遭遇 | 3 | クロスランイベント等の特殊場面 |
| 状態異常シーン | 3 | 出血・恐怖・呪いの発生時ビジュアル |

**新規画像: 15枚**

**画像表示方式の改善**:
- 現在の120px高 → 200px高に拡大（フロア画像との統一感）
- 画像のフェードインアニメーション追加
- 画像に対応するイベントがない場合は既存4種を使用（フォールバック）

### 1-3. エンディングCG演出の強化

**現状**: 240px高のエンディング画像。11種すべてに画像あり。
**改善**: エンディング到達時のビジュアル演出を大幅強化。

- エンディング画像をフルスクリーン背景化
- 画像にパーティクルオーバーレイ（光の粒子がゆっくり舞う）
- 段階的な画像表示（ブラー → シャープ → 全体表示）
- エンディングテキストの上にセミトランスペアレントな画像レイヤー

### 1-4. 状態異常ビジュアルオーバーレイ

**現状**: 状態異常はテキストタグとして表示されるのみ。
**改善**: 画面全体に状態異常を視覚的に表現するオーバーレイ画像を追加。

| 状態異常 | ビジュアルオーバーレイ |
|---------|---------------------|
| 負傷 | 画面端にひび割れた傷のオーバーレイ（薄い赤） |
| 混乱 | テキスト表示エリアに歪みエフェクト＋紫のモヤ |
| 出血 | 画面下端から滴り落ちる血のドリップオーバーレイ |
| 恐怖 | 画面四隅から忍び寄る暗闇のオーバーレイ（不規則にパルス） |
| 呪い | 画面に浮かぶ不気味な紋様のオーバーレイ（ゆっくり回転） |

**新規画像: 5枚（各状態異常のオーバーレイテクスチャ）**

### 1-5. タイトル画面のリッチ化

**現状**: 背景画像（opacity 0.3）＋タイトルテキスト＋パーティクル。
**改善**: パララックス多層構成＋アンビエントアニメーション。

- 背景: 3レイヤー構成（遠景の迷宮＋中景の霧＋前景のパーティクル）
- マウス移動に微かに反応するパララックス効果
- 「迷宮の残響」タイトルにグリッチ/歪みエフェクトを追加
- 周回数に応じて背景の雰囲気が変化する演出

**新規画像: 2枚（遠景・中景レイヤー）**

### 1-6. 選択肢ホバー演出

**現状**: 選択肢にホバーすると背景色が変わるのみ。
**改善**: 選択肢にホバーすると背景画像のフィルターが微かに変化。

- 危険な選択肢: 背景がわずかに赤みを帯びる
- 安全な選択肢: 背景がわずかに明るくなる
- 情報値が高い場合: ホバー時にイベント結果の「雰囲気」を色味で暗示

### フェーズ1 画像アセット合計

| カテゴリ | 枚数 |
|---------|------|
| フロア背景（3レイヤー×5フロア） | 15 |
| イベントシーンイラスト | 15 |
| 状態異常オーバーレイ | 5 |
| タイトル画面レイヤー | 2 |
| **合計** | **37** |

### 画像生成仕様（共通）

| 項目 | 値 |
|------|-----|
| 出力サイズ | 960×540 px（Retina対応。表示は480×270） |
| フォーマット | WebP（品質82%、300KB以内） |
| 画風 | 温かみのある物語的写実主義 × 重厚なダンジョンファンタジーアート |
| タッチ | 油絵調の筆致 ＋ 重厚なダンジョンファンタジー |
| 照明 | ドラマチックなキアロスクーロ（明暗対比） |
| 色調 | ダークベース ＋ 各シーンのテーマカラーアクセント |
| 禁則 | テキスト、ウォーターマーク、署名は含めない |
| 配置 | `src/assets/images/` |
| 管理 | `images.ts` に一元登録 |

---

## フェーズ2: サウンドスケープ強化

### 目的

BGMと環境音で迷宮の深度と緊張感を聴覚的に演出し、没入感を大幅に向上させる。

### 2-1. フロア別BGMの追加

**実装方式**: 既存のWeb Audio APIエンジン (`audio.ts`) を拡張し、手続き型BGM生成を実装。外部音声ファイルは使用せず、オシレーター＋フィルターの組み合わせで各フロアの雰囲気を表現する。

| フロア | BGMテーマ | 音響特徴 |
|--------|----------|---------|
| 第1層 | 静かな探索 | ゆったりしたパッド、低い持続音、水滴のようなディレイ |
| 第2層 | 緊張の始まり | パッドのピッチが半音上昇、パルス音の追加 |
| 第3層 | 深淵の重圧 | 低周波ドローン、不協和音パッド、金属的なリバーブ |
| 第4層 | 忘却の静寂 | ほぼ無音に近い持続音、時折の不穏なトーン |
| 第5層 | 心臓の鼓動 | 低い鼓動リズム、歪んだトーン、テンション上昇 |

**技術方式**:
- `OscillatorNode` + `GainNode` + `BiquadFilterNode` のチェイン
- フロア番号に応じてパラメータ（周波数・フィルタカットオフ・LFO速度）を動的変更
- ボリュームはHP/MN状態に応じて微調整（危機時はBGMが歪む演出）
- ユーザーのBGM ON/OFF設定を追加

### 2-2. イベント種別BGMバリエーション

| 種別 | BGM変化 |
|------|---------|
| 探索 | ベースBGMのまま |
| 遭遇 | テンポアップ、高音パルス追加 |
| 罠 | 不穏な低音追加、パッドを不協和化 |
| 安息 | 穏やかなパッド、高音域のシマー |
| ボス | 全要素の強度を最大化、鼓動リズム |

### 2-3. 効果音のバリエーション拡充

| 追加効果音 | 用途 |
|-----------|------|
| `page` | 選択肢テキストの表示完了時 |
| `unlock` | アンロック解放時（KP消費） |
| `titleGlow` | タイトル画面のグロー演出に同期 |
| `endingFanfare` | エンディング到達時（victoryの強化版） |
| `curseApply` | 呪い付与時の不気味な効果音 |
| `secondLife` | セカンドライフ発動時の復活音 |

---

## フェーズ3: ゲームプレイ深化

### 目的

操作性の向上と戦略的深みの追加により、テキストADVとしてのゲーム性を高める。

### 3-1. キーボード操作対応

| キー | 動作 |
|------|------|
| `1` / `2` / `3` | 選択肢1・2・3を選択 |
| `Enter` / `Space` | テキスト送り / 決定 |
| `Escape` | タイトルに戻る（確認ダイアログ付き） |
| `L` | ログの展開/折りたたみ |
| `M` | 音声ON/OFF切り替え |

### 3-2. イベントプレビューヒントの強化

**現状**: INF 15以上で選択肢の条件タイプアイコンを表示。
**改善**:
- INF 20以上: 条件の閾値を数値レンジで表示（例: 「体力が高い場合...」→「HP 30以上で...」）
- INF 30以上: 選択肢の結果カテゴリを表示（回復/ダメージ/情報/フラグ）
- ヒントの表示にフェードインアニメーション追加

### 3-3. 探索ログの充実化

**現状**: イベント名と結果の簡易テキスト。
**改善**:
- ステータス変化の色分け表示（HP緑/赤、MN青/紫、INF黄）
- フロアごとのセパレーター表示
- ログのフィルター機能（全て / ダメージのみ / 回復のみ / フラグのみ）
- ログエクスポート機能（テキストコピー）

### 3-4. 難易度バランスの微調整

- 探索者（Easy）の侵蝕を更に緩和し、初見プレイヤーが第3層まで到達しやすくする
- 安息イベントの出現率を全難易度で微増（「もう少しで回復できたのに」体験の回避）
- ボスイベント(e030)の選択肢ヒントをINF依存で段階的に開示

### 3-5. 初回プレイガイダンス

- 初回プレイ時のみ表示される簡易チュートリアルオーバーレイ
- 最初の選択肢にガイドテキスト「選択肢をクリックして進めましょう」
- ステータスバーの各要素にツールチップ追加（HP/MN/INFの意味説明）
- 2回目以降は非表示（localStorage管理）

---

## フェーズ4: エンゲージメント強化

### 目的

プレイヤーのリプレイ動機とSNSでの拡散力を高め、人気コンテンツとしての成長基盤を構築する。

### 4-1. エンディングカードのSNSシェア

- エンディング到達時に自動生成されるシェアカード
- カード内容: エンディング名 + エンディング画像（縮小） + プレイ統計（階層・HP・MN・INF・状態異常）
- Canvas APIでカード画像を動的生成 → PNG/WebPでダウンロード可能
- シェアボタン: X(Twitter) / コピー（テキスト＋URL）
- カードデザイン: ゲームのダークファンタジー世界観を反映

### 4-2. 実績通知演出

**現状**: 実績は画面遷移後にまとめて表示。
**改善**:
- 実績達成時にトースト通知をゲーム画面上にオーバーレイ表示
- 通知アニメーション: 右下からスライドイン → 3秒後にフェードアウト
- 称号取得時は特別な金色グロー演出

### 4-3. プレイ統計ダッシュボード

- 総プレイ回数・勝率・平均到達階層のグラフ化
- 最もよく選んだ選択肢の傾向分析
- エンディング回収率の円グラフ表示
- アンロック達成率のプログレスバー

### 4-4. デイリーチャレンジ（将来拡張検討）

**注**: この項目はフェーズ4の検討事項として記載。実装はリソース状況に応じて判断。
- 日替わりのシード固定ラン
- 特定条件下でのクリアチャレンジ（例: HP回復なし、INF 0縛り）
- チャレンジ達成で限定称号解放

---

## フェーズ5: 品質改善

### 目的

コードベースの品質を向上させ、継続的な開発・保守の基盤を固める。

### 5-1. TypeScript型安全性の向上

- `@ts-nocheck` の除去と型エラーの修正
- `any` 型の `unknown` + 型ガードへの置換
- イベントデータ(`event-data.ts`)の型整合性チェック追加

### 5-2. コンポーネントテストの追加

- `@testing-library/react` を使用したUIテスト追加
- 優先対象:
  - TitleScreen: ボタンの表示/非表示、統計情報
  - DiffSelectScreen: 難易度カードの表示
  - EventResultScreen: テキスト表示、選択肢
  - EndScreens: エンディング表示、ボタン動作
- テストカバレッジ目標: 新規コード80%以上

### 5-3. パフォーマンス最適化

- 画像のプリロード機構の導入（フロア遷移前に次フロアの画像をロード）
- `useMemo` / `useCallback` の適用漏れ確認
- CSSアニメーションの `will-change` 最適化
- 画像のLazy Loading導入

### 5-4. アクセシビリティ改善

- `aria-label` / `aria-describedby` の適切な設定
- キーボードフォーカスの視覚的インジケーター
- 色覚多様性を考慮したステータスバーの配色確認
- スクリーンリーダーへの最低限の対応

---

## フェーズ6: 統合テスト・ポリッシュ

### 目的

全フェーズの成果物を統合し、品質と整合性を最終確認する。

### 6-1. 全画面遷移の通しテスト

- タイトル → 難易度選択 → フロアイントロ → イベント → 結果 → ... → ゲームオーバー/勝利 の全パス確認
- 各エンディングへの到達テスト
- アンロック・称号画面の動作確認

### 6-2. ブラウザ互換性テスト

- Chrome / Firefox / Safari でのデスクトップ動作確認
- モバイルブラウザでのレイアウト確認
- Web Audio API の互換性確認

### 6-3. パフォーマンス検証

- 画像ロードによる初回表示時間の計測
- BGM + エフェクト同時再生時のオーディオ負荷
- メモリリーク検証（長時間プレイ想定）

### 6-4. 最終ポリッシュ

- アニメーションタイミングの微調整
- テキスト表示速度の最適化
- 画像のフィルター・透明度の微調整
- 全体的なUIの統一感確認

---

## フェーズ依存関係

```
フェーズ1（ビジュアル）──┐
                         │
フェーズ2（サウンド）────┼──→ フェーズ6（統合・ポリッシュ）
                         │
フェーズ3（ゲームプレイ）─┘
         │
         └─→ フェーズ4（エンゲージメント）※フェーズ1のビジュアル資産を使用
              │
フェーズ5（品質改善）──────→ フェーズ6（統合・ポリッシュ）
```

- フェーズ1〜3: 並列実施可能
- フェーズ4: フェーズ1（特にエンディングCG）完了後に開始
- フェーズ5: 他フェーズと並行して随時実施可能
- フェーズ6: 全フェーズ完了後

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 画像アセットのファイルサイズ増大 | 高 | WebP圧縮の最適化、Lazy Loading、プリロードの優先度制御 |
| 手続き型BGMの音質制限 | 中 | Web Audio APIの限界を理解した上でデザイン。不十分なら外部音源ファイルも検討 |
| 画像生成AIの品質ばらつき | 中 | 画像仕様書で詳細なプロンプトを定義。再生成可能な構造で設計 |
| @ts-nocheck除去による既存機能への影響 | 中 | 段階的に除去し、各ステップでテスト実行 |
| パフォーマンス劣化（画像・BGM同時処理） | 中 | 描画・音声の負荷を定期計測。ボトルネック発見時に個別最適化 |
| ソーシャルシェア機能のブラウザ互換性 | 低 | Canvas API → PNG のフォールバック。Web Share API対応ブラウザのみシェアボタン表示 |

---

## 優先度とスケジュール推奨

### 最高優先度（コアインパクト）

1. **フェーズ1-2: イベントシーンイラストの追加** — プレイ体験のビジュアル品質を直接向上
2. **フェーズ2-1: フロア別BGMの追加** — 没入感の劇的改善
3. **フェーズ1-1: フロア背景のダイナミック化** — 世界観の視覚的強化

### 高優先度（UX改善）

4. **フェーズ3-1: キーボード操作対応** — PC操作性の改善
5. **フェーズ1-4: 状態異常ビジュアルオーバーレイ** — 画像を使った驚きのある演出
6. **フェーズ3-5: 初回プレイガイダンス** — 新規プレイヤーの離脱防止

### 中優先度（成長基盤）

7. **フェーズ4-1: エンディングカードのSNSシェア** — 人気コンテンツへの成長に必須
8. **フェーズ1-3: エンディングCG演出の強化** — リプレイ動機の強化
9. **フェーズ5-1: TypeScript型安全性の向上** — 開発品質の底上げ

### 低優先度（将来拡張）

10. **フェーズ4-3: プレイ統計ダッシュボード** — データ好きなプレイヤー向け
11. **フェーズ4-4: デイリーチャレンジ** — 長期運営向け機能
